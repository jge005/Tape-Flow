<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Tape Flow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg: #e9f2ff;
      --bg-soft:#f5f7ff;
      --card:#ffffff;
      --text:#1c2440;
      --text-sub:#5f6b8c;
      --accent:#4f63ff;
      --accent-soft:#7ea6ff;
      --danger:#ff5f7a;
      --border:#d6def3;
    }
    body.theme-dark{
      --bg:#050817;
      --bg-soft:#0b1024;
      --card:#121933;
      --text:#e4e9ff;
      --text-sub:#a4b1ff;
      --accent:#7ea6ff;
      --accent-soft:#4f63ff;
      --danger:#ff748b;
      --border:#303b68;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;
      background:radial-gradient(circle at top,#c2dbff 0,#e9f2ff 40%,#fdfbff 100%);
      color:var(--text);
    }
    body.theme-dark{
      background:radial-gradient(circle at top,#141b3f 0,#050817 60%,#020311 100%);
    }
    .app{
      max-width:900px;
      margin:0 auto;
      padding:20px 16px 40px;
    }

    header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }
    header .logo-box{
      width:42px;
      height:42px;
      border-radius:15px;
      background:linear-gradient(135deg,#ffb86c,#ff7eb3);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 10px 25px rgba(0,0,0,0.12);
    }
    header .logo-box span{
      font-size:24px;
    }
    header h1{
      margin:0;
      font-size:26px;
      letter-spacing:0.04em;
    }
    header p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--text-sub);
    }

    /* ë„¤ë¹„ê²Œì´ì…˜ íƒ­ */
    .nav{
      display:flex;
      gap:8px;
      padding:4px 0 18px;
      overflow-x:auto;
    }
    .nav::-webkit-scrollbar{display:none;}
    .nav button{
      flex:0 0 auto;
      padding:8px 16px;
      border:none;
      border-radius:999px;
      background:rgba(255,255,255,0.7);
      color:#44506b;
      font-size:13px;
      font-weight:600;
      box-shadow:0 4px 12px rgba(77,105,255,0.08);
      white-space:nowrap;
      text-align:center;
    }
    body.theme-dark .nav button{
      background:rgba(19,29,64,0.9);
      color:#cdd5ff;
      box-shadow:0 4px 14px rgba(0,0,0,0.35);
    }
    .nav button.active{
      background:linear-gradient(135deg,#7ea6ff,#4f63ff);
      color:#fff;
    }

    .card{
      background:var(--card);
      border-radius:20px;
      padding:18px 16px 20px;
      box-shadow:0 10px 28px rgba(25,58,140,0.10);
      margin-bottom:14px;
      border:1px solid rgba(255,255,255,0.4);
    }
    body.theme-dark .card{
      box-shadow:0 18px 40px rgba(0,0,0,0.55);
      border:1px solid rgba(82,96,168,0.45);
    }

    h2{
      margin:0 0 10px;
      font-size:18px;
    }
    .sub{
      font-size:12px;
      color:var(--text-sub);
      margin-bottom:12px;
    }

    .field{
      margin-bottom:10px;
    }
    .field label{
      display:block;
      font-size:13px;
      margin-bottom:4px;
    }
    input, select{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid var(--border);
      font-size:14px;
      outline:none;
      background:rgba(255,255,255,0.9);
    }
    body.theme-dark input,
    body.theme-dark select{
      background:#111731;
      border-color:#35406d;
      color:var(--text);
    }
    input::placeholder{
      color:#a8b0d0;
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:9px 18px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      background:linear-gradient(135deg,#7ea6ff,#4f63ff);
      color:#fff;
      box-shadow:0 10px 24px rgba(30,74,196,0.35);
    }
    .btn-secondary{
      background:rgba(255,255,255,0.9);
      color:var(--text);
      box-shadow:0 6px 18px rgba(41,54,104,0.15);
    }
    .btn-danger{
      background:var(--danger);
      box-shadow:0 8px 20px rgba(255,95,122,0.45);
    }
    .btn-sm{padding:6px 11px;font-size:12px;}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:8px;
    }
    th,td{
      padding:6px 6px;
      border-bottom:1px solid rgba(214,222,243,0.7);
      text-align:left;
      white-space:nowrap;
    }
    th{
      font-size:11px;
      color:var(--text-sub);
    }
    tbody tr:last-child td{border-bottom:none;}

    .tag{
      display:inline-block;
      padding:2px 7px;
      border-radius:999px;
      background:rgba(127,173,255,0.15);
      color:var(--accent);
      font-size:11px;
      margin-left:4px;
    }

    .tab-pane{display:none;}
    .tab-pane.active{display:block;}

    .flex-between{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .flex-row{
      display:flex;
      gap:8px;
    }
    .flex-row > .field{flex:1;}
    @media(max-width:600px){
      .flex-row{flex-direction:column;}
    }

    .suggestions{
      margin-top:4px;
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }
    .suggestions button{
      border:none;
      border-radius:999px;
      padding:4px 9px;
      font-size:11px;
      background:rgba(255,255,255,0.9);
      color:var(--text-sub);
      box-shadow:0 4px 10px rgba(0,0,0,0.08);
    }

    .pill-input{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(255,255,255,0.85);
      color:var(--text-sub);
      margin-top:6px;
    }

    .note{
      font-size:11px;
      color:var(--text-sub);
      margin-top:4px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:11px;
      padding:3px 7px;
      border-radius:999px;
      background:rgba(0,0,0,0.04);
      color:var(--text-sub);
    }

    /* ì ê¸ˆ í™”ë©´ */
    #lock-screen{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at top,#c2dbff 0,#e9f2ff 40%,#fdfbff 100%);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:20;
    }
    body.theme-dark #lock-screen{
      background:radial-gradient(circle at top,#141b3f 0,#050817 60%,#020311 100%);
    }
    #lock-screen .panel{
      width:90%;
      max-width:360px;
      background:var(--card);
      border-radius:20px;
      padding:18px 16px 20px;
      box-shadow:0 18px 40px rgba(0,0,0,0.55);
      border:1px solid rgba(255,255,255,0.3);
      text-align:center;
    }
    #lock-screen h2{margin-bottom:6px;}
    #lock-screen p{margin-top:0;font-size:12px;color:var(--text-sub);}
    #lock-error{color:var(--danger);font-size:11px;min-height:14px;margin-top:4px;}

  </style>
</head>
<body>
<div id="lock-screen">
  <div class="panel">
    <h2>Tape Flow</h2>
    <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
    <div class="field">
      <input type="password" id="lock-password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
    </div>
    <button class="btn" id="lock-confirm">í™•ì¸</button>
    <div id="lock-error"></div>
  </div>
</div>

<div class="app">
  <header>
    <div class="logo-box"><span>ğŸ“¦</span></div>
    <div>
      <h1>TAPE FLOW</h1>
      <p>í…Œì´í”„Â·ì œí’ˆ ì¬ê³  & ì‘ì—… ê¸°ë¡ ê´€ë¦¬</p>
    </div>
  </header>

  <nav class="nav">
    <button class="active" data-tab="products">ì œí’ˆ ì¬ê³ </button>
    <button data-tab="jobs">ì‘ì—… ë“±ë¡</button>
    <button data-tab="tape-stock">í…Œì´í”„ ì¬ê³ </button>
    <button data-tab="tape-settings">í…Œì´í”„ ì„¤ì •</button>
    <button data-tab="settings">ì„¤ì •</button>
  </nav>

  <!-- ì œí’ˆ ì¬ê³  íƒ­ -->
  <section class="tab-pane active" id="tab-products">
    <div class="card">
      <h2>ì œí’ˆ ì¬ê³  ë“±ë¡</h2>
      <div class="sub">ì‘ì—… ì „ ê°€ì§€ê³  ìˆëŠ” ì œí’ˆ ì„¸íŠ¸ë“¤ì„ ë“±ë¡í•´ ë‘ëŠ” ê³³ì´ì•¼.</div>

      <div class="field">
        <label>ì œí’ˆëª…</label>
        <input id="prod-name" placeholder="ì˜ˆ: 7125J" />
      </div>
      <div class="field">
        <label>ìˆ˜ëŸ‰(EA)</label>
        <input id="prod-qty" type="number" inputmode="numeric" placeholder="ì˜ˆ: 2520" />
      </div>
      <div class="field">
        <label>ë°œì‹  LOT</label>
        <input id="prod-lot" placeholder="ì˜ˆ: LOT123" />
      </div>
      <div class="field">
        <label>ì¸ì‡„ì</label>
        <input id="prod-printer" placeholder="ì˜ˆ: ê¹€ì£¼í˜„" />
      </div>
      <button class="btn" id="btn-add-prod">ì¬ê³  ì¶”ê°€</button>

      <div class="flex-between" style="margin-top:14px;">
        <span class="sub" id="prod-count-label">ë“±ë¡ëœ ì¬ê³  0ì„¸íŠ¸</span>
        <button class="btn btn-secondary btn-sm" id="btn-prod-csv">ì œí’ˆ ì¬ê³  CSV ë‹¤ìš´ë¡œë“œ</button>
      </div>

      <div id="prod-list-wrap" style="margin-top:8px;overflow-x:auto;">
        <table id="prod-table">
          <thead>
          <tr>
            <th>ë‚ ì§œ</th>
            <th>ì œí’ˆëª…</th>
            <th>EA</th>
            <th>ë°œì‹  LOT</th>
            <th>ì¸ì‡„ì</th>
            <th>ì‚­ì œ</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ì‘ì—… ë“±ë¡ íƒ­ -->
  <section class="tab-pane" id="tab-jobs">
    <div class="card">
      <h2>ì‘ì—… ë“±ë¡</h2>
      <div class="sub">ì–´ë–¤ ì œí’ˆ ì„¸íŠ¸ë¥¼ ëª‡ EA ì‘ì—…í–ˆê³ , í…Œì´í”„ëŠ” ì–¼ë§ˆë‚˜ ì¼ëŠ”ì§€ ê¸°ë¡í•´.</div>

      <div class="field">
        <label>ì œí’ˆ ê²€ìƒ‰ (ì œí’ˆëª… ë˜ëŠ” LOT)</label>
        <input id="job-search" placeholder="ì˜ˆ: 7125J ë˜ëŠ” LOT123" />
        <div class="suggestions" id="job-suggestions"></div>
        <div class="pill-input">
          ì„ íƒëœ ì œí’ˆ :
          <span id="job-selected-summary">ì—†ìŒ</span>
        </div>
      </div>

      <div class="flex-row">
        <div class="field">
          <label>ì´ë²ˆ ì‘ì—… ìˆ˜ëŸ‰(EA)</label>
          <input id="job-ea" type="number" inputmode="numeric" placeholder="ì˜ˆ: 2520" />
          <div class="note">ë¹„ì›Œë‘ë©´ ì„¸íŠ¸ ì „ì²´ EAë¡œ ìë™ ì…ë ¥.</div>
        </div>
        <div class="field">
          <label>ì‚¬ìš© í…Œì´í”„</label>
          <select id="job-tape-select">
            <option value="">í…Œì´í”„ ì„ íƒ</option>
          </select>
          <div class="note" id="job-tape-info">í…Œì´í”„ë¥¼ ì„ íƒí•˜ë©´ EA/ì¥ ì •ë³´ê°€ ë³´ì—¬.</div>
        </div>
      </div>

      <div class="flex-row">
        <div class="field">
          <label>ì‚¬ìš© ì¥ìˆ˜</label>
          <input id="job-sheets" type="number" inputmode="numeric" placeholder="ì˜ˆ: 10" />
          <div class="note">ë¹„ì›Œë‘ë©´ EAì™€ í…Œì´í”„ ì„¤ì •ì„ ê¸°ì¤€ìœ¼ë¡œ ìë™ ê³„ì‚°.</div>
        </div>
        <div class="field">
          <label>ë¶ˆëŸ‰ ì¥ìˆ˜</label>
          <input id="job-waste" type="number" inputmode="numeric" placeholder="ì˜ˆ: 1" />
        </div>
      </div>

      <button class="btn" id="btn-add-job">ì‘ì—… ì¶”ê°€</button>

      <div class="flex-between" style="margin-top:14px;">
        <span class="sub" id="job-count-label">ì˜¤ëŠ˜ ì‘ì—… 0ê±´</span>
        <span class="badge">
          â„¹ï¸ ì‘ì—… ë“±ë¡ ì‹œ
          <span style="font-weight:600;">ì œí’ˆ ì¬ê³  EAê°€ ì¤„ê³ , í…Œì´í”„ ì¬ê³ (ì¥ìˆ˜)ë„ ìë™ ì°¨ê°</span>
        </span>
      </div>

      <div style="margin-top:8px;overflow-x:auto;">
        <table id="job-table">
          <thead>
          <tr>
            <th>ë‚ ì§œ</th>
            <th>ì œí’ˆ</th>
            <th>EA</th>
            <th>LOT</th>
            <th>í…Œì´í”„</th>
            <th>ì‚¬ìš©ì¥ìˆ˜</th>
            <th>ë¶ˆëŸ‰</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- í…Œì´í”„ ì¬ê³  íƒ­ -->
  <section class="tab-pane" id="tab-tape-stock">
    <div class="card">
      <h2>í…Œì´í”„ ì¬ê³ </h2>
      <div class="sub">ê°€ê³µì‹¤/íƒœì„±ì—ì„œ ì˜¬ë¼ì˜¨ í…Œì´í”„ ì¥ìˆ˜ì™€ ì‚¬ìš©ëŸ‰ì„ ê¸°ì¤€ìœ¼ë¡œ í˜„ì¬ ì”ëŸ‰ì„ ê´€ë¦¬í•´.</div>

      <h3 style="font-size:15px;margin:4px 0 8px;">í…Œì´í”„ ì…ê³  ë“±ë¡</h3>
      <div class="flex-row">
        <div class="field">
          <label>í…Œì´í”„</label>
          <select id="stock-tape-select">
            <option value="">í…Œì´í”„ ì„ íƒ</option>
          </select>
        </div>
        <div class="field">
          <label>ì…ê³  ì¥ìˆ˜</label>
          <input id="stock-in-qty" type="number" inputmode="numeric" placeholder="ì˜ˆ: 120" />
        </div>
      </div>
      <button class="btn btn-sm" id="btn-stock-in">ì…ê³  ì¶”ê°€</button>
      <div class="note">ì…ê³  ì¥ìˆ˜ - (ì‘ì—… ì‚¬ìš© + ë¶ˆëŸ‰) = í˜„ì¬ ì”ëŸ‰(ì¥ìˆ˜). í•„ìš”í•˜ë©´ ì•„ë˜ í‘œì—ì„œ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆì–´.</div>

      <div class="flex-between" style="margin-top:16px;">
        <h3 style="font-size:15px;margin:0;">í…Œì´í”„ë³„ í˜„ì¬ ì”ëŸ‰</h3>
        <button class="btn btn-secondary btn-sm" id="btn-tape-csv">í…Œì´í”„ ì¬ê³  CSV ë‹¤ìš´ë¡œë“œ</button>
      </div>

      <div style="margin-top:8px;overflow-x:auto;">
        <table id="tape-stock-table">
          <thead>
          <tr>
            <th>í…Œì´í”„</th>
            <th>EA/ì¥</th>
            <th>ì¶œì²˜</th>
            <th>í˜„ì¬ê³ (ì¥)</th>
            <th>ì˜ˆìƒ EA</th>
            <th>ìˆ˜ì •</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="note">í˜„ì¬ê³ (ì¥)ì„ ìˆ˜ì •í•˜ë©´ ìë™ìœ¼ë¡œ ì €ì¥ë¼.</div>
    </div>
  </section>

  <!-- í…Œì´í”„ ì„¤ì • íƒ­ -->
  <section class="tab-pane" id="tab-tape-settings">
    <div class="card">
      <h2>í…Œì´í”„ ê¸°ë³¸ ì •ë³´</h2>
      <div class="sub">í…Œì´í”„ ì¢…ë¥˜, í•œ ì¥ë‹¹ ë¶™ëŠ” ì œí’ˆ EA ìˆ˜, ì¶œì²˜(ê°€ê³µì‹¤/íƒœì„±)ë¥¼ ì„¤ì •í•´.</div>

      <div class="field">
        <label>í…Œì´í”„ëª…</label>
        <input id="tape-name" placeholder="ì˜ˆ: 6855, 6491" />
      </div>
      <div class="field">
        <label>EA(ì œí’ˆ ìˆ˜ëŸ‰) / 1ì¥ë‹¹</label>
        <input id="tape-ea-per-sheet" type="number" inputmode="numeric" placeholder="ì˜ˆ: 6" />
      </div>
      <div class="field">
        <label>ì¶œì²˜</label>
        <select id="tape-source">
          <option value="ê°€ê³µì‹¤">ê°€ê³µì‹¤</option>
          <option value="íƒœì„±">íƒœì„±</option>
          <option value="ê¸°íƒ€">ê¸°íƒ€</option>
        </select>
      </div>

      <button class="btn" id="btn-add-tape">í…Œì´í”„ ì¶”ê°€</button>

      <div style="margin-top:14px;overflow-x:auto;">
        <table id="tape-table">
          <thead>
          <tr>
            <th>í…Œì´í”„</th>
            <th>EA/ì¥</th>
            <th>ì¶œì²˜</th>
            <th>ì‚­ì œ</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ì„¤ì • íƒ­ -->
  <section class="tab-pane" id="tab-settings">
    <div class="card">
      <h2>ì„¤ì •</h2>

      <h3 style="font-size:15px;margin:4px 0 8px;">í…Œë§ˆ</h3>
      <div class="flex-row" style="margin-bottom:12px;">
        <button class="btn btn-sm" id="btn-theme-light">ë¼ì´íŠ¸ (í•˜ëŠ˜ íŒŒë‘)</button>
        <button class="btn btn-sm btn-secondary" id="btn-theme-dark">ë‹¤í¬ (ë‚¨ìƒ‰)</button>
      </div>
      <div class="note">ì·¨í–¥ì— ë§ê²Œ í…Œë§ˆë¥¼ ë°”ê¿€ ìˆ˜ ìˆì–´. ì„ íƒí•œ í…Œë§ˆëŠ” ìë™ìœ¼ë¡œ ì €ì¥ë¼.</div>

      <hr style="border:none;border-top:1px dashed var(--border);margin:18px 0;">

      <h3 style="font-size:15px;margin:4px 0 8px;">ë¹„ë°€ë²ˆí˜¸ ì„¤ì • / ë³€ê²½</h3>
      <div class="sub" id="pw-status-text">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.</div>

      <div class="field">
        <label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="pw-current" placeholder="ì²˜ìŒ ì„¤ì • ì‹œ ë¹„ì›Œë„ ë¨" />
      </div>
      <div class="field">
        <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="pw-new" placeholder="4~12ì ì¶”ì²œ" />
      </div>
      <button class="btn btn-sm" id="btn-change-pw">ë¹„ë°€ë²ˆí˜¸ ì„¤ì • / ë³€ê²½</button>
      <div class="note">ì•±ì„ ë‹¤ì‹œ ì—´ ë•Œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¬¼ì–´ë³¼ ìˆ˜ ìˆì–´. (ë¹„ë°€ë²ˆí˜¸ëŠ” ì´ ê¸°ê¸° ë¡œì»¬ì—ë§Œ ì €ì¥)</div>
    </div>
  </section>
</div>

<script>
  const STORAGE_KEYS = {
    products: 'tf_products',
    tapes: 'tf_tapes',
    jobs: 'tf_jobs',
    theme: 'tf_theme',
    password: 'tf_password'
  };

  let products = [];
  let tapes = [];
  let jobs = [];

  function loadData(){
    products = JSON.parse(localStorage.getItem(STORAGE_KEYS.products) || '[]');
    tapes = JSON.parse(localStorage.getItem(STORAGE_KEYS.tapes) || '[]');
    jobs = JSON.parse(localStorage.getItem(STORAGE_KEYS.jobs) || '[]');
    const theme = localStorage.getItem(STORAGE_KEYS.theme) || 'light';
    applyTheme(theme,false);
  }

  function saveProducts(){localStorage.setItem(STORAGE_KEYS.products, JSON.stringify(products));}
  function saveTapes(){localStorage.setItem(STORAGE_KEYS.tapes, JSON.stringify(tapes));}
  function saveJobs(){localStorage.setItem(STORAGE_KEYS.jobs, JSON.stringify(jobs));}

  function formatDate(d){
    const dt = (d instanceof Date)? d : new Date(d);
    const y = dt.getFullYear();
    const m = String(dt.getMonth()+1).padStart(2,'0');
    const day = String(dt.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  /* ---------- ë Œë”ë§ ---------- */

  function renderProducts(){
    const tbody = document.querySelector('#prod-table tbody');
    tbody.innerHTML = '';
    products.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatDate(p.date)}</td>
        <td>${p.name}</td>
        <td>${p.qty}</td>
        <td>${p.lot || ''}</td>
        <td>${p.printer || ''}</td>
        <td><button class="btn btn-sm btn-danger" data-del-prod="${p.id}">ì‚­ì œ</button></td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById('prod-count-label').textContent =
      `ë“±ë¡ëœ ì¬ê³  ${products.length}ì„¸íŠ¸`;
  }

  function renderTapes(){
    const tbody = document.querySelector('#tape-table tbody');
    const sel1 = document.getElementById('job-tape-select');
    const sel2 = document.getElementById('stock-tape-select');
    tbody.innerHTML = '';
    sel1.innerHTML = '<option value="">í…Œì´í”„ ì„ íƒ</option>';
    sel2.innerHTML = '<option value="">í…Œì´í”„ ì„ íƒ</option>';

    tapes.forEach(t=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${t.name}</td>
        <td>${t.eaPerSheet || ''}</td>
        <td>${t.source || ''}</td>
        <td><button class="btn btn-sm btn-danger" data-del-tape="${t.id}">ì‚­ì œ</button></td>
      `;
      tbody.appendChild(tr);

      const opt1 = document.createElement('option');
      opt1.value = t.id; opt1.textContent = t.name;
      sel1.appendChild(opt1);

      const opt2 = document.createElement('option');
      opt2.value = t.id; opt2.textContent = t.name;
      sel2.appendChild(opt2);
    });

    renderTapeStock();
  }

  function renderTapeStock(){
    const tbody = document.querySelector('#tape-stock-table tbody');
    tbody.innerHTML = '';
    tapes.forEach(t=>{
      const stock = Number(t.stockSheets || 0);
      const eaPerSheet = Number(t.eaPerSheet || 0);
      const possibleEA = eaPerSheet ? stock * eaPerSheet : 0;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${t.name}</td>
        <td>${eaPerSheet || ''}</td>
        <td>${t.source || ''}</td>
        <td>
          <input data-stock-input="${t.id}" type="number" value="${stock}" style="width:80px;padding:4px 6px;border-radius:8px;border:1px solid var(--border);font-size:11px;">
        </td>
        <td>${possibleEA || ''}</td>
        <td><button class="btn btn-sm" data-stock-save="${t.id}">ì €ì¥</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderJobs(){
    const tbody = document.querySelector('#job-table tbody');
    tbody.innerHTML = '';
    jobs.forEach(j=>{
      const tape = tapes.find(t=>t.id===j.tapeId);
      const prodLabel = `${j.productName}`;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatDate(j.date)}</td>
        <td>${prodLabel}</td>
        <td>${j.ea}</td>
        <td>${j.lot || ''}</td>
        <td>${tape ? tape.name : ''}</td>
        <td>${j.sheets}</td>
        <td>${j.wasteSheets || 0}</td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById('job-count-label').textContent =
      `ì´ ì‘ì—… ${jobs.length}ê±´`;
  }

  function renderPwStatus(){
    const pw = localStorage.getItem(STORAGE_KEYS.password);
    const text = pw ? 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.' : 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.';
    document.getElementById('pw-status-text').textContent = text;
  }

  /* ---------- íƒ­ ì „í™˜ ---------- */
  document.querySelectorAll('.nav button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset.tab;
      document.querySelectorAll('.tab-pane').forEach(p=>{
        p.classList.toggle('active', p.id === 'tab-'+target);
      });
    });
  });

  /* ---------- ì œí’ˆ ì¬ê³  ë“±ë¡ ---------- */
  document.getElementById('btn-add-prod').addEventListener('click', ()=>{
    const name = document.getElementById('prod-name').value.trim();
    const qty = Number(document.getElementById('prod-qty').value);
    const lot = document.getElementById('prod-lot').value.trim();
    const printer = document.getElementById('prod-printer').value.trim();
    if(!name || !qty){
      alert('ì œí’ˆëª…ê³¼ ìˆ˜ëŸ‰(EA)ì€ í•„ìˆ˜ì•¼.');
      return;
    }
    const p = {
      id: 'p_'+Date.now()+Math.random().toString(16).slice(2),
      date: new Date().toISOString(),
      name, qty, lot, printer
    };
    products.push(p);
    saveProducts();
    renderProducts();
    document.getElementById('prod-name').value='';
    document.getElementById('prod-qty').value='';
    document.getElementById('prod-lot').value='';
    document.getElementById('prod-printer').value='';
  });

  document.querySelector('#prod-table tbody').addEventListener('click', e=>{
    const id = e.target.dataset.delProd;
    if(!id) return;
    if(!confirm('ì´ ì œí’ˆ ì¬ê³  ì„¸íŠ¸ë¥¼ ì‚­ì œí• ê¹Œ?')) return;
    products = products.filter(p=>p.id!==id);
    saveProducts();
    renderProducts();
  });

  /* ---------- ì œí’ˆ ì¬ê³  CSV ---------- */
  document.getElementById('btn-prod-csv').addEventListener('click', ()=>{
    if(!products.length){
      alert('ë‹¤ìš´ë¡œë“œí•  ì œí’ˆ ì¬ê³ ê°€ ì—†ì–´.');
      return;
    }
    const header = ['ë‚ ì§œ','ì œí’ˆëª…','EA','ë°œì‹ LOT','ì¸ì‡„ì'];
    const rows = products.map(p=>[
      formatDate(p.date), p.name, p.qty, p.lot||'', p.printer||''
    ]);
    const csv = [header,...rows].map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    downloadCSV(csv, 'ì œí’ˆì¬ê³ .csv');
  });

  function downloadCSV(csv, filename){
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  /* ---------- ìë™ ì™„ì„± (ì‘ì—… ë“±ë¡) ---------- */
  let selectedProductId = null;
  function updateSuggestions(){
    const q = document.getElementById('job-search').value.trim().toLowerCase();
    const box = document.getElementById('job-suggestions');
    box.innerHTML = '';
    if(!q){
      selectedProductId = null;
      document.getElementById('job-selected-summary').textContent='ì—†ìŒ';
      return;
    }
    const matched = products.filter(p=>{
      return p.name.toLowerCase().includes(q) ||
             (p.lot && p.lot.toLowerCase().includes(q));
    }).slice(0,10);
    matched.forEach(p=>{
      const btn = document.createElement('button');
      btn.type='button';
      btn.textContent = `${p.name} / ${p.lot || '-'} / ${p.qty}EA`;
      btn.addEventListener('click', ()=>{
        selectedProductId = p.id;
        document.getElementById('job-selected-summary').textContent =
          `${p.name} / ${p.lot || '-'} / ë‚¨ì€ ${p.qty}EA`;
        document.getElementById('job-ea').value = p.qty;
      });
      box.appendChild(btn);
    });
  }
  document.getElementById('job-search').addEventListener('input', updateSuggestions);

  document.getElementById('job-tape-select').addEventListener('change', e=>{
    const id = e.target.value;
    const info = document.getElementById('job-tape-info');
    if(!id){
      info.textContent = 'í…Œì´í”„ë¥¼ ì„ íƒí•˜ë©´ EA/ì¥ ì •ë³´ê°€ ë³´ì—¬.';
      return;
    }
    const tape = tapes.find(t=>t.id===id);
    if(tape){
      info.textContent = `1ì¥ë‹¹ ${tape.eaPerSheet || 0}EA (ì¶œì²˜: ${tape.source || '-'})`;
    }
  });

  /* ---------- ì‘ì—… ë“±ë¡ ì²˜ë¦¬ ---------- */
  document.getElementById('btn-add-job').addEventListener('click', ()=>{
    if(!selectedProductId){
      alert('ë¨¼ì € ì œí’ˆì„ ê²€ìƒ‰í•´ì„œ ì„ íƒí•´ ì¤˜.');
      return;
    }
    const product = products.find(p=>p.id===selectedProductId);
    if(!product){
      alert('ì„ íƒëœ ì œí’ˆ ì¬ê³ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”.');
      return;
    }
    const tapeId = document.getElementById('job-tape-select').value;
    if(!tapeId){
      alert('ì‚¬ìš©í•œ í…Œì´í”„ë¥¼ ì„ íƒí•´ ì¤˜.');
      return;
    }
    const tape = tapes.find(t=>t.id===tapeId);
    const eaInput = Number(document.getElementById('job-ea').value) || product.qty;
    const sheetInput = Number(document.getElementById('job-sheets').value);
    const waste = Number(document.getElementById('job-waste').value) || 0;
    const eaPerSheet = Number(tape.eaPerSheet || 0);

    if(eaInput<=0){
      alert('ì‘ì—… ìˆ˜ëŸ‰(EA)ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ ì¤˜.');
      return;
    }
    let sheets;
    if(sheetInput>0){
      sheets = sheetInput;
    }else{
      if(!eaPerSheet){
        alert('ì´ í…Œì´í”„ì˜ EA/ì¥ ì„¤ì •ì´ ì—†ì–´ì„œ ì¥ìˆ˜ë¥¼ ê³„ì‚°í•  ìˆ˜ ì—†ì–´. í…Œì´í”„ ì„¤ì • íƒ­ì—ì„œ EA/ì¥ì„ ë¨¼ì € ë„£ì–´ì¤˜.');
        return;
      }
      sheets = Math.ceil(eaInput / eaPerSheet);
    }

    // ì œí’ˆ ì¬ê³  ì°¨ê°
    if(eaInput > product.qty){
      if(!confirm(`í˜„ì¬ ì¬ê³ ëŠ” ${product.qty}EA ì¸ë° ${eaInput}EA ì‘ì—…ìœ¼ë¡œ ë“±ë¡í• ê¹Œ?`)){
        return;
      }
    }
    product.qty = Math.max(0, product.qty - eaInput);
    if(product.qty === 0){
      products = products.filter(p=>p.id!==product.id);
      selectedProductId = null;
      document.getElementById('job-selected-summary').textContent='ì—†ìŒ';
      document.getElementById('job-search').value='';
      document.getElementById('job-ea').value='';
    }
    saveProducts();
    renderProducts();

    // í…Œì´í”„ ì¬ê³  ì°¨ê°
    const totalSheets = sheets + waste;
    tape.stockSheets = Number(tape.stockSheets || 0) - totalSheets;
    if(isNaN(tape.stockSheets)) tape.stockSheets = 0;
    saveTapes();
    renderTapeStock();

    // ì‘ì—… ê¸°ë¡ ì €ì¥
    const job = {
      id: 'j_'+Date.now()+Math.random().toString(16).slice(2),
      date: new Date().toISOString(),
      productName: product.name,
      lot: product.lot,
      ea: eaInput,
      tapeId,
      sheets,
      wasteSheets: waste
    };
    jobs.push(job);
    saveJobs();
    renderJobs();

    document.getElementById('job-sheets').value='';
    document.getElementById('job-waste').value='';
    alert('ì‘ì—…ì´ ë“±ë¡ëì–´!');
  });

  /* ---------- í…Œì´í”„ ì…ê³  ---------- */
  document.getElementById('btn-stock-in').addEventListener('click', ()=>{
    const id = document.getElementById('stock-tape-select').value;
    const qty = Number(document.getElementById('stock-in-qty').value);
    if(!id || !qty){
      alert('í…Œì´í”„ì™€ ì…ê³  ì¥ìˆ˜ë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì¤˜.');
      return;
    }
    const tape = tapes.find(t=>t.id===id);
    tape.stockSheets = Number(tape.stockSheets || 0) + qty;
    saveTapes();
    renderTapeStock();
    document.getElementById('stock-in-qty').value='';
  });

  // ì¬ê³  ìˆ˜ë™ ìˆ˜ì •
  document.querySelector('#tape-stock-table tbody').addEventListener('click', e=>{
    const id = e.target.dataset.stockSave;
    if(!id) return;
    const input = document.querySelector(`input[data-stock-input="${id}"]`);
    const value = Number(input.value);
    if(isNaN(value)){
      alert('ìˆ«ìë¡œ ì…ë ¥í•´ ì¤˜.');
      return;
    }
    const tape = tapes.find(t=>t.id===id);
    tape.stockSheets = value;
    saveTapes();
    renderTapeStock();
  });

  /* ---------- í…Œì´í”„ ì¬ê³  CSV ---------- */
  document.getElementById('btn-tape-csv').addEventListener('click', ()=>{
    if(!tapes.length){
      alert('í…Œì´í”„ ì„¤ì •ì´ í•˜ë‚˜ë„ ì—†ì–´.');
      return;
    }
    const header = ['í…Œì´í”„','EA/ì¥','ì¶œì²˜','í˜„ì¬ê³ (ì¥)','ì˜ˆìƒEA'];
    const rows = tapes.map(t=>{
      const stock = Number(t.stockSheets || 0);
      const eaPer = Number(t.eaPerSheet || 0);
      return [t.name, eaPer || '', t.source || '', stock || 0, eaPer? stock*eaPer : ''];
    });
    const csv = [header,...rows].map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    downloadCSV(csv, 'í…Œì´í”„ì¬ê³ .csv');
  });

  /* ---------- í…Œì´í”„ ì„¤ì • ---------- */
  document.getElementById('btn-add-tape').addEventListener('click', ()=>{
    const name = document.getElementById('tape-name').value.trim();
    const eaPerSheet = Number(document.getElementById('tape-ea-per-sheet').value);
    const source = document.getElementById('tape-source').value;
    if(!name){
      alert('í…Œì´í”„ëª…ì„ ì…ë ¥í•´ ì¤˜.');
      return;
    }
    if(!eaPerSheet){
      alert('EA/ì¥ì„ ìˆ«ìë¡œ ì…ë ¥í•´ ì¤˜.');
      return;
    }
    const t = {
      id: 't_'+Date.now()+Math.random().toString(16).slice(2),
      name, eaPerSheet, source,
      stockSheets: 0
    };
    tapes.push(t);
    saveTapes();
    renderTapes();
    document.getElementById('tape-name').value='';
    document.getElementById('tape-ea-per-sheet').value='';
  });

  document.querySelector('#tape-table tbody').addEventListener('click', e=>{
    const id = e.target.dataset.delTape;
    if(!id) return;
    if(!confirm('ì´ í…Œì´í”„ ì„¤ì •ì„ ì‚­ì œí• ê¹Œ? (ì¬ê³  ì •ë³´ë„ í•¨ê»˜ ì‚¬ë¼ì ¸)')) return;
    tapes = tapes.filter(t=>t.id!==id);
    saveTapes();
    renderTapes();
  });

  /* ---------- í…Œë§ˆ ---------- */
  function applyTheme(theme,save=true){
    if(theme==='dark'){
      document.body.classList.add('theme-dark');
    }else{
      document.body.classList.remove('theme-dark');
    }
    if(save) localStorage.setItem(STORAGE_KEYS.theme,theme);
  }
  document.getElementById('btn-theme-light').addEventListener('click', ()=>applyTheme('light'));
  document.getElementById('btn-theme-dark').addEventListener('click', ()=>applyTheme('dark'));

  /* ---------- ë¹„ë°€ë²ˆí˜¸ ---------- */
  document.getElementById('btn-change-pw').addEventListener('click', ()=>{
    const current = document.getElementById('pw-current').value;
    const next = document.getElementById('pw-new').value;
    const stored = localStorage.getItem(STORAGE_KEYS.password);
    if(stored){
      if(stored !== current){
        alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•Šì•„.');
        return;
      }
    }
    if(!next){
      if(!confirm('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚­ì œí• ê¹Œ?')) return;
      localStorage.removeItem(STORAGE_KEYS.password);
    }else{
      if(next.length < 4){
        if(!confirm('4ì ë¯¸ë§Œ ë¹„ë°€ë²ˆí˜¸ì•¼. ê·¸ë˜ë„ ì‚¬ìš©í• ë˜?')) return;
      }
      localStorage.setItem(STORAGE_KEYS.password,next);
    }
    document.getElementById('pw-current').value='';
    document.getElementById('pw-new').value='';
    renderPwStatus();
    alert('ë¹„ë°€ë²ˆí˜¸ ì„¤ì •ì´ ë³€ê²½ëì–´.');
  });

  /* ---------- ì ê¸ˆ í™”ë©´ ---------- */
  function maybeShowLock(){
    const pw = localStorage.getItem(STORAGE_KEYS.password);
    if(!pw) return;
    const lock = document.getElementById('lock-screen');
    lock.style.display='flex';
    document.getElementById('lock-error').textContent='';
    document.getElementById('lock-password').value='';
  }
  document.getElementById('lock-confirm').addEventListener('click', ()=>{
    const input = document.getElementById('lock-password').value;
    const pw = localStorage.getItem(STORAGE_KEYS.password);
    if(input === pw){
      document.getElementById('lock-screen').style.display='none';
    }else{
      document.getElementById('lock-error').textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    }
  });

  /* ---------- ì´ˆê¸°í™” ---------- */
  loadData();
  renderProducts();
  renderTapes();
  renderJobs();
  renderPwStatus();
  maybeShowLock();
</script>
</body>
  </html>
