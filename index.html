<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Tape Flow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f6ff;
      --bg-deep: #e5edff;
      --text-main: #111827;
      --text-sub: #4b5563;
      --accent: #4f46e5;
      --accent-soft: #e0e7ff;
      --card: #ffffff;
      --border-soft: #e5e7eb;
      --danger: #ef4444;
      --input-bg: #ffffff;
    }
    body.dark {
      --bg: #020617;
      --bg-deep: #020617;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --accent: #60a5fa;
      --accent-soft: #1d2433;
      --card: #020617;
      --border-soft: #1f2933;
      --input-bg: #020617;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at 0 0, #dbeafe 0, var(--bg) 45%),
        var(--bg);
      color: var(--text-main);
    }

    .app {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px 16px 40px;
    }

    header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .logo-box {
      width: 44px;
      height: 44px;
      border-radius: 18px;
      background: linear-gradient(145deg, #f97316, #facc15);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.18);
      flex-shrink: 0;
    }
    .logo-box span {
      font-size: 26px;
    }
    .title-wrap h1 {
      font-size: 22px;
      margin: 0;
      letter-spacing: 1px;
    }
    .title-wrap p {
      margin: 2px 0 0;
      font-size: 12px;
      color: var(--text-sub);
    }

    .tab-row {
      display: flex;
      gap: 8px;
      margin: 12px 0 16px;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .tab-button {
      flex: 1;
      min-width: 0;
      border-radius: 999px;
      border: none;
      padding: 10px 10px;
      background: rgba(255, 255, 255, 0.7);
      color: var(--text-sub);
      font-size: 13px;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
      white-space: nowrap;
    }
    .tab-button.active {
      background: linear-gradient(135deg, var(--accent), #6366f1);
      color: #ffffff;
      box-shadow: 0 8px 20px rgba(79, 70, 229, 0.35);
    }

    .tab-section {
      display: none;
    }
    .tab-section.active {
      display: block;
    }

    .card {
      background: radial-gradient(circle at top left, var(--accent-soft), var(--card));
      border-radius: 20px;
      padding: 16px 16px 18px;
      margin-bottom: 16px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.12);
    }

    h2 {
      margin: 0 0 8px;
      font-size: 18px;
    }
    .card-sub {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 12px;
    }

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-sub);
    }

    input, select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 9px 12px;
      font-size: 13px;
      margin-bottom: 10px;
      background: var(--input-bg);
      color: var(--text-main);
    }
    input::placeholder {
      color: #9ca3af;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .btn-primary, .btn-secondary, .btn-danger, .chip-btn {
      border-radius: 999px;
      border: none;
      padding: 9px 16px;
      font-size: 13px;
      font-weight: 600;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #6366f1);
      color: #fff;
      box-shadow: 0 8px 18px rgba(79, 70, 229, 0.45);
    }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-sub);
      border: 1px solid var(--border-soft);
    }
    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
    }
    .chip-btn {
      padding: 5px 10px;
      font-size: 11px;
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-sub);
      border: 1px solid var(--border-soft);
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      margin-top: 10px;
      padding-bottom: 2px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 520px;
    }
    th, td {
      border-bottom: 1px solid var(--border-soft);
      padding: 6px 6px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-weight: 700;
      background: rgba(15, 23, 42, 0.02);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      font-size: 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      margin-left: 4px;
    }

    .small-text {
      font-size: 11px;
      color: var(--text-sub);
    }

    .subtab-row {
      display: inline-flex;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      background: rgba(255,255,255,0.7);
      margin-bottom: 10px;
    }
    .subtab-button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      background: transparent;
      color: var(--text-sub);
    }
    .subtab-button.active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 4px 12px rgba(79,70,229,0.4);
    }

    .date-nav {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .date-nav button {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.9);
      padding: 4px 10px;
      font-size: 12px;
    }
    .date-nav input[type="date"] {
      max-width: 150px;
      padding: 6px 10px;
      font-size: 12px;
      margin-bottom: 0;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .stat-card {
      border-radius: 16px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.85);
      border: 1px solid var(--border-soft);
      box-shadow: 0 4px 14px rgba(15,23,42,0.08);
    }
    .stat-label {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 18px;
      font-weight: 700;
    }
    .stat-sub {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    @media (min-width: 720px) {
      .card-grid {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 16px;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo-box"><span>ğŸ“¦</span></div>
    <div class="title-wrap">
      <h1>TAPE FLOW</h1>
      <p>í…Œì´í”„Â·ì œí’ˆ ì¬ê³  &amp; ì‘ì—… ê¸°ë¡ ê´€ë¦¬</p>
    </div>
  </header>

  <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜: ëŒ€ì‹œë³´ë“œ / ì¬ê³  / ì‘ì—… / ì„¤ì • -->
  <nav class="tab-row">
    <button class="tab-button active" data-tab="dashboard">ëŒ€ì‹œë³´ë“œ</button>
    <button class="tab-button" data-tab="stock">ì¬ê³ </button>
    <button class="tab-button" data-tab="work">ì‘ì—…</button>
    <button class="tab-button" data-tab="settings">ì„¤ì •</button>
  </nav>

  <!-- 1. ëŒ€ì‹œë³´ë“œ -->
  <section id="section-dashboard" class="tab-section active">
    <div class="card">
      <h2>ì˜¤ëŠ˜ ìš”ì•½</h2>
      <p class="card-sub">ì˜¤ëŠ˜ ê¸°ì¤€ ì‘ì—…/í…Œì´í”„ í˜„í™©ì„ í•œëˆˆì— ë³¼ ìˆ˜ ìˆì–´ìš”.</p>
      <div id="dashboard-content" class="dashboard-grid"></div>
    </div>
  </section>

  <!-- 2. ì¬ê³  (ì œí’ˆ / í…Œì´í”„) -->
  <section id="section-stock" class="tab-section">
    <div class="card">
      <div class="subtab-row">
        <button class="subtab-button active" data-stock="product">ì œí’ˆ ì¬ê³ </button>
        <button class="subtab-button" data-stock="tape">í…Œì´í”„ ì¬ê³ </button>
      </div>

      <!-- ì œí’ˆ ì¬ê³  Pane -->
      <div id="stock-product-pane">
        <h2>ì œí’ˆ ì¬ê³ </h2>
        <p class="card-sub">
          ì¸ì‡„ì‹¤ì—ì„œ ë‚´ë ¤ì˜¨ <b>ì‘ì—… ì „ ì œí’ˆ</b>ì„ ë“±ë¡í•´ìš”.<br>
          ê°™ì€ ì œí’ˆì´ë¼ë„ ì„¸íŠ¸Â·LOTë§ˆë‹¤ ë”°ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.
        </p>
        <form id="product-form">
          <label>ì œí’ˆëª…</label>
          <input id="product-name" list="product-name-list" placeholder="ì˜ˆ: 7125J" required />
          <label>ìˆ˜ëŸ‰ (EA)</label>
          <input id="product-ea" type="number" min="1" placeholder="ì˜ˆ: 2520" required />
          <label>ë°œì‹  LOT (ì„ íƒ)</label>
          <input id="product-lot" list="product-lot-list" placeholder="ì˜ˆ: LOT123" />
          <label>ì¸ì‡„ì (ì„ íƒ)</label>
          <input id="product-printer" list="product-printer-list" placeholder="ì˜ˆ: ê¹€ì£¼í˜„" />
          <div class="btn-row">
            <button type="submit" class="btn-primary" id="product-submit-btn">ì¬ê³  ì¶”ê°€</button>
            <button type="button" class="btn-secondary" id="product-cancel-edit" style="display:none;">ìˆ˜ì • ì·¨ì†Œ</button>
          </div>
        </form>
        <div class="table-wrapper" id="product-table-wrap" style="margin-top:12px;"></div>
        <button class="btn-secondary" id="product-csv-btn" style="margin-top:8px;">ì œí’ˆ ì¬ê³  CSV ë‹¤ìš´ë¡œë“œ</button>
        <p class="small-text" style="margin-top:6px;">
          ì œí’ˆëª…ê³¼ ìˆ˜ëŸ‰(EA)ë§Œ ì…ë ¥í•´ë„ ë“±ë¡í•  ìˆ˜ ìˆì–´ìš”. LOT/ì¸ì‡„ìëŠ” ë‚˜ì¤‘ì— ì‘ì—… ë“±ë¡í•  ë•Œ ì…ë ¥í•´ë„ ë©ë‹ˆë‹¤.
        </p>
      </div>

      <!-- í…Œì´í”„ ì¬ê³  Pane -->
      <div id="stock-tape-pane" style="display:none;">
        <h2>í…Œì´í”„ ì¬ê³ </h2>
        <p class="card-sub">
          ê°€ê³µì‹¤ / íƒœì„±ì—ì„œ ì˜¬ë¼ì˜¨ í…Œì´í”„ ì…ê³ ì™€ ì‚¬ìš©Â·ë¶ˆëŸ‰ì„ ëª¨ë‘ ë°˜ì˜í•œ ì”ëŸ‰ì„ ê´€ë¦¬í•´ìš”.
        </p>

        <!-- í…Œì´í”„ ì…ê³  ë“±ë¡ -->
        <form id="tape-in-form">
          <label>ì…ê³  ë‚ ì§œ</label>
          <input id="tape-in-date" type="date" required />
          <label>í…Œì´í”„</label>
          <select id="tape-in-tape" required>
            <option value="">í…Œì´í”„ ì„ íƒ</option>
          </select>
          <label>ì…ê³  ì¥ìˆ˜</label>
          <input id="tape-in-qty" type="number" min="1" placeholder="ì˜ˆ: 300" required />
          <label>ë©”ëª¨ (ì„ íƒ)</label>
          <input id="tape-in-memo" placeholder="ì˜ˆ: ê°€ê³µì‹¤ ì‘ì—…ë¶„" />
          <button type="submit" class="btn-primary" style="margin-top:4px;">ì…ê³  ì¶”ê°€</button>
        </form>

        <!-- í˜„ì¬ í…Œì´í”„ ì¬ê³  í˜„í™© -->
        <div class="card" style="margin-top:14px;">
          <h2>í˜„ì¬ í…Œì´í”„ ì¬ê³  í˜„í™©</h2>
          <p class="card-sub">
            ì…ê³ Â·ì‚¬ìš©Â·ë¶ˆëŸ‰Â·ì¡°ì •ì„ ëª¨ë‘ í•©ì³ ê³„ì‚°ëœ <b>í˜„ì¬ ì”ëŸ‰</b>ì´ì—ìš”.<br>
            ì‹¤ì œ ì¬ê³ ì™€ ë‹¤ë¥´ë©´ â€œì”ëŸ‰ ìˆ˜ì •â€ìœ¼ë¡œ ë§ì¶° ë‘˜ ìˆ˜ ìˆì–´ìš”.
          </p>
          <div class="table-wrapper" id="tape-stock-table-wrap"></div>
          <div class="btn-row" style="margin-top:8px;">
            <button class="btn-secondary" id="tape-stock-csv-btn">í…Œì´í”„ ì¬ê³  CSV ë‹¤ìš´ë¡œë“œ</button>
          </div>
          <p class="small-text" style="margin-top:6px;">
            ì”ëŸ‰ ìˆ˜ì •ì€ ê³„ì‚°ê°’ê³¼ ì‹¤ì œ ì¬ê³ ê°€ ë‹¤ë¥¼ ë•Œ <b>ì°¨ì´ë§Œí¼ ë³´ì •</b>í•´ ë‘ëŠ” ìš©ë„ì˜ˆìš”.
          </p>
        </div>

        <!-- ë‚ ì§œë³„ í…Œì´í”„ ì¬ê³ í‘œ -->
        <div class="card" style="margin-top:10px;">
          <h2>ë‚ ì§œë³„ í…Œì´í”„ ì¬ê³ í‘œ</h2>
          <p class="card-sub">
            ë‚ ì§œë¥¼ ë°”ê¾¸ë©´ ê·¸ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì…ê³ Â·ì‚¬ìš©Â·ë¶ˆëŸ‰Â·ì¡°ì •ì„ ëª¨ë‘ ë°˜ì˜í•œ ì”ëŸ‰ì„ ë³¼ ìˆ˜ ìˆì–´ìš”. (ì•½ 100ì¼ ì •ë„ ì¡°íšŒìš©)
          </p>
          <div class="date-nav">
            <button type="button" id="history-prev-btn">â—€ ì „ë‚ </button>
            <input id="tape-history-date" type="date" />
            <button type="button" id="history-next-btn">ë‹¤ìŒë‚  â–¶</button>
          </div>
          <div class="table-wrapper" id="tape-history-table-wrap"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- 3. ì‘ì—… -->
  <section id="section-work" class="tab-section">
    <div class="card">
      <h2>ì‘ì—… ë“±ë¡</h2>
      <p class="card-sub">
        ì–´ë–¤ ì œí’ˆì„ ì–¼ë§ˆë‚˜ ë¶™ì˜€ê³ , í…Œì´í”„ëŠ” ëª‡ ì¥ ì‚¬ìš©í–ˆëŠ”ì§€ ê¸°ë¡í•´ìš”.<br>
        ì œí’ˆëª…ì„ ì…ë ¥í•˜ë©´ ìë™ì™„ì„±ë˜ê³ , LOT/ì¸ì‡„ìë„ ê°€ëŠ¥í•œ í•œ ìë™ìœ¼ë¡œ ì±„ì›Œì ¸ìš”.
      </p>
      <form id="job-form">
        <label>ì‘ì—… ë‚ ì§œ</label>
        <input id="job-date" type="date" required />

        <label>ì œí’ˆ ì„ íƒ / ì´ë¦„</label>
        <input id="job-product" list="job-product-list" placeholder="ì œí’ˆëª… ë˜ëŠ” ì œí’ˆëª… + LOT" />

        <label>ë°œì‹  LOT</label>
        <input id="job-lot" list="product-lot-list" placeholder="ì˜ˆ: LOT123" />

        <label>ì¸ì‡„ì</label>
        <input id="job-printer" list="product-printer-list" placeholder="ì˜ˆ: ê¹€ì£¼í˜„" />

        <label>ì‚¬ìš© ìˆ˜ëŸ‰ (EA)</label>
        <input id="job-ea" type="number" min="0" placeholder="ì˜ˆ: 2520 (ë¹„ìš°ë©´ ìë™ ê³„ì‚° ê°€ëŠ¥)" />

        <label>í…Œì´í”„</label>
        <select id="job-tape">
          <option value="">í…Œì´í”„ ì„ íƒ</option>
        </select>

        <label>í…Œì´í”„ ì‚¬ìš© ì¥ìˆ˜</label>
        <input id="job-sheets" type="number" min="0" placeholder="ì˜ˆ: 300 (ë¹„ìš°ë©´ EA ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°)" />

        <label>í…Œì´í”„ ë¶ˆëŸ‰ ì¥ìˆ˜</label>
        <input id="job-waste" type="number" min="0" placeholder="ì˜ˆ: 2" value="0" />

        <label>ë©”ëª¨ (ì„ íƒ)</label>
        <input id="job-memo" placeholder="ì˜ˆ: SPIN 1ì„¸íŠ¸ë§Œ ì‘ì—…" />

        <div class="btn-row">
          <button type="submit" class="btn-primary" id="job-submit-btn">ì‘ì—… ì €ì¥</button>
          <button type="button" class="btn-secondary" id="job-cancel-edit" style="display:none;">ìˆ˜ì • ì·¨ì†Œ</button>
        </div>
      </form>

      <p class="small-text" style="margin-top:8px;">
        EA/í…Œì´í”„ ì¥ìˆ˜ë¥¼ ë‘˜ ë‹¤ ë¹„ì›Œë‘ë©´, ì œí’ˆëª…+LOT ê¸°ì¤€ìœ¼ë¡œ <b>í•œ ì„¸íŠ¸ EA</b>ë¥¼ ìë™ìœ¼ë¡œ ë„£ê³ ,<br>
        í…Œì´í”„ ì„¤ì •ì˜ EA/ì¥ ë¹„ìœ¨ë¡œ ì¥ìˆ˜ë¥¼ ê³„ì‚°í•´ ì¤„ ìˆ˜ ìˆì–´ìš”.
      </p>
    </div>

    <div class="card">
      <h2>ì‘ì—… ê¸°ë¡</h2>
      <p class="card-sub">
        ë‚ ì§œë³„ ì‘ì—… ë‚´ì—­ì´ì—ìš”. ì˜ëª» ì…ë ¥í•œ ê±´ ìˆ˜ì •Â·ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”.
      </p>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <span class="small-text">íŠ¹ì • ë‚ ì§œ ì‘ì—…ë§Œ ë³´ê³  ì‹¶ìœ¼ë©´ ë‚ ì§œë¥¼ ì„ íƒí•´ìš”.</span>
        <input id="job-filter-date" type="date" style="max-width:140px;font-size:11px;padding:5px 8px;" />
      </div>
      <div class="table-wrapper" id="job-table-wrap" style="margin-top:8px;"></div>
    </div>
  </section>

  <!-- 4. ì„¤ì • -->
  <section id="section-settings" class="tab-section">
    <!-- í…Œì´í”„ ì„¤ì • -->
    <div class="card">
      <h2>í…Œì´í”„ ì„¤ì •</h2>
      <p class="card-sub">
        ìƒˆ í…Œì´í”„ ì¢…ë¥˜ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ EA/ì¥Â·ì¶œì²˜ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”.<br>
        ì´ ì •ë³´ë¡œ ì‘ì—… ë“±ë¡ ì‹œ EA/í…Œì´í”„ ì¥ìˆ˜ë¥¼ ìë™ ê³„ì‚°í•´ìš”.
      </p>
      <form id="tape-form">
        <label>í…Œì´í”„ëª…</label>
        <input id="tape-name" placeholder="ì˜ˆ: 6855, 6491" required />
        <label>EA(ì œí’ˆ ìˆ˜ëŸ‰) / 1ì¥ë‹¹</label>
        <input id="tape-ea-per-sheet" type="number" min="1" placeholder="ì˜ˆ: 6" required />
        <label>ì¶œì²˜</label>
        <select id="tape-source">
          <option value="ê°€ê³µì‹¤">ê°€ê³µì‹¤</option>
          <option value="íƒœì„±">íƒœì„±</option>
          <option value="ê¸°íƒ€">ê¸°íƒ€</option>
        </select>
        <div class="btn-row">
          <button type="submit" class="btn-primary" id="tape-submit-btn">í…Œì´í”„ ì¶”ê°€</button>
          <button type="button" class="btn-secondary" id="tape-cancel-edit" style="display:none;">ìˆ˜ì • ì·¨ì†Œ</button>
        </div>
      </form>
      <div class="table-wrapper" id="tape-table-wrap" style="margin-top:10px;"></div>
    </div>

    <!-- í…Œë§ˆ ì„¤ì • -->
    <div class="card">
      <h2>í…Œë§ˆ Â· í™”ë©´ ì„¤ì •</h2>
      <p class="card-sub">ë¼ì´íŠ¸ / ë‹¤í¬ í…Œë§ˆë¥¼ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”.</p>
      <div class="btn-row">
        <button class="btn-secondary" id="theme-toggle-btn">ë‹¤í¬ ëª¨ë“œ ì „í™˜</button>
      </div>
      <p class="small-text" id="theme-status" style="margin-top:6px;"></p>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ì„¤ì • -->
    <div class="card">
      <h2>ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</h2>
      <p class="card-sub">
        ë‹¤ë¥¸ ì‚¬ëŒì´ ë§ˆìŒëŒ€ë¡œ ìˆ˜ì •í•˜ì§€ ëª»í•˜ê²Œ ê°„ë‹¨í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê±¸ ìˆ˜ ìˆì–´ìš”.
      </p>
      <form id="password-form">
        <label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ (ìˆì„ ê²½ìš°)</label>
        <input id="password-current" type="password" />
        <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ (ìˆ«ì ëª‡ ìë¦¬ë„ ê°€ëŠ¥)</label>
        <input id="password-new" type="password" />
        <div class="btn-row">
          <button type="submit" class="btn-primary">ë¹„ë°€ë²ˆí˜¸ ì„¤ì • / ë³€ê²½</button>
          <button type="button" class="btn-secondary" id="password-clear-btn">ë¹„ë°€ë²ˆí˜¸ í•´ì œ</button>
        </div>
      </form>
      <p class="small-text" style="margin-top:6px;">
        ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ëœ ìƒíƒœì—ì„œ ì²˜ìŒ ì ‘ì†í•˜ë©´ í•œ ë²ˆ í™•ì¸ì„ ìš”ì²­í•˜ê³ , ê·¸ ì„¸ì…˜ ë™ì•ˆì€ ê³„ì† ì“¸ ìˆ˜ ìˆì–´ìš”.
      </p>
    </div>

    <!-- ê³„ì • ì—­í•  ê³¨ê²© (ì¶”í›„ í™•ì¥ìš©) -->
    <div class="card">
      <h2>ê³„ì • ì—­í•  (ì¤€ë¹„ ì¤‘)</h2>
      <p class="card-sub">
        ì•ìœ¼ë¡œëŠ” í…Œì´í”„ì‹¤ / ê°€ê³µì‹¤1 / íƒœì„± / ëŒ€ë¦¬ë‹˜ / ë¶€ì¥ë‹˜ ê³„ì •ì„ ë‚˜ëˆ ì„œ,<br>
        ë¯¼ê°í•œ ì„¤ì •ì€ ê´€ë¦¬ìë§Œ ë³€ê²½í•  ìˆ˜ ìˆë„ë¡ í™•ì¥í•  ìˆ˜ ìˆì–´ìš”.<br>
        ì§€ê¸ˆì€ êµ¬ì¡°ë§Œ ì¡ì•„ë‘ê³ , ì‹¤ì œ ê¶Œí•œ ë¶„ë¦¬ëŠ” ë‚˜ì¤‘ì— ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆê²Œ ì„¤ê³„í•´ ë’€ì–´ìš”.
      </p>
      <p class="small-text">
        í˜„ì¬ëŠ” Film Findì²˜ëŸ¼ <b>ê³µìš© ë¹„ë°€ë²ˆí˜¸ 1ê°œ + ê¸°ê¸° ë‹¨ìœ„ ì‚¬ìš©</b> êµ¬ì¡°ë¡œ ë™ì‘í•©ë‹ˆë‹¤.
      </p>
    </div>
  </section>

  <!-- datalists -->
  <datalist id="product-name-list"></datalist>
  <datalist id="product-lot-list"></datalist>
  <datalist id="product-printer-list"></datalist>
  <datalist id="job-product-list"></datalist>
</div>

<script>
  // ====== Storage helpers ======
  const STORAGE_KEYS = {
    tapes: "tf_tapes",
    products: "tf_products",
    tapeInLogs: "tf_tape_in_logs",
    jobs: "tf_jobs",
    tapeAdjust: "tf_tape_adjust",
    settings: "tf_settings",
  };

  function load(key, def) {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return def;
      const v = JSON.parse(raw);
      return v ?? def;
    } catch (e) {
      console.error("load error", key, e);
      return def;
    }
  }
  function save(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }
  function uid() {
    return (
      Date.now().toString(36) +
      Math.random().toString(36).substring(2, 8)
    );
  }

  // ====== Global state ======
  let tapes = load(STORAGE_KEYS.tapes, []);
  let products = load(STORAGE_KEYS.products, []);
  let tapeInLogs = load(STORAGE_KEYS.tapeInLogs, []);
  let jobs = load(STORAGE_KEYS.jobs, []);
  // ì¡°ì • ê°’ì€ í…Œì´í”„ë³„ ëˆ„ì  diffë§Œ ì €ì¥ (ë‚ ì§œë³„ ì¡°íšŒì—ì„œë„ ê°™ì€ diff ì ìš©)
  let tapeAdjust = load(STORAGE_KEYS.tapeAdjust, {});
  let settings = load(STORAGE_KEYS.settings, {
    theme: "light",
    password: null,
  });

  let editingProductId = null;
  let editingTapeId = null;
  let editingJobId = null;

  let tapeHistoryDateStr = null;

  // ====== Auth check (password) ======
  function ensureAuth() {
    if (!settings.password) return true;
    if (sessionStorage.getItem("tf_authed") === "1") return true;
    const input = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    if (input === null) return false;
    if (input === settings.password) {
      sessionStorage.setItem("tf_authed", "1");
      alert("í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
      return true;
    }
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”.");
    return false;
  }

  // ====== Theme ======
  function applyTheme() {
    if (settings.theme === "dark") {
      document.body.classList.add("dark");
    } else {
      document.body.classList.remove("dark");
    }
    const btn = document.getElementById("theme-toggle-btn");
    const txt = document.getElementById("theme-status");
    if (settings.theme === "dark") {
      btn.textContent = "ë¼ì´íŠ¸ ëª¨ë“œ ì „í™˜";
      txt.textContent = "í˜„ì¬: ë‹¤í¬ ëª¨ë“œ";
    } else {
      btn.textContent = "ë‹¤í¬ ëª¨ë“œ ì „í™˜";
      txt.textContent = "í˜„ì¬: ë¼ì´íŠ¸ ëª¨ë“œ";
    }
  }

  // ====== Tabs ======
  document.querySelectorAll(".tab-button").forEach((btn) => {
    btn.addEventListener("click", () => {
      const tab = btn.dataset.tab;
      document
        .querySelectorAll(".tab-button")
        .forEach((b) => b.classList.toggle("active", b === btn));
      document
        .querySelectorAll(".tab-section")
        .forEach((sec) =>
          sec.classList.toggle("active", sec.id === "section-" + tab)
        );
    });
  });

  // ====== Date helpers ======
  function todayStr() {
    const d = new Date();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const da = String(d.getDate()).padStart(2, "0");
    return `${d.getFullYear()}-${m}-${da}`;
  }
  function shiftDateStr(str, deltaDays) {
    const d = str ? new Date(str) : new Date();
    d.setDate(d.getDate() + deltaDays);
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const da = String(d.getDate()).padStart(2, "0");
    return `${d.getFullYear()}-${m}-${da}`;
  }

  // ====== Autocomplete lists ======
  function refreshAutocomplete() {
    const nameDL = document.getElementById("product-name-list");
    const lotDL = document.getElementById("product-lot-list");
    const printerDL = document.getElementById("product-printer-list");
    const jobProductDL = document.getElementById("job-product-list");

    nameDL.innerHTML = "";
    lotDL.innerHTML = "";
    printerDL.innerHTML = "";
    jobProductDL.innerHTML = "";

    const nameSet = new Set();
    const lotSet = new Set();
    const printerSet = new Set();

    products.forEach((p) => {
      nameSet.add(p.name);
      if (p.lot) lotSet.add(p.lot);
      if (p.printer) printerSet.add(p.printer);

      // ì‘ì—…ìš© ì œí’ˆ ì„ íƒ: "ì œí’ˆëª… (LOT)" í˜•ì‹
      const opt = document.createElement("option");
      opt.value = `${p.name}${p.lot ? " (" + p.lot + ")" : ""}`;
      jobProductDL.appendChild(opt);
    });

    nameSet.forEach((n) => {
      const o = document.createElement("option");
      o.value = n;
      nameDL.appendChild(o);
    });
    lotSet.forEach((l) => {
      const o = document.createElement("option");
      o.value = l;
      lotDL.appendChild(o);
    });
    printerSet.forEach((p) => {
      const o = document.createElement("option");
      o.value = p;
      printerDL.appendChild(o);
    });
  }

  // ====== Product stock rendering ======
  function renderProductTable() {
    const wrap = document.getElementById("product-table-wrap");
    const visible = products.filter((p) => (p.ea ?? 0) > 0);
    if (visible.length === 0) {
      wrap.innerHTML =
        '<p class="small-text">ë“±ë¡ëœ ì œí’ˆ ì¬ê³ ê°€ ì•„ì§ ì—†ì–´ìš”.</p>';
      return;
    }
    const rows = visible
      .slice()
      .sort((a, b) => b.createdAt - a.createdAt)
      .map((p) => {
        return `<tr>
          <td>${new Date(p.createdAt)
            .toLocaleDateString("ko-KR")
            .replace(/\./g, ".")}</td>
          <td>${p.name}</td>
          <td>${p.ea}</td>
          <td>${p.lot || "-"}</td>
          <td>${p.printer || "-"}</td>
          <td>
            <button class="chip-btn" data-act="edit-product" data-id="${p.id}">ìˆ˜ì •</button>
            <button class="chip-btn" data-act="del-product" data-id="${p.id}" style="color:#b91c1c;">ì‚­ì œ</button>
          </td>
        </tr>`;
      })
      .join("");
    wrap.innerHTML = `
      <div class="table-wrapper-inner">
        <table>
          <thead>
            <tr>
              <th>ë“±ë¡ì¼</th><th>ì œí’ˆëª…</th><th>EA</th><th>ë°œì‹  LOT</th><th>ì¸ì‡„ì</th><th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
    wrap
      .querySelectorAll("button[data-act]")
      .forEach((btn) =>
        btn.addEventListener("click", onProductRowAction)
      );
  }

  function onProductRowAction(e) {
    const id = e.target.dataset.id;
    const act = e.target.dataset.act;
    const p = products.find((x) => x.id === id);
    if (!p) return;

    if (act === "edit-product") {
      if (!ensureAuth()) return;
      editingProductId = id;
      document.getElementById("product-name").value = p.name;
      document.getElementById("product-ea").value = p.ea;
      document.getElementById("product-lot").value = p.lot || "";
      document.getElementById("product-printer").value = p.printer || "";
      document.getElementById("product-submit-btn").textContent =
        "ì¬ê³  ìˆ˜ì • ì €ì¥";
      document.getElementById("product-cancel-edit").style.display =
        "inline-flex";
    } else if (act === "del-product") {
      if (!ensureAuth()) return;
      if (!confirm("ì´ ì œí’ˆ ì¬ê³ ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
      products = products.filter((x) => x.id !== id);
      save(STORAGE_KEYS.products, products);
      editingProductId = null;
      document.getElementById("product-submit-btn").textContent =
        "ì¬ê³  ì¶”ê°€";
      document.getElementById("product-cancel-edit").style.display =
        "none";
      document.getElementById("product-form").reset();
      renderProductTable();
      refreshAutocomplete();
      renderDashboard();
    }
  }

  // ====== Product form submit ======
  document
    .getElementById("product-form")
    .addEventListener("submit", (e) => {
      e.preventDefault();
      if (!ensureAuth()) return;

      const name = document
        .getElementById("product-name")
        .value.trim();
      const ea = Number(
        document.getElementById("product-ea").value
      );
      const lot = document
        .getElementById("product-lot")
        .value.trim();
      const printer = document
        .getElementById("product-printer")
        .value.trim();

      if (!name || !ea || ea <= 0) {
        alert("ì œí’ˆëª…ê³¼ ìˆ˜ëŸ‰ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        return;
      }

      if (editingProductId) {
        const p = products.find((x) => x.id === editingProductId);
        if (p) {
          p.name = name;
          p.ea = ea;
          p.initialEa = ea;
          p.lot = lot || null;
          p.printer = printer || null;
        }
      } else {
        products.push({
          id: uid(),
          name,
          ea,
          initialEa: ea,
          lot: lot || null,
          printer: printer || null,
          createdAt: Date.now(),
        });
      }
      save(STORAGE_KEYS.products, products);
      editingProductId = null;
      document.getElementById("product-form").reset();
      document.getElementById("product-submit-btn").textContent =
        "ì¬ê³  ì¶”ê°€";
      document.getElementById("product-cancel-edit").style.display =
        "none";
      renderProductTable();
      refreshAutocomplete();
      renderDashboard();
    });

  document
    .getElementById("product-cancel-edit")
    .addEventListener("click", () => {
      editingProductId = null;
      document.getElementById("product-form").reset();
      document.getElementById("product-submit-btn").textContent =
        "ì¬ê³  ì¶”ê°€";
      document.getElementById("product-cancel-edit").style.display =
        "none";
    });

  // ====== Product CSV ======
  document
    .getElementById("product-csv-btn")
    .addEventListener("click", () => {
      const visible = products.filter((p) => (p.ea ?? 0) > 0);
      if (visible.length === 0) {
        alert("ë‚´ë³´ë‚¼ ì œí’ˆ ì¬ê³ ê°€ ì—†ì–´ìš”.");
        return;
      }
      const header = ["ë“±ë¡ì¼", "ì œí’ˆëª…", "EA", "ë°œì‹ LOT", "ì¸ì‡„ì"];
      const lines = [header.join(",")];
      visible.forEach((p) => {
        lines.push(
          [
            new Date(p.createdAt).toLocaleDateString("ko-KR"),
            p.name,
            p.ea,
            p.lot || "",
            p.printer || "",
          ].join(",")
        );
      });
      downloadCsv("ì œí’ˆì¬ê³ .csv", lines.join("\n"));
    });

  // ====== Job helpers ======
  function findProductsByNameAndLot(name, lot) {
    return products.filter(
      (p) =>
        p.name === name &&
        (lot ? p.lot === lot : true)
    );
  }

  function parseJobProductInput(raw) {
    let productName = raw.trim();
    let lot = null;
    const m = productName.match(/^(.*)\((.*)\)$/);
    if (m) {
      productName = m[1].trim();
      lot = m[2].trim();
    }
    return { productName, lot };
  }

  function onJobProductChange() {
    const raw = document.getElementById("job-product").value.trim();
    if (!raw) return;
    const { productName, lot: fromInputLot } = parseJobProductInput(raw);
    const lotInput = document.getElementById("job-lot");
    const printerInput = document.getElementById("job-printer");

    // 1) ì œí’ˆëª… + LOT í˜•ì‹ìœ¼ë¡œ ë“¤ì–´ì˜¨ ê²½ìš°
    if (fromInputLot) {
      lotInput.value = fromInputLot;
    }

    const lot = lotInput.value.trim() || fromInputLot || null;
    let candidates = findProductsByNameAndLot(productName, lot);

    // LOT ì—†ì´ ë™ì¼ ì œí’ˆì´ ì—¬ëŸ¬ ì„¸íŠ¸ë©´ LOT ì•ˆ ë„£ê³  nameë§Œ ë³´ê³  ì°¾ì„ ë•Œ
    if (!lot && candidates.length === 0) {
      candidates = products.filter((p) => p.name === productName);
    }

    if (candidates.length === 1) {
      const p = candidates[0];
      if (!lotInput.value && p.lot) lotInput.value = p.lot;
      if (!printerInput.value && p.printer) printerInput.value = p.printer;
    }
    // ì—¬ëŸ¬ ê°œë©´ LOTëŠ” ì‚¬ìš©ìê°€ job-lotì— ì§ì ‘ ê³¨ë¼ ë„£ë„ë¡ (ìë™ì™„ì„± ëª©ë¡ì—ì„œ)
  }

  document
    .getElementById("job-product")
    .addEventListener("change", onJobProductChange);
  document
    .getElementById("job-product")
    .addEventListener("blur", onJobProductChange);

  document
    .getElementById("job-lot")
    .addEventListener("change", () => {
      const productRaw = document.getElementById("job-product").value.trim();
      if (!productRaw) return;
      const { productName } = parseJobProductInput(productRaw);
      const lotInput = document.getElementById("job-lot").value.trim();
      const candidates = findProductsByNameAndLot(productName, lotInput);
      if (candidates.length === 1) {
        const p = candidates[0];
        if (p.printer) {
          document.getElementById("job-printer").value = p.printer;
        }
      }
    });

  // ì œí’ˆ ì¬ê³ ì— ì‘ì—… ë°˜ì˜ / ë˜ëŒë¦¬ê¸°
  // direction: -1 = ì‚¬ìš©(ì°¨ê°), +1 = ë˜ëŒë¦¬ê¸°(ì¦ê°€)
  function applyJobToProduct(job, direction) {
    if (!job.productId || !job.eaUsed) return;
    const p = products.find((x) => x.id === job.productId);
    if (!p) return;
    const delta = direction * job.eaUsed;
    p.ea = (p.ea || 0) + delta;
    if (p.ea < 0) p.ea = 0;
  }

  // ====== Job rendering ======
  function renderJobTable() {
    const wrap = document.getElementById("job-table-wrap");
    if (jobs.length === 0) {
      wrap.innerHTML =
        '<p class="small-text">ë“±ë¡ëœ ì‘ì—… ê¸°ë¡ì´ ì•„ì§ ì—†ì–´ìš”.</p>';
      return;
    }
    const filterDate =
      document.getElementById("job-filter-date").value || null;
    const rows = jobs
      .slice()
      .sort((a, b) => b.createdAt - a.createdAt)
      .filter((j) => !filterDate || j.date === filterDate)
      .map((j) => {
        return `<tr>
          <td>${j.date}</td>
          <td>${j.productName || "-"}</td>
          <td>${j.eaUsed ?? "-"}</td>
          <td>${j.tapeName || "-"}</td>
          <td>${j.sheets ?? "-"}</td>
          <td>${j.wasteSheets ?? 0}</td>
          <td>${j.lot || "-"}</td>
          <td>${j.printer || "-"}</td>
          <td>${j.memo || "-"}</td>
          <td>
            <button class="chip-btn" data-act="edit-job" data-id="${
              j.id
            }">ìˆ˜ì •</button>
            <button class="chip-btn" data-act="del-job" data-id="${
              j.id
            }" style="color:#b91c1c;">ì‚­ì œ</button>
          </td>
        </tr>`;
      })
      .join("");
    wrap.innerHTML = `
      <div class="table-wrapper-inner">
        <table>
          <thead>
            <tr>
              <th>ë‚ ì§œ</th><th>ì œí’ˆëª…</th><th>EA</th><th>í…Œì´í”„</th><th>ì‚¬ìš©ì¥ìˆ˜</th><th>ë¶ˆëŸ‰</th><th>LOT</th><th>ì¸ì‡„ì</th><th>ë©”ëª¨</th><th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
    wrap
      .querySelectorAll("button[data-act]")
      .forEach((btn) =>
        btn.addEventListener("click", onJobRowAction)
      );
  }

  function onJobRowAction(e) {
    const id = e.target.dataset.id;
    const act = e.target.dataset.act;
    const j = jobs.find((x) => x.id === id);
    if (!j) return;

    if (act === "edit-job") {
      if (!ensureAuth()) return;
      editingJobId = id;
      document.getElementById("job-date").value = j.date;
      document.getElementById("job-product").value =
        j.productName || "";
      document.getElementById("job-lot").value = j.lot || "";
      document.getElementById("job-printer").value =
        j.printer || "";
      document.getElementById("job-ea").value =
        j.eaUsed ?? "";
      document.getElementById("job-tape").value =
        j.tapeId || "";
      document.getElementById("job-sheets").value =
        j.sheets ?? "";
      document.getElementById("job-waste").value =
        j.wasteSheets ?? 0;
      document.getElementById("job-memo").value = j.memo || "";
      document.getElementById("job-submit-btn").textContent =
        "ì‘ì—… ìˆ˜ì • ì €ì¥";
      document.getElementById("job-cancel-edit").style.display =
        "inline-flex";
    } else if (act === "del-job") {
      if (!ensureAuth()) return;
      if (!confirm("ì´ ì‘ì—… ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;

      // ì œí’ˆ ì¬ê³  ë˜ëŒë¦¬ê¸°
      applyJobToProduct(j, +1);
      save(STORAGE_KEYS.products, products);
      renderProductTable();
      refreshAutocomplete();

      jobs = jobs.filter((x) => x.id !== id);
      save(STORAGE_KEYS.jobs, jobs);
      editingJobId = null;
      document.getElementById("job-form").reset();
      document.getElementById("job-submit-btn").textContent =
        "ì‘ì—… ì €ì¥";
      document.getElementById("job-cancel-edit").style.display =
        "none";
      renderJobTable();
      renderTapeStockTable();
      renderTapeHistoryTable();
      renderDashboard();
    }
  }

  // ====== Job form submit ======
  document
    .getElementById("job-form")
    .addEventListener("submit", (e) => {
      e.preventDefault();
      if (!ensureAuth()) return;

      const date =
        document.getElementById("job-date").value || todayStr();
      const productRaw = document
        .getElementById("job-product")
        .value.trim();
      const lotInput = document
        .getElementById("job-lot")
        .value.trim();
      const printer = document
        .getElementById("job-printer")
        .value.trim();
      const eaRaw = document.getElementById("job-ea").value;
      const tapeId =
        document.getElementById("job-tape").value || null;
      const sheetsRaw =
        document.getElementById("job-sheets").value;
      const waste =
        Number(document.getElementById("job-waste").value) || 0;
      const memo = document
        .getElementById("job-memo")
        .value.trim();

      if (!tapeId) {
        alert("í…Œì´í”„ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
      }

      let productName = null;
      let lotFromProduct = null;
      if (productRaw) {
        const parsed = parseJobProductInput(productRaw);
        productName = parsed.productName;
        lotFromProduct = parsed.lot;
      }

      const lot = lotInput || lotFromProduct || null;

      let ea = eaRaw ? Number(eaRaw) : null;
      let sheets = sheetsRaw ? Number(sheetsRaw) : null;

      // í…Œì´í”„ ì •ë³´
      const tape = tapes.find((t) => t.id === tapeId);

      // í•´ë‹¹ ì œí’ˆ ì¬ê³  ì°¾ê¸° (ì‘ì—… ì‹œ í•œ ì„¸íŠ¸ ê¸°ì¤€ EA ê³„ì‚°ì— ì‚¬ìš©)
      let productId = null;
      let productRecord = null;
      if (productName) {
        let candidates = findProductsByNameAndLot(productName, lot);
        if (!lot && candidates.length === 0) {
          candidates = products.filter((p) => p.name === productName);
        }
        if (candidates.length === 1) {
          productRecord = candidates[0];
          productId = productRecord.id;
        }
      }

      // EA / í…Œì´í”„ ì¥ìˆ˜ ê³„ì‚° ë¡œì§
      // 1) EAì™€ ì¥ìˆ˜ ë‘˜ ë‹¤ ë¹„ì–´ìˆìœ¼ë©´ â†’ í•œ ì„¸íŠ¸ ê¸°ì¤€ìœ¼ë¡œ EA ìë™, í…Œì´í”„ ì„¤ì •ìœ¼ë¡œ ì¥ìˆ˜ ê³„ì‚°
      if (!ea && !sheets && productRecord) {
        const baseEa =
          productRecord.initialEa ||
          productRecord.ea ||
          null;
        if (!baseEa) {
          alert("í•´ë‹¹ ì œí’ˆ ì„¸íŠ¸ì˜ EAë¥¼ ì•Œ ìˆ˜ ì—†ì–´ìš”. EA ë˜ëŠ” ì¥ìˆ˜ ì¤‘ í•˜ë‚˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
          return;
        }
        ea = baseEa;
        if (tape && tape.eaPerSheet) {
          sheets = Math.ceil(ea / tape.eaPerSheet);
        }
      } else {
        // 2) EAë§Œ ìˆìœ¼ë©´ â†’ í…Œì´í”„ EA/ì¥ ë¹„ìœ¨ë¡œ ì¥ìˆ˜ ê³„ì‚°
        if (ea && !sheets && tape && tape.eaPerSheet) {
          sheets = Math.ceil(ea / tape.eaPerSheet);
        }
        // 3) ì¥ìˆ˜ë§Œ ìˆìœ¼ë©´ â†’ EA = ì¥ìˆ˜ Ã— EA/ì¥
        if (!ea && sheets && tape && tape.eaPerSheet) {
          ea = sheets * tape.eaPerSheet;
        }
      }

      if (!ea && !sheets) {
        alert("EA ë˜ëŠ” í…Œì´í”„ ì¥ìˆ˜ ì¤‘ í•˜ë‚˜ëŠ” ì…ë ¥í•˜ê±°ë‚˜, ì œí’ˆ ì„¸íŠ¸ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
      }

      // ìˆ˜ì • ëª¨ë“œ: ê¸°ì¡´ ì‘ì—…ì˜ ì œí’ˆ ì¬ê³  ë˜ëŒë¦¬ê¸°
      if (editingJobId) {
        const old = jobs.find((x) => x.id === editingJobId);
        if (old) {
          applyJobToProduct(old, +1);
        }
      }

      // ìƒˆ ì‘ì—… ê°ì²´ êµ¬ì„±
      const jobObj = {
        id: editingJobId || uid(),
        date,
        productId,
        productName: productName || null,
        lot: lot || null,
        printer: printer || null,
        eaUsed: ea || null,
        tapeId,
        tapeName: tape ? tape.name : null,
        sheets: sheets || null,
        wasteSheets: waste || 0,
        memo: memo || null,
        createdAt: editingJobId
          ? jobs.find((x) => x.id === editingJobId).createdAt
          : Date.now(),
      };

      // ìƒˆ ì‘ì—…ì„ ì œí’ˆ ì¬ê³ ì— ë°˜ì˜ (EA ì°¨ê°)
      if (productId && ea) {
        applyJobToProduct(jobObj, -1);
      }

      // jobs ì €ì¥
      if (editingJobId) {
        jobs = jobs.map((j) => (j.id === jobObj.id ? jobObj : j));
      } else {
        jobs.push(jobObj);
      }

      save(STORAGE_KEYS.jobs, jobs);
      save(STORAGE_KEYS.products, products);

      editingJobId = null;
      document.getElementById("job-form").reset();
      document.getElementById("job-date").value = date;
      document.getElementById("job-submit-btn").textContent =
        "ì‘ì—… ì €ì¥";
      document.getElementById("job-cancel-edit").style.display =
        "none";

      renderProductTable();
      refreshAutocomplete();
      renderJobTable();
      renderTapeStockTable();
      renderTapeHistoryTable();
      renderDashboard();
    });

  document
    .getElementById("job-cancel-edit")
    .addEventListener("click", () => {
      editingJobId = null;
      document.getElementById("job-form").reset();
      document.getElementById("job-submit-btn").textContent =
        "ì‘ì—… ì €ì¥";
      document.getElementById("job-cancel-edit").style.display =
        "none";
    });

  document
    .getElementById("job-filter-date")
    .addEventListener("change", renderJobTable);

  // ====== Tape settings ======
  function renderTapeTable() {
    const wrap = document.getElementById("tape-table-wrap");
    if (tapes.length === 0) {
      wrap.innerHTML =
        '<p class="small-text">ë“±ë¡ëœ í…Œì´í”„ê°€ ì•„ì§ ì—†ì–´ìš”.</p>';
      return;
    }
    const rows = tapes
      .slice()
      .sort((a, b) => a.name.localeCompare(b.name))
      .map((t) => {
        return `<tr>
          <td>${t.name}</td>
          <td>${t.eaPerSheet}</td>
          <td>${t.source}</td>
          <td>
            <button class="chip-btn" data-act="edit-tape" data-id="${
              t.id
            }">ìˆ˜ì •</button>
            <button class="chip-btn" data-act="del-tape" data-id="${
              t.id
            }" style="color:#b91c1c;">ì‚­ì œ</button>
          </td>
        </tr>`;
      })
      .join("");
    wrap.innerHTML = `
      <div class="table-wrapper-inner">
        <table>
          <thead>
            <tr><th>í…Œì´í”„ëª…</th><th>EA/ì¥</th><th>ì¶œì²˜</th><th>ê´€ë¦¬</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
    wrap
      .querySelectorAll("button[data-act]")
      .forEach((btn) =>
        btn.addEventListener("click", onTapeRowAction)
      );
    refreshTapeSelects();
  }

  function onTapeRowAction(e) {
    const id = e.target.dataset.id;
    const act = e.target.dataset.act;
    const t = tapes.find((x) => x.id === id);
    if (!t) return;

    if (act === "edit-tape") {
      if (!ensureAuth()) return;
      editingTapeId = id;
      document.getElementById("tape-name").value = t.name;
      document.getElementById("tape-ea-per-sheet").value =
        t.eaPerSheet;
      document.getElementById("tape-source").value = t.source;
      document.getElementById("tape-submit-btn").textContent =
        "í…Œì´í”„ ìˆ˜ì • ì €ì¥";
      document.getElementById("tape-cancel-edit").style.display =
        "inline-flex";
    } else if (act === "del-tape") {
      if (!ensureAuth()) return;
      if (
        !confirm(
          "ì´ í…Œì´í”„ ì„¤ì •ì„ ì‚­ì œí• ê¹Œìš”? (ê¸°ì¡´ ì‘ì—… ê¸°ë¡ì˜ ì´ë¦„ë§Œ ë‚¨ê³  ê³„ì‚°ì—ëŠ” ì˜í–¥ ì—†ì–´ìš”)"
        )
      )
        return;
      tapes = tapes.filter((x) => x.id !== id);
      save(STORAGE_KEYS.tapes, tapes);
      editingTapeId = null;
      document.getElementById("tape-form").reset();
      document.getElementById("tape-submit-btn").textContent =
        "í…Œì´í”„ ì¶”ê°€";
      document.getElementById("tape-cancel-edit").style.display =
        "none";
      renderTapeTable();
      renderTapeStockTable();
      renderTapeHistoryTable();
      renderDashboard();
    }
  }

  document
    .getElementById("tape-form")
    .addEventListener("submit", (e) => {
      e.preventDefault();
      if (!ensureAuth()) return;
      const name = document
        .getElementById("tape-name")
        .value.trim();
      const eaPerSheet = Number(
        document.getElementById("tape-ea-per-sheet").value
      );
      const source = document.getElementById("tape-source").value;
      if (!name || !eaPerSheet) {
        alert("í…Œì´í”„ëª…ê³¼ EA/ì¥ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        return;
      }
      if (editingTapeId) {
        const t = tapes.find((x) => x.id === editingTapeId);
        if (t) {
          t.name = name;
          t.eaPerSheet = eaPerSheet;
          t.source = source;
        }
      } else {
        tapes.push({
          id: uid(),
          name,
          eaPerSheet,
          source,
        });
      }
      save(STORAGE_KEYS.tapes, tapes);
      editingTapeId = null;
      document.getElementById("tape-form").reset();
      document.getElementById("tape-submit-btn").textContent =
        "í…Œì´í”„ ì¶”ê°€";
      document.getElementById("tape-cancel-edit").style.display =
        "none";
      renderTapeTable();
      renderTapeStockTable();
      renderTapeHistoryTable();
      renderDashboard();
    });

  document
    .getElementById("tape-cancel-edit")
    .addEventListener("click", () => {
      editingTapeId = null;
      document.getElementById("tape-form").reset();
      document.getElementById("tape-submit-btn").textContent =
        "í…Œì´í”„ ì¶”ê°€";
      document.getElementById("tape-cancel-edit").style.display =
        "none";
    });

  function refreshTapeSelects() {
    const sel1 = document.getElementById("job-tape");
    const sel2 = document.getElementById("tape-in-tape");
    const makeOptions = () =>
      ['<option value="">í…Œì´í”„ ì„ íƒ</option>'].concat(
        tapes.map(
          (t) =>
            `<option value="${t.id}">${t.name} (${t.source})</option>`
        )
      );
    sel1.innerHTML = makeOptions().join("");
    sel2.innerHTML = makeOptions().join("");
  }

  // ====== Tape ì…ê³  ======
  document
    .getElementById("tape-in-form")
    .addEventListener("submit", (e) => {
      e.preventDefault();
      if (!ensureAuth()) return;
      const date =
        document.getElementById("tape-in-date").value ||
        todayStr();
      const tapeId =
        document.getElementById("tape-in-tape").value;
      const qty = Number(
        document.getElementById("tape-in-qty").value
      );
      const memo = document
        .getElementById("tape-in-memo")
        .value.trim();
      if (!tapeId || !qty) {
        alert("í…Œì´í”„ì™€ ì…ê³  ì¥ìˆ˜ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        return;
      }
      tapeInLogs.push({
        id: uid(),
        date,
        tapeId,
        qty,
        memo: memo || null,
        createdAt: Date.now(),
      });
      save(STORAGE_KEYS.tapeInLogs, tapeInLogs);
      document.getElementById("tape-in-form").reset();
      document.getElementById("tape-in-date").value = date;
      renderTapeStockTable();
      renderTapeHistoryTable();
      renderDashboard();
    });

  // ====== Tape stock ê³„ì‚° helper ======
  function calcTapeSnapshot(tapeId, dateStr) {
    const inQty = tapeInLogs
      .filter(
        (l) =>
          l.tapeId === tapeId &&
          (!dateStr || l.date <= dateStr)
      )
      .reduce((sum, l) => sum + l.qty, 0);
    const usedSheets = jobs
      .filter(
        (j) =>
          j.tapeId === tapeId &&
          j.sheets &&
          (!dateStr || j.date <= dateStr)
      )
      .reduce((sum, j) => sum + j.sheets, 0);
    const wasteSheets = jobs
      .filter(
        (j) =>
          j.tapeId === tapeId &&
          j.wasteSheets &&
          (!dateStr || j.date <= dateStr)
      )
      .reduce((sum, j) => sum + j.wasteSheets, 0);
    const adj = tapeAdjust[tapeId] || 0;
    const current = inQty - usedSheets - wasteSheets + adj;
    return { inQty, usedSheets, wasteSheets, current };
  }

  // ====== Tape stock rendering (í˜„ì¬) ======
  function renderTapeStockTable() {
    const wrap = document.getElementById("tape-stock-table-wrap");
    if (tapes.length === 0) {
      wrap.innerHTML =
        '<p class="small-text">ë¨¼ì € í…Œì´í”„ ì„¤ì •ì—ì„œ í…Œì´í”„ë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</p>';
      return;
    }

    const rows = tapes.map((t) => {
      const snap = calcTapeSnapshot(t.id, null);
      return `<tr>
        <td>${t.name}</td>
        <td>${t.source}</td>
        <td>${snap.inQty}</td>
        <td>${snap.usedSheets}</td>
        <td>${snap.wasteSheets}</td>
        <td>${snap.current}</td>
        <td>
          <button class="chip-btn" data-act="adjust-stock" data-id="${
            t.id
          }">ì”ëŸ‰ ìˆ˜ì •</button>
        </td>
      </tr>`;
    });

    wrap.innerHTML = `
      <div class="table-wrapper-inner">
        <table>
          <thead>
            <tr>
              <th>í…Œì´í”„ëª…</th><th>ì¶œì²˜</th><th>ì…ê³ ì¥ìˆ˜</th><th>ì‚¬ìš©ì¥ìˆ˜</th><th>ë¶ˆëŸ‰</th><th>í˜„ì¬ì”ëŸ‰</th><th>ì¡°ì •</th>
            </tr>
          </thead>
          <tbody>${rows.join("")}</tbody>
        </table>
      </div>
    `;

    wrap
      .querySelectorAll("button[data-act='adjust-stock']")
      .forEach((btn) =>
        btn.addEventListener("click", onAdjustStockClick)
      );
  }

  function onAdjustStockClick(e) {
    if (!ensureAuth()) return;
    const tapeId = e.target.dataset.id;
    const t = tapes.find((x) => x.id === tapeId);
    if (!t) return;

    const snap = calcTapeSnapshot(t.id, null);
    const input = prompt(
      `${t.name} ì‹¤ì œ ì”ëŸ‰ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.\n(í˜„ì¬ ê³„ì‚°ê°’: ${snap.current}ì¥)`
    );
    if (input === null) return;
    const real = Number(input);
    if (Number.isNaN(real)) {
      alert("ìˆ«ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
      return;
    }
    const diff = real - snap.current;
    tapeAdjust[t.id] = (tapeAdjust[t.id] || 0) + diff;
    save(STORAGE_KEYS.tapeAdjust, tapeAdjust);
    renderTapeStockTable();
    renderTapeHistoryTable();
    renderDashboard();
  }

  // ====== Tape CSV ======
  document
    .getElementById("tape-stock-csv-btn")
    .addEventListener("click", () => {
      if (tapes.length === 0) {
        alert("ë‚´ë³´ë‚¼ í…Œì´í”„ ì¬ê³ ê°€ ì—†ì–´ìš”.");
        return;
      }
      const header = [
        "í…Œì´í”„ëª…",
        "ì¶œì²˜",
        "ì…ê³ ì¥ìˆ˜",
        "ì‚¬ìš©ì¥ìˆ˜",
        "ë¶ˆëŸ‰",
        "í˜„ì¬ì”ëŸ‰",
      ];
      const lines = [header.join(",")];
      tapes.forEach((t) => {
        const snap = calcTapeSnapshot(t.id, null);
        lines.push(
          [
            t.name,
            t.source,
            snap.inQty,
            snap.usedSheets,
            snap.wasteSheets,
            snap.current,
          ].join(",")
        );
      });
      downloadCsv("í…Œì´í”„ì¬ê³ .csv", lines.join("\n"));
    });

  // ====== ë‚ ì§œë³„ í…Œì´í”„ ì¬ê³ í‘œ ======
  function renderTapeHistoryTable() {
    const wrap = document.getElementById("tape-history-table-wrap");
    if (!tapeHistoryDateStr) {
      tapeHistoryDateStr = todayStr();
      const inp = document.getElementById("tape-history-date");
      if (inp) inp.value = tapeHistoryDateStr;
    }
    if (tapes.length === 0) {
      wrap.innerHTML =
        '<p class="small-text">ë¨¼ì € í…Œì´í”„ ì„¤ì •ì—ì„œ í…Œì´í”„ë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</p>';
      return;
    }
    const rows = tapes.map((t) => {
      const snap = calcTapeSnapshot(t.id, tapeHistoryDateStr);
      return `<tr>
        <td>${t.name}</td>
        <td>${t.source}</td>
        <td>${snap.inQty}</td>
        <td>${snap.usedSheets}</td>
        <td>${snap.wasteSheets}</td>
        <td>${snap.current}</td>
      </tr>`;
    });
    wrap.innerHTML = `
      <div class="table-wrapper-inner">
        <table>
          <thead>
            <tr>
              <th>í…Œì´í”„ëª…</th><th>ì¶œì²˜</th><th>ì…ê³ ì¥ìˆ˜(ëˆ„ì )</th><th>ì‚¬ìš©ì¥ìˆ˜(ëˆ„ì )</th><th>ë¶ˆëŸ‰(ëˆ„ì )</th><th>${tapeHistoryDateStr} ê¸°ì¤€ ì”ëŸ‰</th>
            </tr>
          </thead>
          <tbody>${rows.join("")}</tbody>
        </table>
      </div>
    `;
  }

  const historyDateInput = document.getElementById("tape-history-date");
  const historyPrevBtn = document.getElementById("history-prev-btn");
  const historyNextBtn = document.getElementById("history-next-btn");

  if (historyDateInput) {
    historyDateInput.addEventListener("change", () => {
      tapeHistoryDateStr =
        historyDateInput.value || todayStr();
      renderTapeHistoryTable();
    });
  }
  if (historyPrevBtn) {
    historyPrevBtn.addEventListener("click", () => {
      tapeHistoryDateStr = shiftDateStr(
        tapeHistoryDateStr || todayStr(),
        -1
      );
      historyDateInput.value = tapeHistoryDateStr;
      renderTapeHistoryTable();
    });
  }
  if (historyNextBtn) {
    historyNextBtn.addEventListener("click", () => {
      tapeHistoryDateStr = shiftDateStr(
        tapeHistoryDateStr || todayStr(),
        1
      );
      historyDateInput.value = tapeHistoryDateStr;
      renderTapeHistoryTable();
    });
  }

  // ====== CSV download helper ======
  function downloadCsv(filename, text) {
    const blob = new Blob([text], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ====== Settings: theme & password ======
  document
    .getElementById("theme-toggle-btn")
    .addEventListener("click", () => {
      settings.theme = settings.theme === "dark" ? "light" : "dark";
      save(STORAGE_KEYS.settings, settings);
      applyTheme();
    });

  document
    .getElementById("password-form")
    .addEventListener("submit", (e) => {
      e.preventDefault();
      const cur = document.getElementById("password-current").value;
      const next = document.getElementById("password-new").value;
      if (settings.password && cur !== settings.password) {
        alert("í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•Šì•„ìš”.");
        return;
      }
      settings.password = next || null;
      save(STORAGE_KEYS.settings, settings);
      document.getElementById("password-current").value = "";
      document.getElementById("password-new").value = "";
      if (settings.password) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } else {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }
    });

  document
    .getElementById("password-clear-btn")
    .addEventListener("click", () => {
      if (!settings.password) {
        alert("ì„¤ì •ëœ ë¹„ë°€ë²ˆí˜¸ê°€ ì—†ì–´ìš”.");
        return;
      }
      if (!confirm("ë¹„ë°€ë²ˆí˜¸ë¥¼ í•´ì œí• ê¹Œìš”?")) return;
      settings.password = null;
      save(STORAGE_KEYS.settings, settings);
      alert("ë¹„ë°€ë²ˆí˜¸ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    });

  // ====== ì¬ê³  íƒ­ ë‚´ë¶€ í† ê¸€ (ì œí’ˆ / í…Œì´í”„) ======
  document
    .querySelectorAll(".subtab-button")
    .forEach((btn) => {
      btn.addEventListener("click", () => {
        const mode = btn.dataset.stock;
        document
          .querySelectorAll(".subtab-button")
          .forEach((b) =>
            b.classList.toggle("active", b === btn)
          );
        document.getElementById("stock-product-pane").style.display =
          mode === "product" ? "block" : "none";
        document.getElementById("stock-tape-pane").style.display =
          mode === "tape" ? "block" : "none";
      });
    });

  // ====== ëŒ€ì‹œë³´ë“œ ë Œë”ë§ ======
  function renderDashboard() {
    const wrap = document.getElementById("dashboard-content");
    if (!wrap) return;
    const today = todayStr();
    const todayJobs = jobs.filter((j) => j.date === today);
    const jobCount = todayJobs.length;
    const todaySheets = todayJobs.reduce(
      (sum, j) => sum + (j.sheets || 0),
      0
    );
    const todayTapeIn = tapeInLogs
      .filter((l) => l.date === today)
      .reduce((sum, l) => sum + l.qty, 0);
    const totalProductEa = products.reduce(
      (sum, p) => sum + (p.ea || 0),
      0
    );
    const totalTapeCurrent = tapes.reduce((sum, t) => {
      const snap = calcTapeSnapshot(t.id, null);
      return sum + snap.current;
    }, 0);

    wrap.innerHTML = `
      <div class="stat-card">
        <div class="stat-label">ì˜¤ëŠ˜ ì‘ì—… ê°œìˆ˜</div>
        <div class="stat-value">${jobCount}</div>
        <div class="stat-sub">(${today})</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì˜¤ëŠ˜ ì‚¬ìš© í…Œì´í”„ ì¥ìˆ˜</div>
        <div class="stat-value">${todaySheets}</div>
        <div class="stat-sub">ì‘ì—… ê¸°ë¡ ê¸°ì¤€</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì˜¤ëŠ˜ ì…ê³ ëœ í…Œì´í”„</div>
        <div class="stat-value">${todayTapeIn}</div>
        <div class="stat-sub">ì…ê³  ë“±ë¡ ê¸°ì¤€</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">í˜„ì¬ ì œí’ˆ ì¬ê³  (EA)</div>
        <div class="stat-value">${totalProductEa}</div>
        <div class="stat-sub">ì”ì—¬ ì„¸íŠ¸ í•©ê³„</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">í˜„ì¬ í…Œì´í”„ ì”ëŸ‰ (ì¥)</div>
        <div class="stat-value">${totalTapeCurrent}</div>
        <div class="stat-sub">ëª¨ë“  í…Œì´í”„ í•©ê³„</div>
      </div>
    `;
  }

  // ====== Initial boot ======
  function init() {
    // set default dates
    const today = todayStr();
    document.getElementById("job-date").value = today;
    document.getElementById("job-filter-date").value = today;
    document.getElementById("tape-in-date").value = today;
    const histInput = document.getElementById("tape-history-date");
    if (histInput) {
      tapeHistoryDateStr = today;
      histInput.value = today;
    }

    applyTheme();
    renderTapeTable();
    renderProductTable();
    refreshAutocomplete();
    renderJobTable();
    renderTapeStockTable();
    renderTapeHistoryTable();
    renderDashboard();

    // password first prompt (ì˜µì…˜)
    if (settings.password && !sessionStorage.getItem("tf_authed")) {
      const ok = ensureAuth();
      if (!ok) {
        alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”. (ì¡°íšŒëŠ” ê°€ëŠ¥)");
      }
    }
  }

  init();
</script>
</body>
  </html>
