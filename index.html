<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Tape Flow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f6ff;
      --bg-deep: #e5edff;
      --text-main: #111827;
      --text-sub: #4b5563;
      --accent: #4f46e5;
      --accent-soft: #e0e7ff;
      --card: #ffffff;
      --border-soft: #e5e7eb;
      --danger: #ef4444;
      --input-bg: #ffffff;
    }
    body.dark {
      --bg: #020617;
      --bg-deep: #020617;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --accent: #60a5fa;
      --accent-soft: #1d2433;
      --card: #020617;
      --border-soft: #1f2933;
      --input-bg: #020617;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at 0 0, #dbeafe 0, var(--bg) 45%),
        var(--bg);
      color: var(--text-main);
    }

    .app {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px 16px 40px;
    }

    header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .logo-box {
      width: 44px;
      height: 44px;
      border-radius: 18px;
      background: linear-gradient(145deg, #f97316, #facc15);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.18);
      flex-shrink: 0;
    }
    .logo-box span {
      font-size: 26px;
    }
    .title-wrap h1 {
      font-size: 22px;
      margin: 0;
      letter-spacing: 1px;
    }
    .title-wrap p {
      margin: 2px 0 0;
      font-size: 12px;
      color: var(--text-sub);
    }

    .tab-row {
      display: flex;
      gap: 8px;
      margin: 12px 0 16px;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .tab-button {
      flex: 1;
      min-width: 0;
      border-radius: 999px;
      border: none;
      padding: 10px 10px;
      background: rgba(255, 255, 255, 0.7);
      color: var(--text-sub);
      font-size: 13px;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
      white-space: nowrap;
    }
    .tab-button.active {
      background: linear-gradient(135deg, var(--accent), #6366f1);
      color: #ffffff;
      box-shadow: 0 8px 20px rgba(79, 70, 229, 0.35);
    }

    .tab-section { display: none; }
    .tab-section.active { display: block; }

    .card {
      background: radial-gradient(circle at top left, var(--accent-soft), var(--card));
      border-radius: 20px;
      padding: 16px 16px 18px;
      margin-bottom: 16px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.12);
    }

    h2 {
      margin: 0 0 8px;
      font-size: 18px;
    }
    .card-sub {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 12px;
    }

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-sub);
    }

    input, select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 9px 12px;
      font-size: 13px;
      margin-bottom: 10px;
      background: var(--input-bg);
      color: var(--text-main);
    }
    input::placeholder {
      color: #9ca3af;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }
    .btn-row.center {
      justify-content: center;
    }

    .btn-primary, .btn-secondary, .btn-danger, .chip-btn {
      border-radius: 999px;
      border: none;
      padding: 9px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #6366f1);
      color: #fff;
      box-shadow: 0 8px 18px rgba(79, 70, 229, 0.45);
    }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-sub);
      border: 1px solid var(--border-soft);
    }
    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
    }
    .chip-btn {
      padding: 5px 10px;
      font-size: 11px;
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-sub);
      border: 1px solid var(--border-soft);
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      margin-top: 10px;
      padding-bottom: 2px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 520px;
    }
    th, td {
      border-bottom: 1px solid var(--border-soft);
      padding: 6px 6px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-weight: 700;
      background: rgba(15, 23, 42, 0.02);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .small-text {
      font-size: 11px;
      color: var(--text-sub);
    }

    @media (min-width: 720px) {
      .card-grid {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 16px;
      }
    }

    /* ====== Film Find ìŠ¤íƒ€ì¼ ëª¨ë‹¬ ====== */
    .dialog-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .dialog-overlay.active {
      display: flex;
    }
    .dialog-card {
      width: min(440px, 92vw);
      background: radial-gradient(circle at top, #e0e7ff 0, #ffffff 55%);
      border-radius: 24px;
      padding: 22px 22px 20px;
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.35);
      text-align: center;
    }
    body.dark .dialog-card {
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%);
      color: var(--text-main);
    }
    .dialog-title {
      margin: 0 0 6px;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .dialog-message {
      margin: 0 0 14px;
      font-size: 13px;
      color: var(--text-sub);
      line-height: 1.5;
    }
    .dialog-input-wrap {
      margin-bottom: 12px;
    }
    .dialog-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 10px 14px;
      font-size: 16px;
      text-align: center;
      background: #f9fafb;
    }
    body.dark .dialog-input {
      background: #020617;
    }
    .dialog-helper {
      margin: 4px 0 0;
      font-size: 11px;
      color: var(--text-sub);
    }
    .dialog-btn-primary {
      border-radius: 999px;
      border: none;
      padding: 9px 20px;
      font-size: 14px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), #6366f1);
      color: #fff;
      box-shadow: 0 8px 20px rgba(79, 70, 229, 0.45);
      cursor: pointer;
    }
    .dialog-btn-secondary {
      border-radius: 999px;
      border: none;
      padding: 9px 14px;
      font-size: 13px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-sub);
      border: 1px solid var(--border-soft);
      cursor: pointer;
    }
    .dialog-btn-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 2px;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo-box"><span>ğŸ“¦</span></div>
    <div class="title-wrap">
      <h1>TAPE FLOW</h1>
      <p>í…Œì´í”„Â·ì œí’ˆ ì¬ê³  &amp; ì‘ì—… ê¸°ë¡ ê´€ë¦¬</p>
    </div>
  </header>

  <nav class="tab-row">
    <button class="tab-button active" data-tab="work">ì‘ì—… ë“±ë¡</button>
    <button class="tab-button" data-tab="tape-stock">í…Œì´í”„ ì¬ê³ </button>
    <button class="tab-button" data-tab="tape-settings">í…Œì´í”„ ì„¤ì •</button>
    <button class="tab-button" data-tab="settings">ì„¤ì •</button>
  </nav>

  <!-- ì‘ì—… ë“±ë¡ / ì œí’ˆ ì¬ê³  -->
  <section id="section-work" class="tab-section active">
    <div class="card">
      <h2>ì œí’ˆ ì¬ê³  ë“±ë¡</h2>
      <p class="card-sub">ì¸ì‡„ì‹¤ì—ì„œ ë‚´ë ¤ì˜¨ <b>ì‘ì—… ì „ ì œí’ˆ</b>ì„ ë“±ë¡í•´ìš”. ê°™ì€ ì œí’ˆì´ë¼ë„ ì„¸íŠ¸Â·LOTë§ˆë‹¤ ë”°ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.</p>
      <form id="product-form">
        <label>ì œí’ˆëª…</label>
        <input id="product-name" list="product-name-list" placeholder="ì˜ˆ: 7125J" required />
        <label>ìˆ˜ëŸ‰ (EA)</label>
        <input id="product-ea" type="number" min="1" placeholder="ì˜ˆ: 2520" required />
        <label>ë°œì‹  LOT</label>
        <input id="product-lot" list="product-lot-list" placeholder="ì˜ˆ: LOT123" />
        <label>ì¸ì‡„ì</label>
        <input id="product-printer" list="product-printer-list" placeholder="ì˜ˆ: ê¹€ì£¼í˜„" />
        <div class="btn-row">
          <button type="submit" class="btn-primary" id="product-submit-btn">ì¬ê³  ì¶”ê°€</button>
          <button type="button" class="btn-secondary" id="product-cancel-edit" style="display:none;">ìˆ˜ì • ì·¨ì†Œ</button>
        </div>
      </form>
      <div class="table-wrapper" id="product-table-wrap" style="margin-top:12px;"></div>
      <button class="btn-secondary" id="product-csv-btn" style="margin-top:8px;">ì œí’ˆ ì¬ê³  CSV ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <div class="card">
      <h2>ì‘ì—… ë“±ë¡</h2>
      <p class="card-sub">
        ì–´ë–¤ ì œí’ˆì„ ì–¼ë§ˆë‚˜ ë¶™ì˜€ê³ , í…Œì´í”„ëŠ” ëª‡ ì¥ ì‚¬ìš©í–ˆëŠ”ì§€ ê¸°ë¡í•´ìš”.<br/>
        ì œí’ˆëª…ë§Œ ì…ë ¥í•´ë„ ê¸°ì¡´ ì¬ê³ ì™€ ìë™ìœ¼ë¡œ ì—°ê²°í•´ ì¤„ ìˆ˜ ìˆì–´ìš”.
      </p>
      <form id="job-form">
        <label>ì‘ì—… ë‚ ì§œ</label>
        <input id="job-date" type="date" required />
        <label>ì œí’ˆ ì„ íƒ / ì´ë¦„</label>
        <input id="job-product" list="job-product-list" placeholder="ì œí’ˆëª… ë˜ëŠ” ì œí’ˆëª… + LOT" />
        <label>ë°œì‹  LOT</label>
        <input id="job-lot" list="product-lot-list" placeholder="ì˜ˆ: LOT123" />
        <label>ì¸ì‡„ì</label>
        <input id="job-printer" list="product-printer-list" placeholder="ì˜ˆ: ê¹€ì£¼í˜„" />
        <label>ì‚¬ìš© ìˆ˜ëŸ‰ (EA)</label>
        <input id="job-ea" type="number" min="0" placeholder="ì˜ˆ: 2520 (ë¹„ì›Œë‘ë©´ ìë™ ê³„ì‚° ê°€ëŠ¥)" />
        <label>í…Œì´í”„</label>
        <select id="job-tape">
          <option value="">í…Œì´í”„ ì„ íƒ</option>
        </select>
        <label>í…Œì´í”„ ì‚¬ìš© ì¥ìˆ˜</label>
        <input id="job-sheets" type="number" min="0" placeholder="ì˜ˆ: 300 (ë¹„ì›Œë‘ë©´ EA ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°)" />
        <label>í…Œì´í”„ ë¶ˆëŸ‰ ì¥ìˆ˜</label>
        <input id="job-waste" type="number" min="0" placeholder="ì˜ˆ: 2" value="0" />
        <label>ë©”ëª¨ (ì„ íƒ)</label>
        <input id="job-memo" placeholder="ì˜ˆ: SPIN 1ì„¸íŠ¸ë§Œ ì‘ì—…" />
        <div class="btn-row">
          <button type="submit" class="btn-primary" id="job-submit-btn">ì‘ì—… ì €ì¥</button>
          <button type="button" class="btn-secondary" id="job-cancel-edit" style="display:none;">ìˆ˜ì • ì·¨ì†Œ</button>
        </div>
      </form>

      <p class="small-text" style="margin-top:8px;">
        EA/í…Œì´í”„ ì¥ìˆ˜ë¥¼ ë‘˜ ë‹¤ ë¹„ì›Œë‘ë©´, ì œí’ˆ ì¬ê³ ì—ì„œ <b>ì œí’ˆëª…+LOT ê¸°ì¤€ í•œ ì„¸íŠ¸ EA</b>ë¥¼ ìë™ìœ¼ë¡œ ë„£ê³ <br/>
        í…Œì´í”„ ì„¤ì •ì˜ EA/ì¥ ë¹„ìœ¨ë¡œ í…Œì´í”„ ì¥ìˆ˜ë¥¼ ê³„ì‚°í•´ ì¤„ ìˆ˜ ìˆì–´ìš”.
      </p>

      <div style="margin-top:14px;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <span class="small-text">íŠ¹ì • ë‚ ì§œ ì‘ì—…ë§Œ ë³´ê³  ì‹¶ìœ¼ë©´ ë‚ ì§œë¥¼ ì„ íƒí•´ìš”.</span>
          <input id="job-filter-date" type="date" style="max-width:140px;font-size:11px;padding:5px 8px;" />
        </div>
        <div class="table-wrapper" id="job-table-wrap" style="margin-top:8px;"></div>
      </div>
    </div>
  </section>

  <!-- í…Œì´í”„ ì¬ê³  -->
  <section id="section-tape-stock" class="tab-section">
    <div class="card">
      <h2>í…Œì´í”„ ì…ê³  ë“±ë¡</h2>
      <p class="card-sub">ê°€ê³µì‹¤Â·íƒœì„±ì—ì„œ ì˜¬ë¼ì˜¨ í…Œì´í”„ ì¥ìˆ˜ë¥¼ ë“±ë¡í•´ìš”.</p>
      <form id="tape-in-form">
        <label>ì…ê³  ë‚ ì§œ</label>
        <input id="tape-in-date" type="date" required />
        <label>í…Œì´í”„</label>
        <select id="tape-in-tape" required>
          <option value="">í…Œì´í”„ ì„ íƒ</option>
        </select>
        <label>ì…ê³  ì¥ìˆ˜</label>
        <input id="tape-in-qty" type="number" min="1" placeholder="ì˜ˆ: 300" required />
        <label>ë©”ëª¨ (ì„ íƒ)</label>
        <input id="tape-in-memo" placeholder="ì˜ˆ: ê°€ê³µì‹¤ ì‘ì—…ë¶„" />
        <button type="submit" class="btn-primary" style="margin-top:4px;">ì…ê³  ì¶”ê°€</button>
      </form>
    </div>

    <div class="card">
      <h2>í˜„ì¬ í…Œì´í”„ ì¬ê³  í˜„í™©</h2>
      <p class="card-sub">ì…ê³ Â·ì‚¬ìš©Â·ë¶ˆëŸ‰Â·ì¡°ì •ì„ ëª¨ë‘ í•©ì³ ê³„ì‚°ëœ <b>í˜„ì¬ ì”ëŸ‰</b>ì´ì—ìš”. ì‹¤ì œ ì¬ê³ ì™€ ë‹¤ë¥¼ ë•ŒëŠ” â€œì”ëŸ‰ ìˆ˜ì •â€ìœ¼ë¡œ ë§ì¶° ë‘˜ ìˆ˜ ìˆì–´ìš”.</p>
      <div class="table-wrapper" id="tape-stock-table-wrap"></div>
      <div class="btn-row" style="margin-top:8px;">
        <button class="btn-secondary" id="tape-stock-csv-btn">í…Œì´í”„ ì¬ê³  CSV ë‹¤ìš´ë¡œë“œ</button>
      </div>
      <p class="small-text" style="margin-top:6px;">
        ì”ëŸ‰ ìˆ˜ì •ì€ ê³„ì‚°ê°’ê³¼ ì‹¤ì œ ì¬ê³ ê°€ ë‹¤ë¥¼ ë•Œ <b>ì°¨ì´ë§Œí¼ ë³´ì •</b>í•´ ë‘ëŠ” ìš©ë„ì˜ˆìš”. (ì¡°ì • ë‚´ì—­ì€ ë³„ë„ë¡œ í•©ì‚° ë³´ê´€)
      </p>
    </div>

    <div class="card">
      <h2>ë‚ ì§œë³„ í…Œì´í”„ ì¬ê³ í‘œ</h2>
      <p class="card-sub">
        ë‚ ì§œë¥¼ ë°”ê¾¸ë©´ ê·¸ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì…ê³ Â·ì‚¬ìš©Â·ë¶ˆëŸ‰Â·ì¡°ì •ì„ ëª¨ë‘ ë°˜ì˜í•œ ì”ëŸ‰ì„ ë³¼ ìˆ˜ ìˆì–´ìš”.<br/>
        (ì•½ 100ì¼ ì •ë„ê¹Œì§€ ì¡°íšŒí•˜ëŠ” ìš©ë„ë¡œ ìƒê°í•˜ë©´ ë¼ìš”.)
      </p>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
        <button class="chip-btn" id="hist-prev-day">â—€ ì „ë‚ </button>
        <input id="hist-date" type="date" style="max-width:150px;font-size:12px;padding:5px 10px;" />
        <button class="chip-btn" id="hist-next-day">ë‹¤ìŒë‚  â–¶</button>
      </div>
      <div class="table-wrapper" id="tape-history-table-wrap"></div>
    </div>
  </section>

  <!-- í…Œì´í”„ ì„¤ì • -->
  <section id="section-tape-settings" class="tab-section">
    <div class="card">
      <h2>í…Œì´í”„ ê¸°ë³¸ ì •ë³´</h2>
      <p class="card-sub">ìƒˆ í…Œì´í”„ ì¢…ë¥˜ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ EA/ì¥Â·ì¶œì²˜ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”. ìœ„Â·ì•„ë˜ í™”ì‚´í‘œë¡œ í‘œì‹œ ìˆœì„œë¥¼ ë°”ê¿€ ìˆ˜ë„ ìˆì–´ìš”.</p>
      <form id="tape-form">
        <label>í…Œì´í”„ëª…</label>
        <input id="tape-name" placeholder="ì˜ˆ: 6855, 6491" required />
        <label>EA(ì œí’ˆ ìˆ˜ëŸ‰) / 1ì¥ë‹¹</label>
        <input id="tape-ea-per-sheet" type="number" min="1" placeholder="ì˜ˆ: 6" required />
        <label>ì¶œì²˜</label>
        <select id="tape-source">
          <option value="ê°€ê³µì‹¤">ê°€ê³µì‹¤</option>
          <option value="íƒœì„±">íƒœì„±</option>
          <option value="ê¸°íƒ€">ê¸°íƒ€</option>
        </select>
        <div class="btn-row">
          <button type="submit" class="btn-primary" id="tape-submit-btn">í…Œì´í”„ ì¶”ê°€</button>
          <button type="button" class="btn-secondary" id="tape-cancel-edit" style="display:none;">ìˆ˜ì • ì·¨ì†Œ</button>
        </div>
      </form>

      <div class="table-wrapper" id="tape-table-wrap" style="margin-top:10px;"></div>
    </div>
  </section>

  <!-- ì„¤ì • -->
  <section id="section-settings" class="tab-section">
    <div class="card">
      <h2>í…Œë§ˆ Â· í™”ë©´ ì„¤ì •</h2>
      <p class="card-sub">ë¼ì´íŠ¸ / ë‹¤í¬ í…Œë§ˆë¥¼ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”.</p>
      <div class="btn-row">
        <button class="btn-secondary" id="theme-toggle-btn">ë‹¤í¬ ëª¨ë“œ ì „í™˜</button>
      </div>
      <p class="small-text" id="theme-status" style="margin-top:6px;"></p>
    </div>

    <div class="card">
      <h2>ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</h2>
      <p class="card-sub">ë‹¤ë¥¸ ì‚¬ëŒì´ ë§ˆìŒëŒ€ë¡œ ìˆ˜ì •í•˜ì§€ ëª»í•˜ê²Œ ê°„ë‹¨í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê±¸ ìˆ˜ ìˆì–´ìš”.</p>
      <form id="password-form">
        <label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ (ìˆì„ ê²½ìš°)</label>
        <input id="password-current" type="password" />
        <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ (ìˆ«ì ëª‡ ìë¦¬ë„ ê°€ëŠ¥)</label>
        <input id="password-new" type="password" />
        <div class="btn-row">
          <button type="submit" class="btn-primary">ë¹„ë°€ë²ˆí˜¸ ì„¤ì • / ë³€ê²½</button>
          <button type="button" class="btn-secondary" id="password-clear-btn">ë¹„ë°€ë²ˆí˜¸ í•´ì œ</button>
        </div>
      </form>
      <p class="small-text" style="margin-top:6px;">
        ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ëœ ìƒíƒœì—ì„œ ì ‘ì†í•˜ë©´, <b>Film Find ì ê¸ˆ í™”ë©´ì²˜ëŸ¼</b> í•œ ë²ˆ ì…ë ¥ í›„ íƒ­ì„ ë‹«ê¸° ì „ê¹Œì§€ ê³„ì† ì—´ë ¤ ìˆì–´ìš”.
      </p>
    </div>
  </section>

  <!-- datalists -->
  <datalist id="product-name-list"></datalist>
  <datalist id="product-lot-list"></datalist>
  <datalist id="product-printer-list"></datalist>
  <datalist id="job-product-list"></datalist>

</div>

<!-- ê³µìš© ëª¨ë‹¬ -->
<div class="dialog-overlay" id="dialog-overlay">
  <div class="dialog-card">
    <h2 class="dialog-title" id="dialog-title">ì œëª©</h2>
    <p class="dialog-message" id="dialog-message">ë©”ì‹œì§€</p>
    <div class="dialog-input-wrap" id="dialog-input-wrap">
      <input id="dialog-input" class="dialog-input" />
    </div>
    <div class="dialog-btn-row" id="dialog-btn-row">
      <button type="button" class="dialog-btn-secondary" id="dialog-cancel">ì·¨ì†Œ</button>
      <button type="button" class="dialog-btn-primary" id="dialog-ok">í™•ì¸</button>
    </div>
    <p class="dialog-helper" id="dialog-helper"></p>
  </div>
</div>

<script>
  // ====== Storage helpers ======
  const STORAGE_KEYS = {
    tapes: "tf_tapes",
    products: "tf_products",
    tapeInLogs: "tf_tape_in_logs",
    jobs: "tf_jobs",
    tapeAdjust: "tf_tape_adjust",
    settings: "tf_settings",
  };

  function load(key, def) {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return def;
      const v = JSON.parse(raw);
      return v ?? def;
    } catch (e) {
      console.error("load error", key, e);
      return def;
    }
  }
  function save(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }
  function uid() {
    return (
      Date.now().toString(36) +
      Math.random().toString(36).substring(2, 8)
    );
  }

  // ====== Global state ======
  let tapes = load(STORAGE_KEYS.tapes, []);           // ë°°ì—´ ìˆœì„œ = í‘œì‹œ ìˆœì„œ
  let products = load(STORAGE_KEYS.products, []);
  let tapeInLogs = load(STORAGE_KEYS.tapeInLogs, []);
  let jobs = load(STORAGE_KEYS.jobs, []);
  let tapeAdjust = load(STORAGE_KEYS.tapeAdjust, {});
  let settings = load(STORAGE_KEYS.settings, {
    theme: "light",
    password: null,
  });

  let editingProductId = null;
  let editingTapeId = null;
  let editingJobId = null;

  // ====== Film Find ìŠ¤íƒ€ì¼ ëª¨ë‹¬ ======
  const dialogOverlay = document.getElementById("dialog-overlay");
  const dialogTitle = document.getElementById("dialog-title");
  const dialogMessage = document.getElementById("dialog-message");
  const dialogInputWrap = document.getElementById("dialog-input-wrap");
  const dialogInput = document.getElementById("dialog-input");
  const dialogHelper = document.getElementById("dialog-helper");
  const dialogOk = document.getElementById("dialog-ok");
  const dialogCancel = document.getElementById("dialog-cancel");

  let dialogResolve = null;

  function openDialog(options) {
    return new Promise((resolve) => {
      dialogResolve = resolve;
      const {
        title = "",
        message = "",
        placeholder = "",
        helper = "",
        type = "text",   // "text" | "password" | "number" | "none"
        okText = "í™•ì¸",
        cancelText = "ì·¨ì†Œ",
        defaultValue = "",
        showInput = true,
        singleButton = false,
      } = options || {};

      dialogTitle.textContent = title;
      dialogMessage.innerHTML = message.replace(/\n/g, "<br/>");
      dialogHelper.textContent = helper || "";

      if (showInput && type !== "none") {
        dialogInputWrap.style.display = "block";
        dialogInput.type = type === "password" ? "password" :
                           type === "number" ? "number" : "text";
        dialogInput.value = defaultValue || "";
        dialogInput.placeholder = placeholder || "";
        setTimeout(() => dialogInput.focus(), 30);
      } else {
        dialogInputWrap.style.display = "none";
      }

      dialogOk.textContent = okText || "í™•ì¸";
      dialogCancel.textContent = cancelText || "ì·¨ì†Œ";
      dialogCancel.style.display = singleButton ? "none" : "inline-flex";

      dialogOverlay.classList.add("active");

      const onOk = () => {
        closeDialog();
        if (showInput && type !== "none") {
          resolve(dialogInput.value);
        } else {
          resolve(true);
        }
      };
      const onCancel = () => {
        closeDialog();
        resolve(null);
      };

      dialogOk.onclick = onOk;
      dialogCancel.onclick = onCancel;
      dialogOverlay.onclick = (e) => {
        if (e.target === dialogOverlay) {
          // ë°”ê¹¥ í´ë¦­ì€ ì·¨ì†Œë¡œ
          onCancel();
        }
      };
      dialogInput.onkeydown = (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          onOk();
        }
      };
    });
  }

  function closeDialog() {
    dialogOverlay.classList.remove("active");
  }

  async function uiAlert(message) {
    await openDialog({
      title: "ì•Œë¦¼",
      message,
      showInput: false,
      okText: "í™•ì¸",
      singleButton: true,
      type: "none",
    });
  }

  async function uiConfirm(message) {
    const res = await openDialog({
      title: "í™•ì¸",
      message,
      showInput: false,
      okText: "í™•ì¸",
      cancelText: "ì·¨ì†Œ",
      type: "none",
    });
    return res !== null;
  }

  async function uiPasswordPrompt() {
    const value = await openDialog({
      title: "TAPE FLOW ì ê¸ˆ",
      message: "ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ íƒ­ì„ ë‹«ê¸° ì „ê¹Œì§€ëŠ” ê³„ì† ì—´ë ¤ ìˆì–´ìš”.",
      placeholder: "â€¢â€¢â€¢â€¢",
      helper:
        "ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ëŠ” 1234ì˜ˆìš”. ì„¤ì •ì—ì„œ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”.",
      type: "password",
      okText: "ì…ì¥",
      cancelText: "ì·¨ì†Œ",
      showInput: true,
    });
    return value;
  }

  // ====== Auth check (password) ======
  async function ensureAuth() {
    if (!settings.password) return true;
    if (sessionStorage.getItem("tf_authed") === "1") return true;

    const input = await uiPasswordPrompt();
    if (input === null) return false;

    if (input === settings.password) {
      sessionStorage.setItem("tf_authed", "1");
      await uiAlert("í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
      return true;
    }
    await uiAlert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”.");
    return false;
  }

  // ====== Theme ======
  function applyTheme() {
    if (settings.theme === "dark") {
      document.body.classList.add("dark");
    } else {
      document.body.classList.remove("dark");
    }
    const btn = document.getElementById("theme-toggle-btn");
    const txt = document.getElementById("theme-status");
    if (settings.theme === "dark") {
      btn.textContent = "ë¼ì´íŠ¸ ëª¨ë“œ ì „í™˜";
      txt.textContent = "í˜„ì¬: ë‹¤í¬ ëª¨ë“œ";
    } else {
      btn.textContent = "ë‹¤í¬ ëª¨ë“œ ì „í™˜";
      txt.textContent = "í˜„ì¬: ë¼ì´íŠ¸ ëª¨ë“œ";
    }
  }

  // ====== Tabs ======
  document.querySelectorAll(".tab-button").forEach((btn) => {
    btn.addEventListener("click", () => {
      const tab = btn.dataset.tab;
      document
        .querySelectorAll(".tab-button")
        .forEach((b) => b.classList.toggle("active", b === btn));
      document
        .querySelectorAll(".tab-section")
        .forEach((sec) =>
          sec.classList.toggle("active", sec.id === "section-" + tab)
        );
    });
  });

  // ====== Date helpers ======
  function todayStr() {
    const d = new Date();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const da = String(d.getDate()).padStart(2, "0");
    return `${d.getFullYear()}-${m}-${da}`;
  }
  function shiftDate(dateStr, delta) {
    const d = new Date(dateStr);
    d.setDate(d.getDate() + delta);
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const da = String(d.getDate()).padStart(2, "0");
    return `${d.getFullYear()}-${m}-${da}`;
  }

  // ====== Autocomplete lists ======
  function refreshAutocomplete() {
    const nameDL = document.getElementById("product-name-list");
    const lotDL = document.getElementById("product-lot-list");
    const printerDL = document.getElementById("product-printer-list");
    const jobProductDL = document.getElementById("job-product-list");

    nameDL.innerHTML = "";
    lotDL.innerHTML = "";
    printerDL.innerHTML = "";
    jobProductDL.innerHTML = "";

    const nameSet = new Set();
    const lotSet = new Set();
    const printerSet = new Set();

    products.forEach((p) => {
      nameSet.add(p.name);
      if (p.lot) lotSet.add(p.lot);
      if (p.printer) printerSet.add(p.printer);

      const opt = document.createElement("option");
      opt.value = `${p.name} (${p.lot || "LOTì—†ìŒ"})`;
      jobProductDL.appendChild(opt);
    });

    nameSet.forEach((n) => {
      const o = document.createElement("option");
      o.value = n;
      nameDL.appendChild(o);
    });
    lotSet.forEach((l) => {
      const o = document.createElement("option");
      o.value = l;
      lotDL.appendChild(o);
    });
    printerSet.forEach((p) => {
      const o = document.createElement("option");
      o.value = p;
      printerDL.appendChild(o);
    });
  }

  // íŠ¹ì • ì œí’ˆëª…+LOT ì¡°í•©ìœ¼ë¡œ ì œí’ˆ ì¬ê³  ì°¾ê¸°
  function findProductByNameLot(productName, lot) {
    if (!productName) return null;
    let candidates = products.filter((p) => p.name === productName);
    if (lot) {
      candidates = candidates.filter((p) => p.lot === lot);
    }
    if (candidates.length === 1) return candidates[0];

    // LOT ì•ˆ ì ì—ˆëŠ”ë° ì´ë¦„ìœ¼ë¡œ 1ê°œë§Œ ìˆìœ¼ë©´ ê·¸ê±¸ ì‚¬ìš©
    if (!lot && candidates.length === 0) {
      const byNameOnly = products.filter((p) => p.name === productName);
      if (byNameOnly.length === 1) return byNameOnly[0];
    }
    return null;
  }

  // ì‘ì—…í¼ì—ì„œ ì œí’ˆëª…/LOT ì…ë ¥ ì‹œ LOTÂ·ì¸ì‡„ì ìë™ ì±„ìš°ê¸°
  function autoFillJobFromProduct() {
    let productInput = document
      .getElementById("job-product")
      .value.trim();
    const lotInput = document
      .getElementById("job-lot")
      .value.trim();

    if (!productInput) return;
    let productName = productInput;
    if (/\(.+\)$/.test(productInput)) {
      productName = productInput.replace(/\s*\(.+$/, "");
    }

    const p = findProductByNameLot(productName, lotInput);
    if (p) {
      if (!lotInput && p.lot) {
        document.getElementById("job-lot").value = p.lot;
      }
      if (!document.getElementById("job-printer").value && p.printer) {
        document.getElementById("job-printer").value = p.printer;
      }
    }
  }

  document
    .getElementById("job-product")
    .addEventListener("change", autoFillJobFromProduct);
  document
    .getElementById("job-lot")
    .addEventListener("change", autoFillJobFromProduct);

  // ====== Product stock rendering ======
  function renderProductTable() {
    const wrap = document.getElementById("product-table-wrap");
    if (products.length === 0) {
      wrap.innerHTML =
        '<p class="small-text">ë“±ë¡ëœ ì œí’ˆ ì¬ê³ ê°€ ì•„ì§ ì—†ì–´ìš”.</p>';
      return;
    }
    const rows = products
      .slice()
      .sort((a, b) => b.createdAt - a.createdAt)
      .map((p) => {
        return `<tr>
          <td>${new Date(p.createdAt)
            .toLocaleDateString("ko-KR")
            .replace(/\./g, ".")}</td>
          <td>${p.name}</td>
          <td>${p.ea}</td>
          <td>${p.lot || "-"}</td>
          <td>${p.printer || "-"}</td>
          <td>
            <button class="chip-btn" data-act="edit-product" data-id="${p.id}">ìˆ˜ì •</button>
            <button class="chip-btn" data-act="del-product" data-id="${p.id}" style="color:#b91c1c;">ì‚­ì œ</button>
          </td>
        </tr>`;
      })
      .join("");
    wrap.innerHTML = `
      <div class="table-wrapper-inner">
        <table>
          <thead>
            <tr>
              <th>ë‚ ì§œ</th><th>ì œí’ˆëª…</th><th>EA</th><th>ë°œì‹  LOT</th><th>ì¸ì‡„ì</th><th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
    wrap
      .querySelectorAll("button[data-act]")
      .forEach((btn) =>
        btn.addEventListener("click", onProductRowAction)
      );
  }

  async function onProductRowAction(e) {
    const id = e.target.dataset.id;
    const act = e.target.dataset.act;
    const p = products.find((x) => x.id === id);
    if (!p) return;

    if (act === "edit-product") {
      if (!(await ensureAuth())) return;
      editingProductId = id;
      document.getElementById("product-name").value = p.name;
      document.getElementById("product-ea").value = p.ea;
      document.getElementById("product-lot").value = p.lot || "";
      document.getElementById("product-printer").value = p.printer || "";
      document.getElementById("product-submit-btn").textContent =
        "ì¬ê³  ìˆ˜ì • ì €ì¥";
      document.getElementById("product-cancel-edit").style.display =
        "inline-flex";
    } else if (act === "del-product") {
      if (!(await ensureAuth())) return;
      const ok = await uiConfirm("ì´ ì œí’ˆ ì¬ê³ ë¥¼ ì‚­ì œí• ê¹Œìš”?");
      if (!ok) return;
      products = products.filter((x) => x.id !== id);
      save(STORAGE_KEYS.products, products);
      editingProductId = null;
      document.getElementById("product-submit-btn").textContent =
        "ì¬ê³  ì¶”ê°€";
      document.getElementById("product-cancel-edit").style.display =
        "none";
      document.getElementById("product-form").reset();
      renderProductTable();
      refreshAutocomplete();
    }
  }

  // ====== Product form submit ======
  document
    .getElementById("product-form")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!(await ensureAuth())) return;

      const name = document
        .getElementById("product-name")
        .value.trim();
      const ea = Number(
        document.getElementById("product-ea").value
      );
      const lot = document
        .getElementById("product-lot")
        .value.trim();
      const printer = document
        .getElementById("product-printer")
        .value.trim();

      if (!name || !ea || ea <= 0) {
        await uiAlert("ì œí’ˆëª…ê³¼ ìˆ˜ëŸ‰ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        return;
      }

      if (editingProductId) {
        const p = products.find((x) => x.id === editingProductId);
        if (p) {
          p.name = name;
          p.ea = ea;
          p.lot = lot || null;
          p.printer = printer || null;
        }
      } else {
        products.push({
          id: uid(),
          name,
          ea,
          lot: lot || null,
          printer: printer || null,
          createdAt: Date.now(),
        });
      }
      save(STORAGE_KEYS.products, products);
      editingProductId = null;
      document.getElementById("product-form").reset();
      document.getElementById("product-submit-btn").textContent =
        "ì¬ê³  ì¶”ê°€";
      document.getElementById("product-cancel-edit").style.display =
        "none";
      renderProductTable();
      refreshAutocomplete();
    });

  document
    .getElementById("product-cancel-edit")
    .addEventListener("click", () => {
      editingProductId = null;
      document.getElementById("product-form").reset();
      document.getElementById("product-submit-btn").textContent =
        "ì¬ê³  ì¶”ê°€";
      document.getElementById("product-cancel-edit").style.display =
        "none";
    });

  // ====== Product CSV ======
  document
    .getElementById("product-csv-btn")
    .addEventListener("click", () => {
      if (products.length === 0) {
        uiAlert("ë‚´ë³´ë‚¼ ì œí’ˆ ì¬ê³ ê°€ ì—†ì–´ìš”.");
        return;
      }
      const header = ["ë‚ ì§œ", "ì œí’ˆëª…", "EA", "ë°œì‹ LOT", "ì¸ì‡„ì"];
      const lines = [header.join(",")];
      products.forEach((p) => {
        lines.push(
          [
            new Date(p.createdAt).toLocaleDateString("ko-KR"),
            p.name,
            p.ea,
            p.lot || "",
            p.printer || "",
          ].join(",")
        );
      });
      downloadCsv("ì œí’ˆì¬ê³ .csv", lines.join("\n"));
    });

  // ====== Job rendering ======
  function renderJobTable() {
    const wrap = document.getElementById("job-table-wrap");
    if (jobs.length === 0) {
      wrap.innerHTML =
        '<p class="small-text">ë“±ë¡ëœ ì‘ì—… ê¸°ë¡ì´ ì•„ì§ ì—†ì–´ìš”.</p>';
      return;
    }
    const filterDate =
      document.getElementById("job-filter-date").value || null;
    const rows = jobs
      .slice()
      .sort((a, b) => b.createdAt - a.createdAt)
      .filter((j) => !filterDate || j.date === filterDate)
      .map((j) => {
        return `<tr>
          <td>${j.lot || "-"}</td>
          <td>${j.date}</td>
          <td>${j.productName || "-"}</td>
          <td>${j.eaUsed ?? "-"}</td>
          <td>${j.tapeName || "-"}</td>
          <td>${j.sheets ?? "-"}</td>
          <td>${j.wasteSheets ?? 0}</td>
          <td>${j.printer || "-"}</td>
          <td>${j.memo || "-"}</td>
          <td>
            <button class="chip-btn" data-act="edit-job" data-id="${
              j.id
            }">ìˆ˜ì •</button>
            <button class="chip-btn" data-act="del-job" data-id="${
              j.id
            }" style="color:#b91c1c;">ì‚­ì œ</button>
          </td>
        </tr>`;
      })
      .join("");
    wrap.innerHTML = `
      <div class="table-wrapper-inner">
        <table>
          <thead>
            <tr>
              <th>ë°œì‹  LOT</th><th>ë‚ ì§œ</th><th>ì œí’ˆëª…</th><th>EA</th><th>í…Œì´í”„</th><th>ì‚¬ìš©ì¥ìˆ˜</th><th>ë¶ˆëŸ‰</th><th>ì¸ì‡„ì</th><th>ë©”ëª¨</th><th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
    wrap
      .querySelectorAll("button[data-act]")
      .forEach((btn) =>
        btn.addEventListener("click", onJobRowAction)
      );
  }

  function adjustProductForJob(job, sign) {
  // sign: +1 = ì‚¬ìš© ë˜ëŒë¦¬ê¸°(ì¬ê³  ëŠ˜ë¦¬ê¸°), -1 = ì‚¬ìš© ë°˜ì˜(ì¬ê³  ì¤„ì´ê¸°)
  if (!job.productId || !job.eaUsed) return;
  const p = products.find((x) => x.id === job.productId);
  if (!p) return;

  // ì¬ê³  ê³„ì‚°
  p.ea += sign * job.eaUsed;

  // ì‚¬ìš© ë°˜ì˜ì´ë¼ ì¬ê³ ê°€ 0 ì´í•˜ â†’ ì œí’ˆ ì¬ê³  ì‚­ì œ
  if (sign === -1 && p.ea <= 0) {
    products = products.filter((x) => x.id !== p.id);
  }

  // ë˜ëŒë¦´ ë•Œ ìŒìˆ˜ ë°©ì§€
  if (sign === 1 && p.ea < 0) {
    p.ea = 0;
  }
}
  async function onJobRowAction(e) {
    const id = e.target.dataset.id;
    const act = e.target.dataset.act;
    const j = jobs.find((x) => x.id === id);
    if (!j) return;

    if (act === "edit-job") {
      if (!(await ensureAuth())) return;
      editingJobId = id;
      document.getElementById("job-date").value = j.date;
      document.getElementById("job-product").value =
        j.productName || "";
      document.getElementById("job-lot").value = j.lot || "";
      document.getElementById("job-printer").value =
        j.printer || "";
      document.getElementById("job-ea").value =
        j.eaUsed ?? "";
      document.getElementById("job-tape").value =
        j.tapeId || "";
      document.getElementById("job-sheets").value =
        j.sheets ?? "";
      document.getElementById("job-waste").value =
        j.wasteSheets ?? 0;
      document.getElementById("job-memo").value = j.memo || "";
      document.getElementById("job-submit-btn").textContent =
        "ì‘ì—… ìˆ˜ì • ì €ì¥";
      document.getElementById("job-cancel-edit").style.display =
        "inline-flex";
    } else if (act === "del-job") {
      if (!(await ensureAuth())) return;
      const ok = await uiConfirm("ì´ ì‘ì—… ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?");
      if (!ok) return;

      // ì œí’ˆ ì¬ê³  ë˜ëŒë¦¬ê¸°
      adjustProductForJob(j, +1);
      save(STORAGE_KEYS.products, products);
      renderProductTable();
      refreshAutocomplete();

      jobs = jobs.filter((x) => x.id !== id);
      save(STORAGE_KEYS.jobs, jobs);
      editingJobId = null;
      document.getElementById("job-form").reset();
      document.getElementById("job-submit-btn").textContent =
        "ì‘ì—… ì €ì¥";
      document.getElementById("job-cancel-edit").style.display =
        "none";
      renderJobTable();
      renderTapeStockTable();
      renderTapeHistoryTable();
    }
  }

  // ====== Job form submit ======
  document
    .getElementById("job-form")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!(await ensureAuth())) return;

      const date =
        document.getElementById("job-date").value || todayStr();
      let productInput = document
        .getElementById("job-product")
        .value.trim();
      const lot = document
        .getElementById("job-lot")
        .value.trim();
      const printerInput = document
        .getElementById("job-printer")
        .value.trim();
      const eaRaw = document.getElementById("job-ea").value;
      const tapeId =
        document.getElementById("job-tape").value || null;
      const sheetsRaw =
        document.getElementById("job-sheets").value;
      const waste =
        Number(document.getElementById("job-waste").value) || 0;
      const memo = document
        .getElementById("job-memo")
        .value.trim();

      // product parsing
      let productName = productInput;
      if (/\(.+\)$/.test(productInput)) {
        productName = productInput.replace(/\s*\(.+$/, "");
      }

      let ea = eaRaw ? Number(eaRaw) : null;
      let sheets = sheetsRaw ? Number(sheetsRaw) : null;

      // find tape info
      const tape = tapes.find((t) => t.id === tapeId) || null;

      // find matching product stock entry
      const productObj = findProductByNameLot(productName, lot);
      let productId = productObj ? productObj.id : null;

      // EA/ì¥ìˆ˜ ìë™ ê³„ì‚°
      if (!ea && !sheets) {
        if (productObj && productObj.ea) {
          ea = productObj.ea;
          if (tape && tape.eaPerSheet) {
            sheets = Math.ceil(ea / tape.eaPerSheet);
          }
        } else {
          await uiAlert(
            "EA/í…Œì´í”„ ì¥ìˆ˜ë¥¼ ë‘˜ ë‹¤ ë¹„ì›Œë‘ë ¤ë©´, ì œí’ˆ ì¬ê³ ì— ë“±ë¡ëœ ì œí’ˆëª…+LOTë¥¼ ì„ íƒí•´ì•¼ í•´ìš”.\n\nì•„ë‹ˆë©´ EAë‚˜ í…Œì´í”„ ì¥ìˆ˜ ì¤‘ í•˜ë‚˜ëŠ” ì§ì ‘ ì…ë ¥í•´ ì£¼ì„¸ìš”."
          );
          return;
        }
      }

      if (!ea && sheets && tape && tape.eaPerSheet) {
        ea = sheets * tape.eaPerSheet;
      }
      if (!sheets && ea && tape && tape.eaPerSheet) {
        sheets = Math.ceil(ea / tape.eaPerSheet);
      }

      if (!ea && !sheets) {
        await uiAlert("EA/ì¥ìˆ˜ ê³„ì‚°ì— í•„ìš”í•œ ì •ë³´ê°€ ë¶€ì¡±í•´ìš”.");
        return;
      }

      // editingì´ë©´ ì´ì „ ì‘ì—… ë˜ëŒë¦¬ê¸°
      if (editingJobId) {
        const old = jobs.find((x) => x.id === editingJobId);
        if (old) {
          adjustProductForJob(old, +1);
        }
      }

      // apply new usage to product
      if (productId && ea) {
        const p = products.find((x) => x.id === productId);
        if (p) {
          p.ea -= ea;
          if (p.ea <= 0) {
            products = products.filter((x) => x.id !== p.id);
          }
        }
      }

      const finalLot = lot || (productObj ? productObj.lot : null);
      const finalPrinter =
        printerInput || (productObj ? productObj.printer : null);

      const existing = editingJobId
        ? jobs.find((x) => x.id === editingJobId)
        : null
      const jobObj = {
        id: editingJobId || uid(),
        date,
        productId,
        productName: productName || null,
        lot: finalLot || null,
        printer: finalPrinter || null,
        eaUsed: ea || null,
        tapeId,
        tapeName: tape ? tape.name : null,
        sheets: sheets || null,
        wasteSheets: waste || 0,
        memo: memo || null,
        createdAt: existing ? existing.createdAt : Date.now(),
      };

      if (editingJobId) {
        jobs = jobs.map((j) => (j.id === jobObj.id ? jobObj : j));
      } else {
        jobs.push(jobObj);
      }

      save(STORAGE_KEYS.jobs, jobs);
      save(STORAGE_KEYS.products, products);

      editingJobId = null;
      document.getElementById("job-form").reset();
      document.getElementById("job-date").value = date;
      document.getElementById("job-submit-btn").textContent =
        "ì‘ì—… ì €ì¥";
      document.getElementById("job-cancel-edit").style.display =
        "none";

      renderProductTable();
      refreshAutocomplete();
      renderJobTable();
      renderTapeStockTable();
      renderTapeHistoryTable();
    });

  document
    .getElementById("job-cancel-edit")
    .addEventListener("click", () => {
      editingJobId = null;
      document.getElementById("job-form").reset();
      document.getElementById("job-submit-btn").textContent =
        "ì‘ì—… ì €ì¥";
      document.getElementById("job-cancel-edit").style.display =
        "none";
    });

  document
    .getElementById("job-filter-date")
    .addEventListener("change", renderJobTable);

  // ====== Tape settings ======
  function renderTapeTable() {
    const wrap = document.getElementById("tape-table-wrap");
    if (tapes.length === 0) {
      wrap.innerHTML =
        '<p class="small-text">ë“±ë¡ëœ í…Œì´í”„ê°€ ì•„ì§ ì—†ì–´ìš”.</p>';
      return;
    }
    const rows = tapes
      .map((t, idx) => {
        return `<tr>
          <td>${t.name}</td>
          <td>${t.eaPerSheet}</td>
          <td>${t.source}</td>
          <td>
            <button class="chip-btn" data-act="up-tape" data-id="${t.id}">â–²</button>
            <button class="chip-btn" data-act="down-tape" data-id="${t.id}">â–¼</button>
            <button class="chip-btn" data-act="edit-tape" data-id="${t.id}">ìˆ˜ì •</button>
            <button class="chip-btn" data-act="del-tape" data-id="${t.id}" style="color:#b91c1c;">ì‚­ì œ</button>
          </td>
        </tr>`;
      })
      .join("");
    wrap.innerHTML = `
      <div class="table-wrapper-inner">
        <table>
          <thead>
            <tr><th>í…Œì´í”„ëª…</th><th>EA/ì¥</th><th>ì¶œì²˜</th><th>ê´€ë¦¬</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
    wrap
      .querySelectorAll("button[data-act]")
      .forEach((btn) =>
        btn.addEventListener("click", onTapeRowAction)
      );
    refreshTapeSelects();
  }

  async function onTapeRowAction(e) {
    const id = e.target.dataset.id;
    const act = e.target.dataset.act;
    const idx = tapes.findIndex((x) => x.id === id);
    const t = tapes[idx];
    if (!t) return;

    if (act === "up-tape" || act === "down-tape") {
      const newIdx = act === "up-tape" ? idx - 1 : idx + 1;
      if (newIdx < 0 || newIdx >= tapes.length) return;
      const [item] = tapes.splice(idx, 1);
      tapes.splice(newIdx, 0, item);
      save(STORAGE_KEYS.tapes, tapes);
      renderTapeTable();
      renderTapeStockTable();
      renderTapeHistoryTable();
      return;
    }

    if (act === "edit-tape") {
      if (!(await ensureAuth())) return;
      editingTapeId = id;
      document.getElementById("tape-name").value = t.name;
      document.getElementById("tape-ea-per-sheet").value =
        t.eaPerSheet;
      document.getElementById("tape-source").value = t.source;
      document.getElementById("tape-submit-btn").textContent =
        "í…Œì´í”„ ìˆ˜ì • ì €ì¥";
      document.getElementById("tape-cancel-edit").style.display =
        "inline-flex";
    } else if (act === "del-tape") {
      if (!(await ensureAuth())) return;
      const ok = await uiConfirm(
        "ì´ í…Œì´í”„ ì„¤ì •ì„ ì‚­ì œí• ê¹Œìš”?\n(ê¸°ì¡´ ì‘ì—… ê¸°ë¡ì˜ ì´ë¦„ë§Œ ë‚¨ê³  ê³„ì‚°ì—ëŠ” ì˜í–¥ ì—†ì–´ìš”)"
      );
      if (!ok) return;
      tapes = tapes.filter((x) => x.id !== id);
      save(STORAGE_KEYS.tapes, tapes);
      editingTapeId = null;
      document.getElementById("tape-form").reset();
      document.getElementById("tape-submit-btn").textContent =
        "í…Œì´í”„ ì¶”ê°€";
      document.getElementById("tape-cancel-edit").style.display =
        "none";
      renderTapeTable();
      renderTapeStockTable();
      renderTapeHistoryTable();
    }
  }

  document
    .getElementById("tape-form")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!(await ensureAuth())) return;
      const name = document
        .getElementById("tape-name")
        .value.trim();
      const eaPerSheet = Number(
        document.getElementById("tape-ea-per-sheet").value
      );
      const source = document.getElementById("tape-source").value;
      if (!name || !eaPerSheet) {
        await uiAlert("í…Œì´í”„ëª…ê³¼ EA/ì¥ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        return;
      }
      if (editingTapeId) {
        const t = tapes.find((x) => x.id === editingTapeId);
        if (t) {
          t.name = name;
          t.eaPerSheet = eaPerSheet;
          t.source = source;
        }
      } else {
        tapes.push({
          id: uid(),
          name,
          eaPerSheet,
          source,
        });
      }
      save(STORAGE_KEYS.tapes, tapes);
      editingTapeId = null;
      document.getElementById("tape-form").reset();
      document.getElementById("tape-submit-btn").textContent =
        "í…Œì´í”„ ì¶”ê°€";
      document.getElementById("tape-cancel-edit").style.display =
        "none";
      renderTapeTable();
      renderTapeStockTable();
      renderTapeHistoryTable();
    });

  document
    .getElementById("tape-cancel-edit")
    .addEventListener("click", () => {
      editingTapeId = null;
      document.getElementById("tape-form").reset();
      document.getElementById("tape-submit-btn").textContent =
        "í…Œì´í”„ ì¶”ê°€";
      document.getElementById("tape-cancel-edit").style.display =
        "none";
    });

  function refreshTapeSelects() {
    const sel1 = document.getElementById("job-tape");
    const sel2 = document.getElementById("tape-in-tape");
    const makeOptions = () =>
      ['<option value="">í…Œì´í”„ ì„ íƒ</option>'].concat(
        tapes.map(
          (t) =>
            `<option value="${t.id}">${t.name} (${t.source})</option>`
        )
      );
    sel1.innerHTML = makeOptions().join("");
    sel2.innerHTML = makeOptions().join("");
  }

  // ====== Tape ì…ê³  ======
  document
    .getElementById("tape-in-form")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!(await ensureAuth())) return;
      const date =
        document.getElementById("tape-in-date").value ||
        todayStr();
      const tapeId =
        document.getElementById("tape-in-tape").value;
      const qty = Number(
        document.getElementById("tape-in-qty").value
      );
      const memo = document
        .getElementById("tape-in-memo")
        .value.trim();
      if (!tapeId || !qty) {
        await uiAlert("í…Œì´í”„ì™€ ì…ê³  ì¥ìˆ˜ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        return;
      }
      tapeInLogs.push({
        id: uid(),
        date,
        tapeId,
        qty,
        memo: memo || null,
        createdAt: Date.now(),
      });
      save(STORAGE_KEYS.tapeInLogs, tapeInLogs);
      document.getElementById("tape-in-form").reset();
      document.getElementById("tape-in-date").value = date;
      renderTapeStockTable();
      renderTapeHistoryTable();
    });

  // ====== Tape stock rendering (í˜„ì¬) ======
  function calcTapeSnapshot(tapeId, dateLimit) {
    const inQty = tapeInLogs
      .filter((l) => l.tapeId === tapeId && (!dateLimit || l.date <= dateLimit))
      .reduce((sum, l) => sum + l.qty, 0);
    const usedSheets = jobs
      .filter((j) => j.tapeId === tapeId && j.sheets && (!dateLimit || j.date <= dateLimit))
      .reduce((sum, j) => sum + j.sheets, 0);
    const wasteSheets = jobs
      .filter((j) => j.tapeId === tapeId && j.wasteSheets && (!dateLimit || j.date <= dateLimit))
      .reduce((sum, j) => sum + j.wasteSheets, 0);
    const adj = tapeAdjust[tapeId] || 0; // ì¡°ì •ì€ ë‚ ì§œ êµ¬ë¶„ ì—†ì´ ì „ì²´ì— ë°˜ì˜
    const current = inQty - usedSheets - wasteSheets + adj;
    return { inQty, usedSheets, wasteSheets, current };
  }

  function renderTapeStockTable() {
    const wrap = document.getElementById("tape-stock-table-wrap");
    if (tapes.length === 0) {
      wrap.innerHTML =
        '<p class="small-text">ë¨¼ì € í…Œì´í”„ ì„¤ì •ì—ì„œ í…Œì´í”„ë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</p>';
      return;
    }

    const rows = tapes.map((t) => {
      const snap = calcTapeSnapshot(t.id, null);
      return `<tr>
        <td>${t.name}</td>
        <td>${t.source}</td>
        <td>${snap.inQty}</td>
        <td>${snap.usedSheets}</td>
        <td>${snap.wasteSheets}</td>
        <td>${snap.current}</td>
        <td>
          <button class="chip-btn" data-act="adjust-stock" data-id="${
            t.id
          }">ì”ëŸ‰ ìˆ˜ì •</button>
        </td>
      </tr>`;
    });

    wrap.innerHTML = `
      <div class="table-wrapper-inner">
        <table>
          <thead>
            <tr>
              <th>í…Œì´í”„ëª…</th><th>ì¶œì²˜</th><th>ì…ê³ ì¥ìˆ˜</th><th>ì‚¬ìš©ì¥ìˆ˜</th><th>ë¶ˆëŸ‰</th><th>í˜„ì¬ì”ëŸ‰</th><th>ì¡°ì •</th>
            </tr>
          </thead>
          <tbody>${rows.join("")}</tbody>
        </table>
      </div>
    `;

    wrap
      .querySelectorAll("button[data-act='adjust-stock']")
      .forEach((btn) =>
        btn.addEventListener("click", onAdjustStockClick)
      );
  }

  async function onAdjustStockClick(e) {
    if (!(await ensureAuth())) return;
    const tapeId = e.target.dataset.id;
    const t = tapes.find((x) => x.id === tapeId);
    if (!t) return;

    const snap = calcTapeSnapshot(t.id, null);
    const autoCurrent = snap.current;

    const input = await openDialog({
      title: `${t.name} ì”ëŸ‰ ìˆ˜ì •`,
      message: `ì‹¤ì œ ë‚¨ì•„ ìˆëŠ” ì¥ìˆ˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.<br/><span style="font-size:11px;color:var(--text-sub)">í˜„ì¬ ê³„ì‚°ê°’: ${autoCurrent}ì¥</span>`,
      placeholder: String(autoCurrent),
      type: "number",
      okText: "ì €ì¥",
      cancelText: "ì·¨ì†Œ",
      showInput: true,
    });
    if (input === null) return;
    const real = Number(input);
    if (Number.isNaN(real)) {
      await uiAlert("ìˆ«ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
      return;
    }
    const diff = real - autoCurrent;
    tapeAdjust[t.id] = (tapeAdjust[t.id] || 0) + diff;
    save(STORAGE_KEYS.tapeAdjust, tapeAdjust);
    renderTapeStockTable();
    renderTapeHistoryTable();
  }

  // ====== Tape CSV ======
  document
    .getElementById("tape-stock-csv-btn")
    .addEventListener("click", () => {
      if (tapes.length === 0) {
        uiAlert("ë‚´ë³´ë‚¼ í…Œì´í”„ ì¬ê³ ê°€ ì—†ì–´ìš”.");
        return;
      }
      const header = [
        "í…Œì´í”„ëª…",
        "ì¶œì²˜",
        "ì…ê³ ì¥ìˆ˜",
        "ì‚¬ìš©ì¥ìˆ˜",
        "ë¶ˆëŸ‰",
        "í˜„ì¬ì”ëŸ‰",
      ];
      const lines = [header.join(",")];
      tapes.forEach((t) => {
        const snap = calcTapeSnapshot(t.id, null);
        lines.push(
          [
            t.name,
            t.source,
            snap.inQty,
            snap.usedSheets,
            snap.wasteSheets,
            snap.current,
          ].join(",")
        );
      });
      downloadCsv("í…Œì´í”„ì¬ê³ .csv", lines.join("\n"));
    });

// ====== ë‚ ì§œë³„ í…Œì´í”„ ì¬ê³ í‘œ ======
function renderTapeHistoryTable() {
  const wrap = document.getElementById("tape-history-table-wrap");
  if (!wrap) return;

  if (tapes.length === 0) {
    wrap.innerHTML =
      '<p class="small-text">ë¨¼ì € í…Œì´í”„ ì„¤ì •ê³¼ ì…ê³  ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>';
    return;
  }

  const date = document.getElementById("hist-date").value || todayStr();

  const rows = tapes.map((t) => {
    const snap = calcTapeSnapshot(t.id, date); // { inQty, usedSheets, wasteSheets, current }
    return `
      <tr>
        <td>${t.name}</td>
        <td>${snap.current}</td>
        <td>${t.source}</td>
        <td>${snap.inQty}</td>
        <td>${snap.usedSheets}</td>
        <td>${snap.wasteSheets}</td>
      </tr>
    `;
  }).join("");

  wrap.innerHTML = `
    <div class="table-wrapper-inner">
      <table>
        <thead>
          <tr>
            <th>í…Œì´í”„ëª…</th>
            <th>${date} ê¸°ì¤€ ì”ëŸ‰</th>
            <th>ì¶œì²˜</th>
            <th>ì…ê³ ì¥ìˆ˜(ëˆ„ì )</th>
            <th>ì‚¬ìš©ì¥ìˆ˜(ëˆ„ì )</th>
            <th>ë¶ˆëŸ‰(ëˆ„ì )</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

  document
    .getElementById("hist-date")
    .addEventListener("change", renderTapeHistoryTable);
  document
    .getElementById("hist-prev-day")
    .addEventListener("click", () => {
      const input = document.getElementById("hist-date");
      input.value = shiftDate(input.value || todayStr(), -1);
      renderTapeHistoryTable();
    });
  document
    .getElementById("hist-next-day")
    .addEventListener("click", () => {
      const input = document.getElementById("hist-date");
      input.value = shiftDate(input.value || todayStr(), +1);
      renderTapeHistoryTable();
    });

  // ====== CSV download helper ======
  function downloadCsv(filename, text) {
    const blob = new Blob([text], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ====== Settings: theme & password ======
  document
    .getElementById("theme-toggle-btn")
    .addEventListener("click", () => {
      settings.theme = settings.theme === "dark" ? "light" : "dark";
      save(STORAGE_KEYS.settings, settings);
      applyTheme();
    });

  document
    .getElementById("password-form")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const cur = document.getElementById("password-current").value;
      const next = document.getElementById("password-new").value;
      if (settings.password && cur !== settings.password) {
        await uiAlert("í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•Šì•„ìš”.");
        return;
      }
      settings.password = next || null;
      save(STORAGE_KEYS.settings, settings);
      document.getElementById("password-current").value = "";
      document.getElementById("password-new").value = "";
      if (settings.password) {
        await uiAlert("ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } else {
        await uiAlert("ë¹„ë°€ë²ˆí˜¸ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }
    });

  document
    .getElementById("password-clear-btn")
    .addEventListener("click", async () => {
      if (!settings.password) {
        await uiAlert("ì„¤ì •ëœ ë¹„ë°€ë²ˆí˜¸ê°€ ì—†ì–´ìš”.");
        return;
      }
      const ok = await uiConfirm("ë¹„ë°€ë²ˆí˜¸ë¥¼ í•´ì œí• ê¹Œìš”?");
      if (!ok) return;
      settings.password = null;
      save(STORAGE_KEYS.settings, settings);
      await uiAlert("ë¹„ë°€ë²ˆí˜¸ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    });

  // ====== Initial boot ======
  async function init() {
    document.getElementById("job-date").value = todayStr();
    document.getElementById("job-filter-date").value = todayStr();
    document.getElementById("tape-in-date").value = todayStr();
    document.getElementById("hist-date").value = todayStr();

    applyTheme();
    renderTapeTable();
    renderProductTable();
    refreshAutocomplete();
    renderJobTable();
    renderTapeStockTable();
    renderTapeHistoryTable();

    // ì•± ì²˜ìŒ ì—´ ë•Œ ì ê¸ˆ í™”ë©´
    if (settings.password && !sessionStorage.getItem("tf_authed")) {
      const ok = await ensureAuth();
      if (!ok) {
        await uiAlert(
          "ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”.\n(ì¡°íšŒëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ, ìˆ˜ì •/ì‚­ì œ/ì…ê³  ë“±ë¡ ë“±ì€ ë§‰í˜€ìš”.)"
        );
      }
    }
  }

  init();
</script>
</body>
</html>
