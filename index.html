<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tape Flow</title>

<style>
*{
  box-sizing:border-box;
}

body{
  font-family: Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  margin:0;
  padding:0;
  background:linear-gradient(180deg,#e4f1ff,#f5f7ff);
}

/* ì „ì²´ ë ˆì´ì•„ì›ƒ ë°•ìŠ¤ â€“ ê°€ìš´ë° ì •ë ¬ + ì¢Œìš° ì—¬ë°± */
.app-root{
  max-width:900px;
  margin:0 auto 40px;
  padding:16px 16px 40px;
}

/* íƒ€ì´í‹€ */
.app-title{
  font-size:28px;
  font-weight:800;
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 4px 18px;
  color:#1f2d5f;
}
.app-title span{
  font-size:30px;
}

/* ìƒë‹¨ ë„¤ë¹„ */
.nav{
  display:flex;
  gap:10px;
  padding:4px 0 18px;
  overflow-x:auto;
}
.nav button{
  flex:1;
  min-width:0;
  padding:10px 14px;
  border:none;
  border-radius:999px;
  background:rgba(255,255,255,0.7);
  color:#44506b;
  font-size:14px;
  font-weight:600;
  box-shadow:0 4px 12px rgba(77,105,255,0.08);
  white-space:nowrap;
}
.nav button.active{
  background:linear-gradient(135deg,#7ea6ff,#4f63ff);
  color:#fff;
}

/* í˜ì´ì§€ ê³µí†µ */
.page{
  display:none;
  padding-top:4px;
}
.page.active{
  display:block;
}

/* ë¼ë²¨/ì…ë ¥ */
label{
  font-size:13px;
  color:#48536b;
  display:block;
  margin-top:10px;
  margin-bottom:2px;
}

input, select{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #d3dbff;
  background:#ffffffcc;
  font-size:14px;
  outline:none;
}
input:focus, select:focus{
  border-color:#6d81ff;
  box-shadow:0 0 0 2px rgba(109,129,255,0.18);
}

/* ë©”ì¸ ë²„íŠ¼ */
button.add{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:10px 18px;
  margin-top:14px;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#7ea6ff,#4f63ff);
  color:#fff;
  font-size:14px;
  font-weight:600;
  box-shadow:0 6px 16px rgba(79,99,255,0.3);
}

/* ì‘ì€ ë²„íŠ¼ */
button.small{
  border:none;
  border-radius:999px;
  padding:6px 10px;
  font-size:11px;
  font-weight:500;
  background:#e4ebff;
  color:#425085;
  margin-top:4px;
  margin-right:4px;
}

/* ì¹´ë“œ/ë°•ìŠ¤ */
.table-box{
  width:100%;
  background:#ffffff;
  border-radius:18px;
  padding:10px;
  margin-top:16px;
  box-shadow:0 10px 25px rgba(71,93,255,0.08);
}

/* í‘œ */
table{
  width:100%;
  border-collapse:collapse;
}
th, td{
  padding:7px 4px;
  font-size:12px;
  text-align:left;
  border-bottom:1px solid #f0f2ff;
}
th{
  color:#4d5780;
  font-weight:600;
}

/* ì”ëŸ‰ ì¹´ë“œ */
.summary-card{
  background:#ffffff;
  border-radius:18px;
  padding:12px 14px;
  margin-bottom:12px;
  box-shadow:0 10px 25px rgba(71,93,255,0.1);
  font-size:13px;
  color:#2f385a;
}
.summary-card b{
  font-size:14px;
}
.summary-card input{
  margin-top:4px;
  margin-bottom:4px;
}

/* ì•ˆë‚´ í…ìŠ¤íŠ¸ */
.info-text{
  font-size:11px;
  color:#7b86aa;
  margin-top:4px;
}

/* ì‘ì€ ì œëª© ëŠë‚Œ */
.section-title{
  font-size:14px;
  font-weight:600;
  color:#2c355a;
  margin-top:4px;
  margin-bottom:6px;
}
</style>
</head>

<body>
<div class="app-root">

  <div class="app-title">
    <span>ğŸ“¦</span> TAPE FLOW
  </div>

  <div class="nav">
    <button id="nav-tape" class="active">í…Œì´í”„ ì„¤ì •</button>
    <button id="nav-stock">ì‘ì—…ì „ ì¬ê³ </button>
    <button id="nav-work">ì‘ì—… ë“±ë¡</button>
    <button id="nav-summary">ì”ëŸ‰</button>
  </div>

  <!-- ================= í…Œì´í”„ ì„¤ì • ================= -->
  <div class="page active" id="page-tape">
    <div class="section-title">í…Œì´í”„ ê¸°ë³¸ ì •ë³´</div>

    <label>í…Œì´í”„ëª…</label>
    <input id="tapeName" placeholder="ì˜ˆ: 6855, 6491">

    <label>EA(ì œí’ˆ ìˆ˜ëŸ‰) / 1ì¥ë‹¹</label>
    <input id="eaPerSheet" placeholder="ì˜ˆ: 6">

    <label>ì¶œì²˜</label>
    <select id="tapeSource">
      <option value="ê°€ê³µì‹¤">ê°€ê³µì‹¤</option>
      <option value="íƒœì„±">íƒœì„±</option>
    </select>

    <button class="add" onclick="addTape()">í…Œì´í”„ ì¶”ê°€</button>

    <div id="tapeList" class="table-box"></div>
  </div>

  <!-- ================= ì‘ì—…ì „ ì¬ê³  ================= -->
  <div class="page" id="page-stock">
    <div class="section-title">ì‘ì—…ì „ ì œí’ˆ ì¬ê³ </div>

    <label>ì œí’ˆëª…</label>
    <input id="stockName" placeholder="ì˜ˆ: 7125J">

    <label>ìˆ˜ëŸ‰(EA)</label>
    <input id="stockEa" type="number" placeholder="ì˜ˆ: 2520">

    <label>ì„¸íŠ¸ / LOT ë©”ëª¨</label>
    <input id="stockLot" placeholder="ì˜ˆ: LOT123 / ì„¸íŠ¸1">

    <button class="add" onclick="addStock()">ì¬ê³  ì¶”ê°€</button>

    <div id="stockList" class="table-box"></div>

    <button class="add" style="margin-top:12px;" onclick="downloadStockCsv()">ì¬ê³  CSV ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <!-- ================= ì‘ì—… ë“±ë¡ ================= -->
  <div class="page" id="page-work">
    <div class="section-title">ì˜¤ëŠ˜ ì‘ì—… ë“±ë¡</div>

    <label>ì‘ì—… ë‚ ì§œ</label>
    <input id="workDate" type="date">

    <label>ì œí’ˆëª…</label>
    <input id="workName" placeholder="ì˜ˆ: 7125J 2520EA ì„¸íŠ¸1">

    <label>ì‚¬ìš© í…Œì´í”„</label>
    <select id="workTape"></select>

    <label>ì‚¬ìš© EA (ê°œìˆ˜)</label>
    <input id="workEa" type="number" placeholder="ì…ë ¥ ì‹œ í…Œì´í”„ ì¥ìˆ˜ ìë™ ê³„ì‚°">

    <label>í…Œì´í”„ ì¥ìˆ˜ (ì†Œìš”ëŸ‰)</label>
    <input id="workSheets" type="number" placeholder="ì…ë ¥ ì‹œ EA ìë™ ê³„ì‚°">

    <label>ë¶ˆëŸ‰(ì¥)</label>
    <input id="workBad" type="number" value="0">

    <button class="add" onclick="addWork()">ì‘ì—… ë“±ë¡</button>

    <div id="workList" class="table-box"></div>

    <button class="add" style="margin-top:12px;" onclick="downloadWorkCsv()">ì‘ì—… ë‚´ì—­ CSV ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <!-- ================= ì”ëŸ‰ / ì…ê³  / ìˆ˜ì • ================= -->
  <div class="page" id="page-summary">
    <div class="section-title">í…Œì´í”„ ì”ëŸ‰ & ì…ê³  ê¸°ë¡</div>
    <div class="info-text">
      â€¢ ì…ê³  ì¥ìˆ˜ = ê°€ê³µì‹¤/íƒœì„±ì—ì„œ ì˜¬ë ¤ì¤€ í…Œì´í”„ ì¥ìˆ˜ ê¸°ë¡<br>
      â€¢ í˜„ì¬ ì”ëŸ‰ = ì…ê³  í•©ê³„ âˆ’ (ì†Œìš” ì¥ìˆ˜ + ë¶ˆëŸ‰ ì¥ìˆ˜)<br>
      â€¢ ì‹¤ì œë‘ ë‹¤ë¥¼ ë•ŒëŠ” ì”ëŸ‰ ìˆ˜ì •ìœ¼ë¡œ ì§ì ‘ ë§ì¶œ ìˆ˜ ìˆì–´.
    </div>

    <div id="summaryArea" style="margin-top:10px;"></div>
  </div>

</div>

<script>
/* ===== ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ (ì´ë¦„ë§Œ Tape Flowë¡œ ë°”ë€œ) ===== */
let tapes = JSON.parse(localStorage.getItem("tapes") || "[]");
let stocks = JSON.parse(localStorage.getItem("stocks") || "[]");
let works = JSON.parse(localStorage.getItem("works") || "[]");
let tapeInbound = JSON.parse(localStorage.getItem("tapeInbound") || "[]");

function save(){
  localStorage.setItem("tapes", JSON.stringify(tapes));
  localStorage.setItem("stocks", JSON.stringify(stocks));
  localStorage.setItem("works", JSON.stringify(works));
  localStorage.setItem("tapeInbound", JSON.stringify(tapeInbound));
}

function openPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.getElementById("page-"+id).classList.add("active");

  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
  document.getElementById("nav-"+id).classList.add("active");

  if(id==="summary") renderSummary();
  if(id==="work") refreshWorkTapeList();
}

document.getElementById("nav-tape").addEventListener("click",()=>openPage("tape"));
document.getElementById("nav-stock").addEventListener("click",()=>openPage("stock"));
document.getElementById("nav-work").addEventListener("click",()=>openPage("work"));
document.getElementById("nav-summary").addEventListener("click",()=>openPage("summary"));

/* ---- í…Œì´í”„ ì„¤ì • ---- */
function addTape(){
  let name = tapeName.value.trim();
  let ea = Number(eaPerSheet.value);
  let src = tapeSource.value;

  if(!name || !ea){
    alert("í…Œì´í”„ëª…ê³¼ EA/ì¥ ê°’ì„ ì…ë ¥í•´ì¤˜!");
    return;
  }
  tapes.push({name, ea, src, manualRemain:null});
  save();
  renderTapeList();
  refreshWorkTapeList();
  tapeName.value="";
  eaPerSheet.value="";
}

function renderTapeList(){
  if(tapes.length===0){
    tapeList.innerHTML = "<div class='info-text'>ë“±ë¡ëœ í…Œì´í”„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    return;
  }
  let html = `<table><tr><th>í…Œì´í”„</th><th>EA/ì¥</th><th>ì¶œì²˜</th></tr>`;
  tapes.forEach(t=>{
    html += `<tr><td>${t.name}</td><td>${t.ea}</td><td>${t.src}</td></tr>`;
  });
  html += `</table>`;
  tapeList.innerHTML = html;
}
renderTapeList();

function refreshWorkTapeList(){
  if(tapes.length===0){
    workTape.innerHTML = "<option value=''>í…Œì´í”„ ì—†ìŒ</option>";
    return;
  }
  workTape.innerHTML = tapes.map(t=>`<option value="${t.name}">${t.name}</option>`).join("");
}

/* ---- ì‘ì—…ì „ ì¬ê³  ---- */
function addStock(){
  let name = stockName.value.trim();
  let ea = Number(stockEa.value);
  let lot = stockLot.value.trim();
  let date = new Date().toISOString().slice(0,10);

  if(!name || !ea){
    alert("ì œí’ˆëª…ê³¼ ìˆ˜ëŸ‰(EA)ì„ ì…ë ¥í•´ì¤˜!");
    return;
  }
  stocks.push({name, ea, lot, date});
  save();
  renderStockList();
  stockName.value="";
  stockEa.value="";
  stockLot.value="";
}

function renderStockList(){
  if(stocks.length===0){
    stockList.innerHTML = "<div class='info-text'>ë“±ë¡ëœ ì‘ì—…ì „ ì¬ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    return;
  }
  let html = `<table><tr><th>ë‚ ì§œ</th><th>ì œí’ˆëª…</th><th>EA</th><th>ì„¸íŠ¸/LOT</th></tr>`;
  stocks.forEach(s=>{
    html+=`<tr>
      <td>${s.date||""}</td>
      <td>${s.name}</td>
      <td>${s.ea}</td>
      <td>${s.lot}</td>
    </tr>`;
  });
  html+=`</table>`;
  stockList.innerHTML = html;
}
renderStockList();

/* ---- ì‘ì—… ë“±ë¡ ---- */
function addWork(){
  let name = workName.value.trim();
  let tape = workTape.value;
  let ea = Number(workEa.value);
  let sheet = Number(workSheets.value);
  let bad = Number(workBad.value || 0);
  let date = workDate.value || new Date().toISOString().slice(0,10);

  if(!name || !tape){
    alert("ì œí’ˆëª…ê³¼ í…Œì´í”„ë¥¼ ì„ íƒí•´ì¤˜!");
    return;
  }
  let tapeObj = tapes.find(t=>t.name===tape);
  if(!tapeObj){
    alert("í…Œì´í”„ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  if(ea && !sheet){
    sheet = Math.ceil(ea / tapeObj.ea);
  }else if(sheet && !ea){
    ea = sheet * tapeObj.ea;
  }
  if(!ea || !sheet){
    alert("EA ë˜ëŠ” í…Œì´í”„ ì¥ìˆ˜ ì¤‘ í•˜ë‚˜ëŠ” ë°˜ë“œì‹œ ì…ë ¥í•´ì•¼ í•´!");
    return;
  }

  works.push({name, tape, ea, sheet, bad, date});
  save();
  renderWorkList();
  renderSummary();
  workName.value="";
  workEa.value="";
  workSheets.value="";
  workBad.value="0";
}

function renderWorkList(){
  if(works.length===0){
    workList.innerHTML = "<div class='info-text'>ë“±ë¡ëœ ì‘ì—… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
    return;
  }
  let html = `<table><tr><th>ë‚ ì§œ</th><th>ì œí’ˆëª…</th><th>í…Œì´í”„</th><th>EA</th><th>ì†Œìš”ì¥ìˆ˜</th><th>ë¶ˆëŸ‰ì¥ìˆ˜</th></tr>`;
  works.forEach(w=>{
    html+=`<tr>
      <td>${w.date || ""}</td>
      <td>${w.name}</td>
      <td>${w.tape}</td>
      <td>${w.ea}</td>
      <td>${w.sheet}</td>
      <td>${w.bad}</td>
    </tr>`;
  });
  html+=`</table>`;
  workList.innerHTML = html;
}
renderWorkList();

/* ---- ì”ëŸ‰ / ì…ê³  / ìˆ˜ì • ---- */
function renderSummary(){
  if(tapes.length===0){
    summaryArea.innerHTML = "<div class='info-text'>ë¨¼ì € í…Œì´í”„ë¥¼ ë“±ë¡í•´ì¤˜.</div>";
    return;
  }
  let area = "";
  tapes.forEach((t,idx)=>{
    let inbound = 0;
    tapeInbound.forEach(e=>{
      if(e.tape === t.name) inbound += Number(e.sheets)||0;
    });

    let used = 0;
    let bad = 0;
    works.forEach(w=>{
      if(w.tape === t.name){
        used += Number(w.sheet)||0;
        bad  += Number(w.bad)||0;
      }
    });

    let autoRemain = inbound - used - bad;
    let manual = (typeof t.manualRemain === "number" && !Number.isNaN(t.manualRemain));
    let remain = manual ? t.manualRemain : autoRemain;

    area += `
      <div class="summary-card">
        <b>${t.name}</b> <span style="font-size:12px;color:#7b86aa;">(${t.src})</span><br>
        â€¢ ì…ê³  í•©ê³„: <b>${inbound}</b> ì¥<br>
        â€¢ ì‚¬ìš©(ì†Œìš”+ë¶ˆëŸ‰): <b>${used+bad}</b> ì¥ (ì†Œìš” ${used}, ë¶ˆëŸ‰ ${bad})<br>
        â€¢ í˜„ì¬ ì”ëŸ‰: <b>${remain}</b> ì¥ ${manual ? "<span style='color:#e05;'>[ìˆ˜ë™]</span>" : "<span style='color:#3aa36d;'>[ìë™]</span>"}<br><br>

        <div style="margin-bottom:6px;">
          <div style="font-size:12px;margin-bottom:2px;">ì…ê³  ì¥ìˆ˜ ì¶”ê°€</div>
          <input id="in_${idx}" type="number" placeholder="ì˜ˆ: 120">
          <button class="small" onclick="addInbound(${idx})">ì…ê³  ì¶”ê°€</button>
        </div>

        <div>
          <div style="font-size:12px;margin-bottom:2px;">ì”ëŸ‰ ì§ì ‘ ìˆ˜ì •</div>
          <input id="set_${idx}" type="number" placeholder="í˜„ì¬ ì‹¤ì œ ì”ëŸ‰ ì…ë ¥">
          <button class="small" onclick="setRemain(${idx})">ì”ëŸ‰ ìˆ˜ì •</button>
          ${manual ? `<button class="small" onclick="clearRemain(${idx})">ìë™ê³„ì‚° ë˜ëŒë¦¬ê¸°</button>` : ""}
        </div>
      </div>
    `;
  });
  summaryArea.innerHTML = area;
}
renderSummary();

function addInbound(idx){
  let input = document.getElementById("in_"+idx);
  if(!input) return;
  let val = Number(input.value);
  if(!val){
    alert("ì…ê³  ì¥ìˆ˜ë¥¼ ì…ë ¥í•´ì¤˜!");
    return;
  }
  let date = new Date().toISOString().slice(0,10);
  tapeInbound.push({tape: tapes[idx].name, sheets:val, date});
  save();
  input.value = "";
  renderSummary();
}

function setRemain(idx){
  let input = document.getElementById("set_"+idx);
  if(!input) return;
  let val = input.value;
  if(val === ""){
    alert("ì”ëŸ‰ ìˆ«ìë¥¼ ì…ë ¥í•´ì¤˜!");
    return;
  }
  tapes[idx].manualRemain = Number(val);
  save();
  renderSummary();
}

function clearRemain(idx){
  tapes[idx].manualRemain = null;
  save();
  renderSummary();
}

/* ---- CSV ë‹¤ìš´ë¡œë“œ ---- */
function downloadCsv(filename, rows){
  if(!rows || rows.length===0){
    alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  const csv = rows.map(r =>
    r.map(v => {
      let s = String(v ?? "");
      s = s.replace(/"/g,'""');
      return `"${s}"`;
    }).join(",")
  ).join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

function downloadStockCsv(){
  const rows = [["ë‚ ì§œ","ì œí’ˆëª…","EA","ì„¸íŠ¸/LOT"]];
  stocks.forEach(s=>{
    rows.push([s.date||"", s.name, s.ea, s.lot]);
  });
  downloadCsv("stocks.csv", rows);
}

function downloadWorkCsv(){
  const rows = [["ë‚ ì§œ","ì œí’ˆëª…","í…Œì´í”„","EA","ì†Œìš”ì¥ìˆ˜","ë¶ˆëŸ‰ì¥ìˆ˜"]];
  works.forEach(w=>{
    rows.push([w.date||"", w.name, w.tape, w.ea, w.sheet, w.bad]);
  });
  downloadCsv("works.csv", rows);
}

/* ---- ì´ˆê¸° ì„¤ì • ---- */
(function init(){
  const today = new Date().toISOString().slice(0,10);
  const dateInput = document.getElementById("workDate");
  if(dateInput && !dateInput.value) dateInput.value = today;
  refreshWorkTapeList();
})();
</script>

</body>
</html>
