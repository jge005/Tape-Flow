<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tape Flow</title>

  <style>
    :root{
      --bg: #ecf3ff;
      --bg-soft:#f6f8ff;
      --card:#ffffff;
      --text:#1b2440;
      --text-sub:#6a7696;
      --accent:#4f63ff;
      --accent-soft:#7ea6ff;
      --danger:#ff5f7a;
      --border:#dde3f6;
      --radius-xl:22px;
      --radius-lg:18px;
    }
    body.theme-dark{
      --bg:#050817;
      --bg-soft:#0b1024;
      --card:#111832;
      --text:#e5e9ff;
      --text-sub:#9faaf0;
      --accent:#8aa4ff;
      --accent-soft:#5f73ff;
      --danger:#ff748b;
      --border:#303a68;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;
      background:linear-gradient(180deg,#dce8ff 0%,#f6f8ff 45%,#fdfbff 100%);
      color:var(--text);
    }
    body.theme-dark{
      background:radial-gradient(circle at top,#151d41 0,#050817 55%,#020311 100%);
    }

    .app{
      max-width:900px;
      margin:0 auto;
      padding:18px 14px 40px;
    }

    /* ---------- í—¤ë” ---------- */
    header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    header .logo-box{
      width:40px;
      height:40px;
      border-radius:14px;
      background:linear-gradient(135deg,#ffb86c,#ff7eb3);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 8px 18px rgba(0,0,0,0.18);
    }
    header .logo-box span{
      font-size:22px;
    }
    header h1{
      margin:0;
      font-size:23px;
      letter-spacing:0.06em;
    }
    header p{
      margin:2px 0 0;
      font-size:11px;
      color:var(--text-sub);
    }

    /* ---------- ë„¤ë¹„ê²Œì´ì…˜ íƒ­ ---------- */
    .nav{
      display:flex;
      gap:8px;
      padding:8px 2px 16px;
      overflow-x:auto;
    }
    .nav::-webkit-scrollbar{display:none;}
    .nav button{
      flex:0 0 auto;
      padding:8px 15px;
      border:none;
      border-radius:999px;
      background:rgba(255,255,255,0.9);
      color:#5a6581;
      font-size:12px;
      font-weight:600;
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(60,88,180,0.12);
    }
    body.theme-dark .nav button{
      background:#111832;
      color:#cdd5ff;
      box-shadow:0 4px 14px rgba(0,0,0,0.55);
    }
    .nav button.active{
      background:linear-gradient(135deg,#8cb0ff,#4f63ff);
      color:#fff;
      box-shadow:0 6px 18px rgba(65,92,210,0.45);
    }

    /* ---------- ì¹´ë“œ ê³µí†µ ---------- */
    .card{
      background:var(--card);
      border-radius:var(--radius-xl);
      padding:16px 14px 18px;
      box-shadow:0 10px 28px rgba(35,60,130,0.12);
      margin-bottom:14px;
      border:1px solid rgba(255,255,255,0.7);
    }
    body.theme-dark .card{
      box-shadow:0 18px 40px rgba(0,0,0,0.7);
      border:1px solid rgba(78,96,167,0.6);
    }

    h2{
      margin:0 0 6px;
      font-size:17px;
    }
    .sub{
      font-size:12px;
      color:var(--text-sub);
      margin-bottom:10px;
    }

    /* ---------- í¼ ---------- */
    .field{
      margin-bottom:9px;
    }
    .field label{
      display:block;
      font-size:12px;
      margin-bottom:4px;
    }
    input, select{
      width:100%;
      padding:9px 10px;
      border-radius:14px;
      border:1px solid var(--border);
      font-size:13px;
      outline:none;
      background:rgba(255,255,255,0.96);
    }
    body.theme-dark input,
    body.theme-dark select{
      background:#10162f;
      border-color:#35406d;
      color:var(--text);
    }
    input::placeholder{color:#a8b0d0;}

    .btn{
      border:none;
      border-radius:999px;
      padding:8px 17px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      background:linear-gradient(135deg,#8cb0ff,#4f63ff);
      color:#fff;
      box-shadow:0 10px 24px rgba(35,75,200,0.4);
    }
    .btn-secondary{
      background:rgba(255,255,255,0.96);
      color:var(--text);
      box-shadow:0 6px 16px rgba(40,54,104,0.14);
    }
    .btn-danger{
      background:var(--danger);
      box-shadow:0 8px 18px rgba(255,95,122,0.55);
    }
    .btn-sm{padding:6px 11px;font-size:11px;}

    /* ---------- í…Œì´ë¸” ---------- */
    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    th,td{
      padding:7px 8px;
      text-align:left;
      white-space:nowrap;
    }
    th{
      font-size:11px;
      color:var(--text-sub);
      border-bottom:1px solid rgba(210,218,243,0.9);
      background:rgba(255,255,255,0.8);
    }
    tbody tr:nth-child(2n){
      background:rgba(255,255,255,0.8);
    }
    tbody tr:last-child td{
      border-bottom:none;
    }
    tbody td{
      border-bottom:1px solid rgba(223,229,246,0.7);
    }

    #prod-list-wrap,
    #job-list-wrap,
    #tape-stock-table-wrap{
      border-radius:var(--radius-lg);
      background:var(--bg-soft);
      padding:4px 4px 0;
    }

    .tag{
      display:inline-block;
      padding:2px 7px;
      border-radius:999px;
      background:rgba(127,173,255,0.12);
      color:var(--accent);
      font-size:10px;
      margin-left:4px;
    }

    .tab-pane{display:none;}
    .tab-pane.active{display:block;}

    .flex-between{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .flex-row{
      display:flex;
      gap:8px;
    }
    .flex-row > .field{flex:1;}
    @media(max-width:600px){
      .flex-row{flex-direction:column;}
    }

    .suggestions{
      margin-top:3px;
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }
    .suggestions button{
      border:none;
      border-radius:999px;
      padding:4px 8px;
      font-size:10px;
      background:rgba(255,255,255,0.95);
      color:var(--text-sub);
      box-shadow:0 3px 9px rgba(0,0,0,0.08);
    }

    .note{
      font-size:11px;
      color:var(--text-sub);
      margin-top:3px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:10px;
      padding:3px 7px;
      border-radius:999px;
      background:rgba(0,0,0,0.03);
      color:var(--text-sub);
    }

    /* ---------- ì ê¸ˆ í™”ë©´ ---------- */
    #lock-screen{
      position:fixed;
      inset:0;
      background:linear-gradient(180deg,#dfe9ff 0%,#f7f8ff 55%,#ffffff 100%);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:20;
    }
    body.theme-dark #lock-screen{
      background:radial-gradient(circle at top,#151d41 0,#050817 60%,#020311 100%);
    }
    #lock-screen .panel{
      width:90%;
      max-width:360px;
      background:var(--card);
      border-radius:22px;
      padding:18px 16px 20px;
      box-shadow:0 18px 40px rgba(0,0,0,0.65);
      border:1px solid rgba(255,255,255,0.35);
      text-align:center;
    }
    #lock-screen h2{margin-bottom:6px;font-size:18px;}
    #lock-screen p{margin-top:0;font-size:11px;color:var(--text-sub);}
    #lock-error{color:var(--danger);font-size:11px;min-height:14px;margin-top:4px;}
  </style>
</head>
<body>
  <!-- ì ê¸ˆ í™”ë©´ -->
  <div id="lock-screen">
    <div class="panel">
      <h2>ì ê¸ˆ í•´ì œ</h2>
      <p>ì„¤ì •í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ Tape Flow ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.</p>
      <div class="field">
        <input id="lock-pin" type="password" inputmode="numeric" maxlength="10" placeholder="ë¹„ë°€ë²ˆí˜¸" />
      </div>
      <button class="btn" id="lock-open-btn">ì•± ì—´ê¸°</button>
      <div id="lock-error"></div>
    </div>
  </div>

  <div class="app">
    <header>
      <div class="logo-box"><span>ğŸ“¦</span></div>
      <div>
        <h1>TAPE FLOW</h1>
        <p>í…Œì´í”„Â·ì œí’ˆ ì¬ê³  & ì‘ì—… ê¸°ë¡ ê´€ë¦¬</p>
      </div>
    </header>

    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="nav">
      <button class="active" data-tab="prod">ì œí’ˆ ì¬ê³ </button>
      <button data-tab="job">ì‘ì—… ë“±ë¡</button>
      <button data-tab="tape-stock">í…Œì´í”„ ì¬ê³ </button>
      <button data-tab="tape">í…Œì´í”„ ì„¤ì •</button>
      <button data-tab="settings">ì„¤ì •</button>
    </div>

    <!-- ì œí’ˆ ì¬ê³  íƒ­ -->
    <section id="tab-prod" class="tab-pane active">
      <div class="card">
        <h2>ì œí’ˆ ì¬ê³  ë“±ë¡</h2>
        <div class="sub">ì¸ì‡„ì‹¤ì—ì„œ ì˜¬ë¼ì˜¨ ì œí’ˆì„ ì„¸íŠ¸ë³„ë¡œ ì…ë ¥í•´ ë‘ëŠ” ê³³ì´ì—ìš”.</div>
        <div class="field">
          <label for="prod-name">ì œí’ˆëª…</label>
          <input id="prod-name" placeholder="ì˜ˆ: 7125J" />
        </div>
        <div class="field">
          <label for="prod-ea">ìˆ˜ëŸ‰(EA)</label>
          <input id="prod-ea" type="number" inputmode="numeric" placeholder="ì˜ˆ: 2520" />
        </div>
        <div class="field">
          <label for="prod-lot">ë°œì‹  LOT</label>
          <input id="prod-lot" placeholder="ì˜ˆ: LOT123" />
        </div>
        <div class="field">
          <label for="prod-printer">ì¸ì‡„ì</label>
          <input id="prod-printer" placeholder="ì˜ˆ: ê¹€ì£¼í˜„" />
        </div>
        <button class="btn" id="btn-prod-add">ì¬ê³  ì¶”ê°€</button>
        <div class="note">ê°™ì€ ì œí’ˆì´ ì—¬ëŸ¬ ì„¸íŠ¸ì¼ ë• ì„¸íŠ¸ë§ˆë‹¤ ë”°ë¡œ ë“±ë¡í•´ ì£¼ì„¸ìš”.</div>
      </div>

      <div class="card">
        <div class="flex-between">
          <h2>ì œí’ˆ ì¬ê³  ëª©ë¡</h2>
          <button class="btn-secondary btn-sm" id="btn-prod-csv">ì œí’ˆ ì¬ê³  CSV ë‹¤ìš´ë¡œë“œ</button>
        </div>
        <div id="prod-list-wrap">
          <table>
            <thead>
              <tr>
                <th>ë‚ ì§œ</th>
                <th>ì œí’ˆëª…</th>
                <th>EA</th>
                <th>ë°œì‹  LOT</th>
                <th>ì¸ì‡„ì</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody id="prod-table-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ì‘ì—… ë“±ë¡ íƒ­ -->
    <section id="tab-job" class="tab-pane">
      <div class="card">
        <h2>ì‘ì—… ë“±ë¡</h2>
        <div class="sub">ì–´ë–¤ ì œí’ˆì„ ì–´ë–¤ í…Œì´í”„ë¡œ ëª‡ EA/ì¥ ì‘ì—…í–ˆëŠ”ì§€ ê¸°ë¡í•´ìš”. ë“±ë¡ ì‹œ í•´ë‹¹ ì œí’ˆ ì¬ê³ ê°€ ìë™ìœ¼ë¡œ ì°¨ê°ë¼ìš”.</div>

        <div class="field">
          <label for="job-date">ì‘ì—… ë‚ ì§œ</label>
          <input id="job-date" type="date" />
        </div>

        <div class="field">
          <label for="job-prod-name">ì œí’ˆëª…</label>
          <input id="job-prod-name" placeholder="ì˜ˆ: 7125J" />
          <div id="job-prod-suggestions" class="suggestions"></div>
        </div>

        <div class="field">
          <label for="job-lot">ë°œì‹  LOT</label>
          <input id="job-lot" placeholder="ì˜ˆ: LOT123" />
          <div id="job-lot-suggestions" class="suggestions"></div>
        </div>

        <div class="flex-row">
          <div class="field">
            <label for="job-ea">ì‚¬ìš© ìˆ˜ëŸ‰(EA)</label>
            <input id="job-ea" type="number" inputmode="numeric" placeholder="ì˜ˆ: 2520" />
          </div>
          <div class="field">
            <label for="job-sheets">ì‚¬ìš© ì¥ìˆ˜(í…Œì´í”„)</label>
            <input id="job-sheets" type="number" inputmode="numeric" placeholder="ì˜ˆ: 420" />
          </div>
        </div>
        <div class="note">EA ë˜ëŠ” ì¥ìˆ˜ ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥í•´ë„, í…Œì´í”„ ì •ë³´ê°€ ìˆìœ¼ë©´ ë‚˜ë¨¸ì§€ëŠ” ìë™ ê³„ì‚°ë¼ìš”(ìˆ˜ì •ë„ ê°€ëŠ¥).</div>

        <div class="field">
          <label for="job-tape">ì‚¬ìš© í…Œì´í”„</label>
          <select id="job-tape">
            <option value="">í…Œì´í”„ ì„ íƒ</option>
          </select>
        </div>

        <div class="flex-row">
          <div class="field">
            <label for="job-defect">í…Œì´í”„ ë¶ˆëŸ‰ ì¥ìˆ˜</label>
            <input id="job-defect" type="number" inputmode="numeric" placeholder="ì˜ˆ: 3" />
          </div>
          <div class="field">
            <label for="job-dest">ì‘ì—… ë‚´ë¦° ê³³</label>
            <select id="job-dest">
              <option value="ê°€ê³µì‹¤">ê°€ê³µì‹¤</option>
              <option value="íƒœì„±">íƒœì„±</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>
            <input type="checkbox" id="job-deduct" checked />
            ì´ ì‘ì—…ë§Œí¼ ì œí’ˆ ì¬ê³ ì—ì„œ ì°¨ê°
          </label>
        </div>

        <button class="btn" id="btn-job-add">ì‘ì—… ì¶”ê°€</button>
      </div>

      <div class="card">
        <div class="flex-between">
          <h2>ìµœê·¼ ì‘ì—… ë‚´ì—­</h2>
          <span class="badge"><span>â„¹ï¸</span>ìµœì‹  30ê±´ë§Œ í‘œì‹œ</span>
        </div>
        <div id="job-list-wrap">
          <table>
            <thead>
              <tr>
                <th>ë‚ ì§œ</th>
                <th>ì œí’ˆëª…</th>
                <th>LOT</th>
                <th>EA</th>
                <th>ì¥ìˆ˜</th>
                <th>í…Œì´í”„</th>
                <th>ë¶ˆëŸ‰</th>
                <th>ëª©ì ì§€</th>
              </tr>
            </thead>
            <tbody id="job-table-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- í…Œì´í”„ ì¬ê³  íƒ­ -->
    <section id="tab-tape-stock" class="tab-pane">
      <div class="card">
        <h2>í…Œì´í”„ ì…ê³  ë“±ë¡</h2>
        <div class="sub">ê°€ê³µì‹¤Â·íƒœì„±ì—ì„œ ì˜¬ë¼ì˜¨ í…Œì´í”„ ì¥ìˆ˜ë¥¼ ë“±ë¡í•´ìš”.</div>
        <div class="field">
          <label for="tape-event-date">ì…ê³  ë‚ ì§œ</label>
          <input id="tape-event-date" type="date" />
        </div>
        <div class="field">
          <label for="tape-event-tape">í…Œì´í”„</label>
          <select id="tape-event-tape">
            <option value="">í…Œì´í”„ ì„ íƒ</option>
          </select>
        </div>
        <div class="field">
          <label for="tape-event-sheets">ì…ê³  ì¥ìˆ˜</label>
          <input id="tape-event-sheets" type="number" inputmode="numeric" placeholder="ì˜ˆ: 300" />
        </div>
        <button class="btn" id="btn-tape-in">ì…ê³  ì¶”ê°€</button>
        <div class="note">í…Œì´í”„ ì”ëŸ‰ì€ ì…ê³ Â·ë¶ˆëŸ‰Â·ì‘ì—… ì‚¬ìš©ëŸ‰ì„ ëª¨ë‘ ë°˜ì˜í•´ì„œ ìë™ ê³„ì‚°ë¼ìš”.</div>
      </div>

      <div class="card">
        <div class="flex-between">
          <h2>í…Œì´í”„ ì¬ê³  í˜„í™©</h2>
          <button class="btn-secondary btn-sm" id="btn-tape-stock-csv">í…Œì´í”„ ì¬ê³  CSV</button>
        </div>
        <div id="tape-stock-table-wrap">
          <table>
            <thead>
              <tr>
                <th>í…Œì´í”„ëª…</th>
                <th>ì¶œì²˜</th>
                <th>ì…ê³  ì¥ìˆ˜</th>
                <th>ì‚¬ìš© ì¥ìˆ˜</th>
                <th>ë¶ˆëŸ‰ ì¥ìˆ˜</th>
                <th>í˜„ì¬ ì¥ìˆ˜</th>
                <th>ì”ëŸ‰ ìˆ˜ì •</th>
              </tr>
            </thead>
            <tbody id="tape-stock-body"></tbody>
          </table>
        </div>
        <div class="note">ì”ëŸ‰ ìˆ˜ì •ì€ ê³„ì‚°ê°’ê³¼ ë‹¤ë¥¼ ë•Œ ìˆ˜ê¸°ë¡œ ë§ì¶”ëŠ” ìš©ë„ì˜ˆìš”(ì¡°ì • ë‚´ì—­ì€ ë³„ë„ë¡œ ì €ì¥).</div>
      </div>
    </section>

    <!-- í…Œì´í”„ ì„¤ì • íƒ­ -->
    <section id="tab-tape" class="tab-pane">
      <div class="card">
        <h2>í…Œì´í”„ ê¸°ë³¸ ì •ë³´</h2>
        <div class="sub">í…Œì´í”„ ì¢…ë¥˜ì™€ 1ì¥ë‹¹ ëª‡ EA ë¶™ëŠ”ì§€ ì„¤ì •í•´ìš”. ì‘ì—… ë“±ë¡ ë•Œ ìë™ ê³„ì‚°ì— ì‚¬ìš©ë¼ìš”.</div>

        <div class="field">
          <label for="tape-name">í…Œì´í”„ëª…</label>
          <input id="tape-name" placeholder="ì˜ˆ: 6855, 6491" />
        </div>
        <div class="field">
          <label for="tape-ea">EA(ì œí’ˆ ìˆ˜ëŸ‰) / 1ì¥ë‹¹</label>
          <input id="tape-ea" type="number" inputmode="numeric" placeholder="ì˜ˆ: 6" />
        </div>
        <div class="field">
          <label for="tape-source">ì¶œì²˜</label>
          <select id="tape-source">
            <option value="ê°€ê³µì‹¤">ê°€ê³µì‹¤</option>
            <option value="íƒœì„±">íƒœì„±</option>
          </select>
        </div>
        <button class="btn" id="btn-tape-add">í…Œì´í”„ ì¶”ê°€</button>
      </div>

      <div class="card">
        <h2>ë“±ë¡ëœ í…Œì´í”„</h2>
        <div id="tape-list-wrap">
          <table>
            <thead>
              <tr>
                <th>í…Œì´í”„ëª…</th>
                <th>EA / ì¥</th>
                <th>ì¶œì²˜</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody id="tape-table-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ì„¤ì • íƒ­ -->
    <section id="tab-settings" class="tab-pane">
      <div class="card">
        <h2>í…Œë§ˆ Â· í™”ë©´ ì„¤ì •</h2>
        <div class="sub">ë¼ì´íŠ¸ / ë‹¤í¬ í…Œë§ˆë¥¼ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”.</div>
        <button class="btn-secondary" id="btn-theme-toggle">ë‹¤í¬ ëª¨ë“œ ì „í™˜</button>
        <div class="note" id="theme-note"></div>
      </div>

      <div class="card">
        <h2>ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</h2>
        <div class="sub">ë‹¤ë¥¸ ì‚¬ëŒì´ ë§ˆìŒëŒ€ë¡œ ìˆ˜ì •í•˜ì§€ ëª»í•˜ê²Œ ê°„ë‹¨í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê±¸ ìˆ˜ ìˆì–´ìš”.</div>
        <div class="field">
          <label for="setting-old-pin">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ (ìˆì„ ê²½ìš°)</label>
          <input id="setting-old-pin" type="password" />
        </div>
        <div class="field">
          <label for="setting-new-pin">ìƒˆ ë¹„ë°€ë²ˆí˜¸ (ìˆ«ì ëª‡ ìë¦¬ë“  ê°€ëŠ¥)</label>
          <input id="setting-new-pin" type="password" />
        </div>
        <button class="btn" id="btn-pin-save">ë¹„ë°€ë²ˆí˜¸ ì„¤ì • / ë³€ê²½</button>
        <button class="btn-secondary btn-sm" id="btn-pin-clear" style="margin-left:8px;">ë¹„ë°€ë²ˆí˜¸ í•´ì œ</button>
        <div class="note" id="pin-note"></div>
      </div>
    </section>
  </div>

  <script>
    // ---------- ê³µí†µ ìœ í‹¸ ----------
    const LS_TAPES = 'TF_TAPES';
    const LS_PRODUCTS = 'TF_PRODUCTS';
    const LS_JOBS = 'TF_JOBS';
    const LS_TAPE_EVENTS = 'TF_TAPE_EVENTS';
    const LS_THEME = 'TF_THEME';
    const LS_PIN = 'TF_PIN';

    let tapes = [];
    let products = [];
    let jobs = [];
    let tapeEvents = []; // {id,date,tapeId,type:'in'|'adjust',delta}

    function loadAll(){
      tapes = JSON.parse(localStorage.getItem(LS_TAPES) || '[]');
      products = JSON.parse(localStorage.getItem(LS_PRODUCTS) || '[]');
      jobs = JSON.parse(localStorage.getItem(LS_JOBS) || '[]');
      tapeEvents = JSON.parse(localStorage.getItem(LS_TAPE_EVENTS) || '[]');
    }
    function saveAll(){
      localStorage.setItem(LS_TAPES, JSON.stringify(tapes));
      localStorage.setItem(LS_PRODUCTS, JSON.stringify(products));
      localStorage.setItem(LS_JOBS, JSON.stringify(jobs));
      localStorage.setItem(LS_TAPE_EVENTS, JSON.stringify(tapeEvents));
    }

    function todayStr(){
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return d.getFullYear() + '-' + m + '-' + day;
    }

    function downloadCSV(filename, header, rows){
      const sep = ',';
      const escape = (v) => {
        if(v == null) return '';
        const s = String(v).replace(/"/g,'""');
        return '"' + s + '"';
      };
      let csv = header.map(escape).join(sep) + '\n';
      rows.forEach(r=>{
        csv += r.map(escape).join(sep) + '\n';
      });
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ---------- íƒ­ ì „í™˜ ----------
    function setupTabs(){
      const buttons = document.querySelectorAll('.nav button');
      const panes = document.querySelectorAll('.tab-pane');
      buttons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const target = btn.dataset.tab;
          buttons.forEach(b=>b.classList.remove('active'));
          panes.forEach(p=>p.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('tab-'+target).classList.add('active');
        });
      });
    }

    // ---------- ì œí’ˆ ì¬ê³  ----------
    function renderProducts(){
      const tbody = document.getElementById('prod-table-body');
      tbody.innerHTML = '';
      // ìµœì‹ ì´ ìœ„ë¡œ
      const sorted = [...products].sort((a,b)=>b.id - a.id);
      sorted.forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.date}</td>
          <td>${p.name}</td>
          <td>${p.ea}</td>
          <td>${p.lot || ''}</td>
          <td>${p.printer || ''}</td>
          <td>
            <button class="btn-secondary btn-sm" data-id="${p.id}" data-action="del-prod">ì‚­ì œ</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('button[data-action="del-prod"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = Number(btn.dataset.id);
          if(!confirm('ì´ ì œí’ˆ ì¬ê³ ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
          products = products.filter(p=>p.id !== id);
          saveAll();
          renderProducts();
        });
      });
    }

    function setupProductForm(){
      document.getElementById('btn-prod-add').addEventListener('click', ()=>{
        const name = document.getElementById('prod-name').value.trim();
        const ea = Number(document.getElementById('prod-ea').value || 0);
        const lot = document.getElementById('prod-lot').value.trim();
        const printer = document.getElementById('prod-printer').value.trim();
        if(!name || !ea){
          alert('ì œí’ˆëª…ê³¼ ìˆ˜ëŸ‰(EA)ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
          return;
        }
        const item = {
          id: Date.now(),
          date: todayStr(),
          name, ea, lot, printer
        };
        products.push(item);
        saveAll();
        document.getElementById('prod-name').value = '';
        document.getElementById('prod-ea').value = '';
        document.getElementById('prod-lot').value = '';
        document.getElementById('prod-printer').value = '';
        renderProducts();
      });

      document.getElementById('btn-prod-csv').addEventListener('click', ()=>{
        const header = ['ë‚ ì§œ','ì œí’ˆëª…','EA','ë°œì‹ LOT','ì¸ì‡„ì'];
        const rows = products.map(p=>[p.date,p.name,p.ea,p.lot||'',p.printer||'']);
        downloadCSV('ì œí’ˆì¬ê³ _'+todayStr()+'.csv', header, rows);
      });
    }

    // ì œí’ˆ ì¬ê³  ì°¨ê°
    function deductProductStock(name, lot, usedEa){
      if(!usedEa) return;
      let remain = usedEa;
      // LOT ìš°ì„ 
      const candidates = products.filter(p=>p.name === name && (!lot || p.lot === lot));
      for(const p of candidates){
        if(remain <= 0) break;
        if(p.ea > remain){
          p.ea -= remain;
          remain = 0;
        }else{
          remain -= p.ea;
          products = products.filter(x=>x.id !== p.id);
        }
      }
      saveAll();
      renderProducts();
    }

    // ---------- ì‘ì—… ë“±ë¡ ----------
    function renderJobs(){
      const tbody = document.getElementById('job-table-body');
      tbody.innerHTML = '';
      const sorted = [...jobs].sort((a,b)=>b.id-a.id).slice(0,30);
      sorted.forEach(j=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${j.date}</td>
          <td>${j.productName}</td>
          <td>${j.lot || ''}</td>
          <td>${j.usedEa || ''}</td>
          <td>${j.sheets || ''}</td>
          <td>${j.tapeName || ''}</td>
          <td>${j.defectSheets || 0}</td>
          <td>${j.dest || ''}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function setupJobForm(){
      const dateInput = document.getElementById('job-date');
      dateInput.value = todayStr();

      const prodInput = document.getElementById('job-prod-name');
      const lotInput = document.getElementById('job-lot');
      const prodSugWrap = document.getElementById('job-prod-suggestions');
      const lotSugWrap = document.getElementById('job-lot-suggestions');

      function rebuildProdSuggestions(){
        const q = prodInput.value.trim();
        prodSugWrap.innerHTML = '';
        if(!q) return;
        const names = Array.from(new Set(products.map(p=>p.name))).filter(n=>n && n.includes(q));
        names.slice(0,8).forEach(n=>{
          const b = document.createElement('button');
          b.type = 'button';
          b.textContent = n;
          b.addEventListener('click', ()=>{
            prodInput.value = n;
            prodSugWrap.innerHTML = '';
            rebuildLotSuggestions();
          });
          prodSugWrap.appendChild(b);
        });
      }
      function rebuildLotSuggestions(){
        const q = lotInput.value.trim();
        lotSugWrap.innerHTML = '';
        const name = prodInput.value.trim();
        if(!name) return;
        const lots = Array.from(new Set(products.filter(p=>p.name===name).map(p=>p.lot))).filter(l=>l && (!q || l.includes(q)));
        lots.slice(0,8).forEach(l=>{
          const b = document.createElement('button');
          b.type = 'button';
          b.textContent = l;
          b.addEventListener('click', ()=>{
            lotInput.value = l;
            lotSugWrap.innerHTML = '';
          });
          lotSugWrap.appendChild(b);
        });
      }
      prodInput.addEventListener('input', rebuildProdSuggestions);
      lotInput.addEventListener('input', rebuildLotSuggestions);

      const eaInput = document.getElementById('job-ea');
      const sheetInput = document.getElementById('job-sheets');
      const tapeSelect = document.getElementById('job-tape');

      function getSelectedTape(){
        const id = tapeSelect.value;
        if(!id) return null;
        return tapes.find(t=>String(t.id)===id) || null;
      }

      eaInput.addEventListener('change', ()=>{
        const t = getSelectedTape();
        if(!t || !t.eaPerSheet) return;
        if(!eaInput.value) return;
        if(sheetInput.value) return; // ì´ë¯¸ ì§ì ‘ ì…ë ¥ëœ ê²½ìš°
        const ea = Number(eaInput.value || 0);
        if(ea<=0) return;
        sheetInput.value = Math.ceil(ea / t.eaPerSheet);
      });
      sheetInput.addEventListener('change', ()=>{
        const t = getSelectedTape();
        if(!t || !t.eaPerSheet) return;
        if(!sheetInput.value) return;
        if(eaInput.value) return;
        const sheets = Number(sheetInput.value || 0);
        if(sheets<=0) return;
        eaInput.value = sheets * t.eaPerSheet;
      });

      document.getElementById('btn-job-add').addEventListener('click', ()=>{
        const date = dateInput.value || todayStr();
        const productName = prodInput.value.trim();
        const lot = lotInput.value.trim();
        const usedEa = Number(eaInput.value || 0);
        const sheets = Number(sheetInput.value || 0);
        const tapeId = tapeSelect.value;
        const tape = tapes.find(t=>String(t.id)===tapeId);
        const tapeName = tape ? tape.name : '';
        const defectSheets = Number(document.getElementById('job-defect').value || 0);
        const dest = document.getElementById('job-dest').value;
        const deduct = document.getElementById('job-deduct').checked;

        if(!productName){
          alert('ì œí’ˆëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
          return;
        }
        if(!usedEa && !sheets){
          alert('EA ë˜ëŠ” í…Œì´í”„ ì¥ìˆ˜ ì¤‘ í•˜ë‚˜ëŠ” ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
          return;
        }
        if(!tapeId){
          if(!confirm('í…Œì´í”„ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í…Œì´í”„ ì—†ì´ ì‘ì—…ì„ ë“±ë¡í• ê¹Œìš”?')) return;
        }

        // EA/ì¥ìˆ˜ ë³´ì •
        if(tape && tape.eaPerSheet){
          if(usedEa && !sheets){
            sheetInput.value = Math.ceil(usedEa / tape.eaPerSheet);
          }else if(!usedEa && sheets){
            eaInput.value = sheets * tape.eaPerSheet;
          }
        }

        const finalEa = Number(eaInput.value || usedEa || 0);
        const finalSheets = Number(sheetInput.value || sheets || 0);

        const job = {
          id: Date.now(),
          date, productName, lot,
          usedEa: finalEa,
          sheets: finalSheets,
          tapeId: tapeId || null,
          tapeName,
          defectSheets,
          dest
        };
        jobs.push(job);

        // ì œí’ˆ ì¬ê³  ì°¨ê°
        if(deduct && finalEa){
          deductProductStock(productName, lot, finalEa);
        }

        saveAll();
        renderJobs();
        renderTapeStock();

        // ì…ë ¥ê°’ ì¼ë¶€ ì´ˆê¸°í™”
        eaInput.value = '';
        sheetInput.value = '';
        document.getElementById('job-defect').value = '';
      });
    }

    // ---------- í…Œì´í”„ ì„¤ì • ----------
    function renderTapeOptions(){
      const selects = [document.getElementById('job-tape'), document.getElementById('tape-event-tape')];
      selects.forEach(sel=>{
        const current = sel.value;
        sel.innerHTML = '<option value="">í…Œì´í”„ ì„ íƒ</option>';
        tapes.forEach(t=>{
          const opt = document.createElement('option');
          opt.value = t.id;
          opt.textContent = t.name;
          sel.appendChild(opt);
        });
        if(current) sel.value = current;
      });
    }

    function renderTapes(){
      const tbody = document.getElementById('tape-table-body');
      tbody.innerHTML = '';
      tapes.forEach(t=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.name}</td>
          <td>${t.eaPerSheet || ''}</td>
          <td>${t.source || ''}</td>
          <td>
            <button class="btn-secondary btn-sm" data-id="${t.id}" data-action="edit-tape">ìˆ˜ì •</button>
            <button class="btn-danger btn-sm" data-id="${t.id}" data-action="del-tape">ì‚­ì œ</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll('button[data-action="del-tape"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = Number(btn.dataset.id);
          if(!confirm('ì´ í…Œì´í”„ë¥¼ ì‚­ì œí• ê¹Œìš”? (ê¸°ë¡ì€ ë‚¨ì•„ìˆì§€ë§Œ ìƒˆ ì‘ì—…ì—ì„œ ì„ íƒí•  ìˆ˜ ì—†ìŒ)')) return;
          tapes = tapes.filter(t=>t.id !== id);
          saveAll();
          renderTapes();
          renderTapeOptions();
          renderTapeStock();
        });
      });

      tbody.querySelectorAll('button[data-action="edit-tape"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = Number(btn.dataset.id);
          const t = tapes.find(x=>x.id === id);
          if(!t) return;
          const name = prompt('í…Œì´í”„ëª… ìˆ˜ì •', t.name);
          if(!name) return;
          const ea = Number(prompt('EA / ì¥', t.eaPerSheet || '') || 0);
          const source = prompt('ì¶œì²˜ (ê°€ê³µì‹¤ / íƒœì„±)', t.source || '') || t.source;
          t.name = name.trim();
          t.eaPerSheet = ea;
          t.source = source;
          saveAll();
          renderTapes();
          renderTapeOptions();
          renderTapeStock();
        });
      });
    }

    function setupTapeForm(){
      document.getElementById('btn-tape-add').addEventListener('click', ()=>{
        const name = document.getElementById('tape-name').value.trim();
        const ea = Number(document.getElementById('tape-ea').value || 0);
        const source = document.getElementById('tape-source').value;
        if(!name){
          alert('í…Œì´í”„ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
          return;
        }
        const t = {
          id: Date.now(),
          name,
          eaPerSheet: ea,
          source
        };
        tapes.push(t);
        saveAll();
        document.getElementById('tape-name').value = '';
        document.getElementById('tape-ea').value = '';
        renderTapes();
        renderTapeOptions();
        renderTapeStock();
      });
    }

    // ---------- í…Œì´í”„ ì¬ê³  ----------
    function computeTapeStats(){
      const result = {};
      tapes.forEach(t=>{
        result[t.id] = {
          tape: t,
          inSheets: 0,
          usedSheets: 0,
          defectSheets: 0,
          adjustDelta: 0
        };
      });

      tapeEvents.forEach(ev=>{
        const s = result[ev.tapeId];
        if(!s) return;
        if(ev.type === 'in'){
          s.inSheets += ev.delta;
        }else if(ev.type === 'adjust'){
          s.adjustDelta += ev.delta;
        }
      });

      jobs.forEach(j=>{
        if(!j.tapeId) return;
        const s = result[j.tapeId];
        if(!s) return;
        s.usedSheets += (j.sheets || 0);
        s.defectSheets += (j.defectSheets || 0);
      });

      Object.values(result).forEach(s=>{
        s.currentSheets = s.inSheets + s.adjustDelta - s.usedSheets - s.defectSheets;
      });
      return result;
    }

    function renderTapeStock(){
      const stats = computeTapeStats();
      const tbody = document.getElementById('tape-stock-body');
      tbody.innerHTML = '';
      Object.values(stats).forEach(s=>{
        const t = s.tape;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.name}</td>
          <td>${t.source || ''}</td>
          <td>${s.inSheets}</td>
          <td>${s.usedSheets}</td>
          <td>${s.defectSheets}</td>
          <td>${s.currentSheets}</td>
          <td>
            <button class="btn-secondary btn-sm" data-id="${t.id}" data-current="${s.currentSheets}">ìˆ˜ì •</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll('button.btn-secondary').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const tapeId = Number(btn.dataset.id);
          const current = Number(btn.dataset.current || 0);
          const val = prompt('ìƒˆë¡œìš´ í˜„ì¬ ì¥ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', current);
          if(val === null) return;
          const newVal = Number(val || 0);
          const delta = newVal - current;
          if(!delta) return;
          tapeEvents.push({
            id: Date.now(),
            date: todayStr(),
            tapeId,
            type:'adjust',
            delta
          });
          saveAll();
          renderTapeStock();
        });
      });
    }

    function setupTapeStock(){
      const dateInput = document.getElementById('tape-event-date');
      dateInput.value = todayStr();

      document.getElementById('btn-tape-in').addEventListener('click', ()=>{
        const date = dateInput.value || todayStr();
        const tapeIdStr = document.getElementById('tape-event-tape').value;
        const sheets = Number(document.getElementById('tape-event-sheets').value || 0);
        if(!tapeIdStr){
          alert('í…Œì´í”„ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
          return;
        }
        if(!sheets){
          alert('ì…ê³  ì¥ìˆ˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
          return;
        }
        const tapeId = Number(tapeIdStr);
        tapeEvents.push({
          id: Date.now(),
          date,
          tapeId,
          type:'in',
          delta: sheets
        });
        saveAll();
        document.getElementById('tape-event-sheets').value = '';
        renderTapeStock();
      });

      document.getElementById('btn-tape-stock-csv').addEventListener('click', ()=>{
        const stats = computeTapeStats();
        const header = ['í…Œì´í”„ëª…','ì¶œì²˜','ì…ê³ ì¥ìˆ˜','ì‚¬ìš©ì¥ìˆ˜','ë¶ˆëŸ‰ì¥ìˆ˜','í˜„ì¬ì¥ìˆ˜'];
        const rows = Object.values(stats).map(s=>[
          s.tape.name,
          s.tape.source||'',
          s.inSheets,
          s.usedSheets,
          s.defectSheets,
          s.currentSheets
        ]);
        downloadCSV('í…Œì´í”„ì¬ê³ _'+todayStr()+'.csv', header, rows);
      });
    }

    // ---------- ì„¤ì • / í…Œë§ˆ / ë¹„ë°€ë²ˆí˜¸ ----------
    function applyThemeFromStorage(){
      const theme = localStorage.getItem(LS_THEME) || 'light';
      if(theme === 'dark'){
        document.body.classList.add('theme-dark');
      }else{
        document.body.classList.remove('theme-dark');
      }
      const btn = document.getElementById('btn-theme-toggle');
      const note = document.getElementById('theme-note');
      if(document.body.classList.contains('theme-dark')){
        btn.textContent = 'ë¼ì´íŠ¸ ëª¨ë“œ ì „í™˜';
        note.textContent = 'í˜„ì¬: ë‹¤í¬ ëª¨ë“œ';
      }else{
        btn.textContent = 'ë‹¤í¬ ëª¨ë“œ ì „í™˜';
        note.textContent = 'í˜„ì¬: ë¼ì´íŠ¸ ëª¨ë“œ';
      }
    }

    function setupSettings(){
      document.getElementById('btn-theme-toggle').addEventListener('click', ()=>{
        document.body.classList.toggle('theme-dark');
        const theme = document.body.classList.contains('theme-dark') ? 'dark' : 'light';
        localStorage.setItem(LS_THEME, theme);
        applyThemeFromStorage();
      });
      applyThemeFromStorage();

      const pinNote = document.getElementById('pin-note');
      function setPinNote(msg){ pinNote.textContent = msg || ''; }

      document.getElementById('btn-pin-save').addEventListener('click', ()=>{
        const oldPin = document.getElementById('setting-old-pin').value;
        const newPin = document.getElementById('setting-new-pin').value;
        const stored = localStorage.getItem(LS_PIN);

        if(stored){
          if(oldPin !== stored){
            setPinNote('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
          }
        }
        if(!newPin){
          setPinNote('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
          return;
        }
        localStorage.setItem(LS_PIN, newPin);
        document.getElementById('setting-old-pin').value = '';
        document.getElementById('setting-new-pin').value = '';
        setPinNote('ë¹„ë°€ë²ˆí˜¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      });

      document.getElementById('btn-pin-clear').addEventListener('click', ()=>{
        if(!confirm('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì™„ì „íˆ í•´ì œí• ê¹Œìš”?')) return;
        localStorage.removeItem(LS_PIN);
        document.getElementById('setting-old-pin').value = '';
        document.getElementById('setting-new-pin').value = '';
        setPinNote('ë¹„ë°€ë²ˆí˜¸ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      });
    }

    // ---------- ì ê¸ˆ í™”ë©´ ----------
    function setupLockScreen(){
      const storedPin = localStorage.getItem(LS_PIN);
      const lock = document.getElementById('lock-screen');
      const err = document.getElementById('lock-error');
      if(storedPin){
        lock.style.display = 'flex';
      }else{
        lock.style.display = 'none';
      }
      document.getElementById('lock-open-btn').addEventListener('click', ()=>{
        const v = document.getElementById('lock-pin').value;
        if(v === storedPin){
          lock.style.display = 'none';
        }else{
          err.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
        }
      });
    }

    // ---------- ì´ˆê¸°í™” ----------
    document.addEventListener('DOMContentLoaded', ()=>{
      loadAll();
      setupTabs();
      setupProductForm();
      setupJobForm();
      setupTapeForm();
      setupTapeStock();
      setupSettings();
      setupLockScreen();

      renderProducts();
      renderTapes();
      renderTapeOptions();
      renderJobs();
      renderTapeStock();
    });
  </script>
</body>
</html>
