<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tape Flow</title>

<style>
*{ box-sizing:border-box; }

body{
  margin:0;
  padding:0;
  font-family:Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
}

/* í…Œë§ˆ */
body.theme-blue{
  background:linear-gradient(180deg,#e4f1ff,#f5f7ff);
}
body.theme-dark{
  background:linear-gradient(180deg,#141b2f,#202a4a);
  color:#f5f7ff;
}

/* ê³µí†µ ë ˆì´ì•„ì›ƒ */
.app-root{
  max-width:900px;
  margin:0 auto 40px;
  padding:16px 16px 40px;
}

.app-title{
  font-size:28px;
  font-weight:800;
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 4px 18px;
  color:#1f2d5f;
}
body.theme-dark .app-title{ color:#f4f6ff; }
.app-title span{ font-size:30px; }

/* ìƒë‹¨ ë„¤ë¹„ */
.nav{
  display:flex;
  gap:10px;
  padding:4px 0 18px;
  overflow-x:auto;
}
.nav button{
  flex:1;
  min-width:0;
  padding:10px 14px;
  border:none;
  border-radius:999px;
  background:rgba(255,255,255,0.7);
  color:#44506b;
  font-size:14px;
  font-weight:600;
  box-shadow:0 4px 12px rgba(77,105,255,0.08);
  white-space:nowrap;
  text-align:center;
}
body.theme-dark .nav button{
  background:rgba(19,29,64,0.9);
  color:#cdd5ff;
}
.nav button.active{
  background:linear-gradient(135deg,#7ea6ff,#4f63ff);
  color:#fff;
}

/* í˜ì´ì§€ */
.page{ display:none; padding-top:4px; }
.page.active{ display:block; }

/* ë¼ë²¨/ì…ë ¥ */
label{
  font-size:13px;
  color:#48536b;
  display:block;
  margin-top:10px;
  margin-bottom:2px;
}
body.theme-dark label{ color:#dde4ff; }

input, select{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #d3dbff;
  background:#ffffffcc;
  font-size:14px;
  outline:none;
}
body.theme-dark input,
body.theme-dark select{
  background:rgba(11,16,40,0.9);
  border-color:#3a4a92;
  color:#f3f5ff;
}
input:focus, select:focus{
  border-color:#6d81ff;
  box-shadow:0 0 0 2px rgba(109,129,255,0.18);
}

/* ë²„íŠ¼ */
button.add{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:10px 18px;
  margin-top:14px;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#7ea6ff,#4f63ff);
  color:#fff;
  font-size:14px;
  font-weight:600;
  box-shadow:0 6px 16px rgba(79,99,255,0.3);
}

button.small{
  border:none;
  border-radius:999px;
  padding:6px 10px;
  font-size:11px;
  font-weight:500;
  background:#e4ebff;
  color:#425085;
  margin-top:4px;
  margin-right:4px;
}
body.theme-dark button.small{
  background:#283867;
  color:#e2e7ff;
}

/* ì¹´ë“œ/ë°•ìŠ¤ */
.table-box{
  width:100%;
  background:#ffffff;
  border-radius:18px;
  padding:10px;
  margin-top:16px;
  box-shadow:0 10px 25px rgba(71,93,255,0.08);
}
body.theme-dark .table-box{
  background:#161f3f;
  box-shadow:0 10px 25px rgba(0,0,0,0.55);
}

/* í‘œ */
table{ width:100%; border-collapse:collapse; }
th, td{
  padding:7px 4px;
  font-size:12px;
  text-align:left;
  border-bottom:1px solid #f0f2ff;
}
th{ color:#4d5780; font-weight:600; }
body.theme-dark th{
  color:#d3dcff;
  border-color:#29335c;
}
body.theme-dark td{ border-color:#29335c; }

/* ì”ëŸ‰ ì¹´ë“œ */
.summary-card{
  background:#ffffff;
  border-radius:18px;
  padding:12px 14px;
  margin-bottom:12px;
  box-shadow:0 10px 25px rgba(71,93,255,0.1);
  font-size:13px;
  color:#2f385a;
}
body.theme-dark .summary-card{
  background:#161f3f;
  color:#e1e7ff;
}
.summary-card b{ font-size:14px; }
.summary-card input{ margin-top:4px; margin-bottom:4px; }

/* ê¸°íƒ€ í…ìŠ¤íŠ¸ */
.info-text{
  font-size:11px;
  color:#7b86aa;
  margin-top:4px;
}
body.theme-dark .info-text{ color:#9fabff; }

.section-title{
  font-size:14px;
  font-weight:600;
  color:#2c355a;
  margin-top:4px;
  margin-bottom:6px;
}
body.theme-dark .section-title{ color:#dde4ff; }

/* ì„¤ì • í˜ì´ì§€ í† ê¸€ */
.settings-row{
  margin-top:12px;
  padding:10px 12px;
  border-radius:14px;
  background:#ffffffcc;
}
body.theme-dark .settings-row{
  background:#151d3b;
}

/* ì ê¸ˆ ì˜¤ë²„ë ˆì´ */
.lock-overlay{
  position:fixed;
  inset:0;
  background:rgba(10,15,35,0.9);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.lock-box{
  background:#f8fbff;
  border-radius:18px;
  padding:20px 18px 16px;
  width:90%;
  max-width:360px;
  text-align:center;
  box-shadow:0 14px 30px rgba(0,0,0,0.4);
}
.lock-box h2{
  margin:0 0 12px;
  font-size:18px;
}
.lock-box p{
  margin:0 0 10px;
  font-size:13px;
  color:#4b5675;
}
.lock-box input{
  margin-top:6px;
}
.lock-error{
  font-size:11px;
  color:#e04848;
  margin-top:6px;
  min-height:14px;
}
</style>
</head>

<body class="theme-blue">
<div id="lockOverlay" class="lock-overlay" style="display:none;">
  <div class="lock-box">
    <h2>Tape Flow ì ê¸ˆ</h2>
    <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
    <input id="lockPasswordInput" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <div class="lock-error" id="lockError"></div>
    <button class="add" style="width:100%; margin-top:10px;" onclick="unlockApp()">í™•ì¸</button>
  </div>
</div>

<div class="app-root">

  <div class="app-title">
    <span>ğŸ“¦</span> TAPE FLOW
  </div>

  <!-- ìˆœì„œ: ì œí’ˆ ì¬ê³  / ì‘ì—… ë“±ë¡ / í…Œì´í”„ ì¬ê³  / í…Œì´í”„ ì„¤ì • / ì„¤ì • -->
  <div class="nav">
    <button id="nav-stock"   class="active">ì œí’ˆ ì¬ê³ </button>
    <button id="nav-work">ì‘ì—… ë“±ë¡</button>
    <button id="nav-summary">í…Œì´í”„ ì¬ê³ </button>
    <button id="nav-tape">í…Œì´í”„ ì„¤ì •</button>
    <button id="nav-settings">ì„¤ì •</button>
  </div>

  <!-- ========== ì œí’ˆ ì¬ê³  í˜ì´ì§€ ========== -->
  <div class="page active" id="page-stock">
    <div class="section-title">ì œí’ˆ ì¬ê³  ë“±ë¡</div>

    <label>ì œí’ˆëª…</label>
    <input id="stockName" placeholder="ì˜ˆ: 7125J">

    <label>ìˆ˜ëŸ‰(EA)</label>
    <input id="stockEa" type="number" placeholder="ì˜ˆ: 2520">

    <label>ë°œì‹  LOT</label>
    <input id="stockLot" placeholder="ì˜ˆ: LOT123">

    <label>ì¸ì‡„ì</label>
    <input id="stockPrinter" placeholder="ì˜ˆ: ê¹€ì£¼í˜„">

    <button class="add" onclick="addStock()">ì¬ê³  ì¶”ê°€</button>

    <div id="stockList" class="table-box"></div>

    <button class="add" style="margin-top:12px;" onclick="downloadStockCsv()">ì œí’ˆ ì¬ê³  CSV ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <!-- ========== ì‘ì—… ë“±ë¡ í˜ì´ì§€ ========== -->
  <div class="page" id="page-work">
    <div class="section-title">ì˜¤ëŠ˜ ì‘ì—… ë“±ë¡</div>

    <label>ì‘ì—… ë‚ ì§œ</label>
    <input id="workDate" type="date">

    <label>ì œí’ˆëª…</label>
    <input id="workName" list="productNames" placeholder="ì œí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.">
    <datalist id="productNames"></datalist>

    <label>ë°œì‹  LOT</label>
    <input id="workLot" list="lotList" placeholder="ë°œì‹  LOTë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.">
    <datalist id="lotList"></datalist>

    <label>ì‚¬ìš© í…Œì´í”„</label>
    <select id="workTape"></select>

    <label>ì‚¬ìš© EA (ì œí’ˆ ìˆ˜ëŸ‰)</label>
    <input id="workEa" type="number" placeholder="ì…ë ¥ ì‹œ í…Œì´í”„ ì¥ìˆ˜ ìë™ ê³„ì‚°">

    <label>í…Œì´í”„ ì¥ìˆ˜ (ì†Œìš”ëŸ‰)</label>
    <input id="workSheets" type="number" placeholder="ì…ë ¥ ì‹œ EA ìë™ ê³„ì‚°">

    <label>ë¶ˆëŸ‰(ì¥)</label>
    <input id="workBad" type="number" value="0">

    <button class="add" onclick="addWork()">ì‘ì—… ë“±ë¡</button>

    <div id="workList" class="table-box"></div>

    <button class="add" style="margin-top:12px;" onclick="downloadWorkCsv()">ì‘ì—… ë‚´ì—­ CSV ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <!-- ========== í…Œì´í”„ ì¬ê³ (ì”ëŸ‰) í˜ì´ì§€ ========== -->
  <div class="page" id="page-summary">
    <div class="section-title">í…Œì´í”„ë³„ í˜„ì¬ê³ </div>
    <div class="info-text">
      â€¢ ì…ê³  ì¥ìˆ˜ = ê°€ê³µì‹¤/íƒœì„±ì—ì„œ ì˜¬ë ¤ì¤€ í…Œì´í”„ ì¥ìˆ˜ ê¸°ë¡<br>
      â€¢ í˜„ì¬ ì”ëŸ‰ = ì…ê³  í•©ê³„ âˆ’ (ì†Œìš” ì¥ìˆ˜ + ë¶ˆëŸ‰ ì¥ìˆ˜)<br>
      â€¢ ì‹¤ì œë‘ ë‹¤ë¥´ë©´ ì”ëŸ‰ ìˆ˜ì •ìœ¼ë¡œ ì§ì ‘ ë§ì¶œ ìˆ˜ ìˆì–´ìš”.
    </div>

    <div id="summaryArea" style="margin-top:10px;"></div>

    <button class="add" style="margin-top:12px;" onclick="downloadTapeCsv()">í…Œì´í”„ ì¬ê³  CSV ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <!-- ========== í…Œì´í”„ ì„¤ì • í˜ì´ì§€ ========== -->
  <div class="page" id="page-tape">
    <div class="section-title">í…Œì´í”„ ê¸°ë³¸ ì •ë³´</div>

    <label>í…Œì´í”„ëª…</label>
    <input id="tapeName" placeholder="ì˜ˆ: 6855, 6491">

    <label>EA(ì œí’ˆ ìˆ˜ëŸ‰) / 1ì¥ë‹¹</label>
    <input id="eaPerSheet" placeholder="ì˜ˆ: 6">

    <label>ì¶œì²˜</label>
    <select id="tapeSource">
      <option value="ê°€ê³µì‹¤">ê°€ê³µì‹¤</option>
      <option value="íƒœì„±">íƒœì„±</option>
    </select>

    <button class="add" onclick="addTape()">í…Œì´í”„ ì¶”ê°€</button>

    <div id="tapeList" class="table-box"></div>
  </div>

  <!-- ========== ì„¤ì • í˜ì´ì§€ ========== -->
  <div class="page" id="page-settings">
    <div class="section-title">ì•± ì„¤ì •</div>

    <div class="settings-row">
      <b style="font-size:13px;">ì ê¸ˆ ë¹„ë°€ë²ˆí˜¸</b>
      <div class="info-text">
        ì•±ì„ ì—´ ë•Œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìš”êµ¬í•©ë‹ˆë‹¤. (ì´ ê¸°ê¸°/ë¸Œë¼ìš°ì € ê¸°ì¤€)
      </div>
      <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
      <input id="settingsPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
      <button class="add" style="margin-top:10px;" onclick="savePassword()">ë¹„ë°€ë²ˆí˜¸ ì €ì¥</button>
      <button class="small" style="margin-top:8px;" onclick="clearPassword()">ë¹„ë°€ë²ˆí˜¸ í•´ì œ</button>
    </div>

    <div class="settings-row">
      <b style="font-size:13px;">í…Œë§ˆ</b>
      <div class="info-text">ì›í•˜ëŠ” í™”ë©´ ìŠ¤íƒ€ì¼ì„ ì„ íƒí•˜ì„¸ìš”.</div>
      <label>í…Œë§ˆ ì„ íƒ</label>
      <select id="themeSelect" onchange="changeTheme(this.value)">
        <option value="blue">íŒŒìŠ¤í…” ë¸”ë£¨</option>
        <option value="dark">ë‹¤í¬ ë„¤ì´ë¹„</option>
      </select>
    </div>
  </div>

</div>

<script>
/* ===== ë°ì´í„° ===== */
let tapes = JSON.parse(localStorage.getItem("tapes") || "[]");
let stocks = JSON.parse(localStorage.getItem("stocks") || "[]");
let works = JSON.parse(localStorage.getItem("works") || "[]");
let tapeInbound = JSON.parse(localStorage.getItem("tapeInbound") || "[]");
let appPassword = localStorage.getItem("tapeFlowPassword") || "";
let appTheme = localStorage.getItem("tapeFlowTheme") || "blue";

function save(){
  localStorage.setItem("tapes", JSON.stringify(tapes));
  localStorage.setItem("stocks", JSON.stringify(stocks));
  localStorage.setItem("works", JSON.stringify(works));
  localStorage.setItem("tapeInbound", JSON.stringify(tapeInbound));
}

/* ===== í…Œë§ˆ ì ìš© ===== */
function applyTheme(){
  document.body.classList.remove("theme-blue","theme-dark");
  if(appTheme === "dark"){
    document.body.classList.add("theme-dark");
    document.getElementById("themeSelect").value = "dark";
  }else{
    document.body.classList.add("theme-blue");
    document.getElementById("themeSelect").value = "blue";
  }
}
function changeTheme(val){
  appTheme = (val === "dark") ? "dark" : "blue";
  localStorage.setItem("tapeFlowTheme", appTheme);
  applyTheme();
}

/* ===== í˜ì´ì§€ ì „í™˜ ===== */
function openPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.getElementById("page-"+id).classList.add("active");

  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
  document.getElementById("nav-"+id).classList.add("active");

  if(id==="summary") renderSummary();
  if(id==="work") refreshWorkTapeList();
}

document.getElementById("nav-stock").addEventListener("click",()=>openPage("stock"));
document.getElementById("nav-work").addEventListener("click",()=>openPage("work"));
document.getElementById("nav-summary").addEventListener("click",()=>openPage("summary"));
document.getElementById("nav-tape").addEventListener("click",()=>openPage("tape"));
document.getElementById("nav-settings").addEventListener("click",()=>openPage("settings"));

/* ===== í…Œì´í”„ ì„¤ì • ===== */
function addTape(){
  let name = tapeName.value.trim();
  let ea = Number(eaPerSheet.value);
  let src = tapeSource.value;

  if(!name || !ea){
    alert("í…Œì´í”„ëª…ê³¼ EA/ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }
  tapes.push({name, ea, src, manualRemain:null});
  save();
  renderTapeList();
  refreshWorkTapeList();
  tapeName.value="";
  eaPerSheet.value="";
}

function renderTapeList(){
  if(tapes.length===0){
    tapeList.innerHTML = "<div class='info-text'>ë“±ë¡ëœ í…Œì´í”„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    return;
  }
  let html = `<table><tr><th>í…Œì´í”„</th><th>EA/ì¥</th><th>ì¶œì²˜</th></tr>`;
  tapes.forEach(t=>{
    html += `<tr><td>${t.name}</td><td>${t.ea}</td><td>${t.src}</td></tr>`;
  });
  html += `</table>`;
  tapeList.innerHTML = html;
}
renderTapeList();

function refreshWorkTapeList(){
  if(tapes.length===0){
    workTape.innerHTML = "<option value=''>í…Œì´í”„ ì—†ìŒ</option>";
    return;
  }
  workTape.innerHTML = tapes.map(t=>`<option value="${t.name}">${t.name}</option>`).join("");
}

/* ===== ì œí’ˆ ì¬ê³  ===== */
function addStock(){
  let name = stockName.value.trim();
  let ea = Number(stockEa.value);
  let lot = stockLot.value.trim();
  let printer = stockPrinter.value.trim();
  let date = new Date().toISOString().slice(0,10);

  if(!name || !ea || !lot){
    alert("ì œí’ˆëª…, ìˆ˜ëŸ‰(EA), ë°œì‹  LOTë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }
  stocks.push({name, ea, lot, printer, date});
  save();
  renderStockList();
  refreshAutocomplete();
  stockName.value="";
  stockEa.value="";
  stockLot.value="";
  stockPrinter.value="";
}

function renderStockList(){
  if(stocks.length===0){
    stockList.innerHTML = "<div class='info-text'>ë“±ë¡ëœ ì œí’ˆ ì¬ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    return;
  }
  let html = `<table><tr><th>ë‚ ì§œ</th><th>ì œí’ˆëª…</th><th>EA</th><th>ë°œì‹  LOT</th><th>ì¸ì‡„ì</th></tr>`;
  stocks.forEach(s=>{
    html+=`<tr>
      <td>${s.date||""}</td>
      <td>${s.name}</td>
      <td>${s.ea}</td>
      <td>${s.lot}</td>
      <td>${s.printer||""}</td>
    </tr>`;
  });
  html+=`</table>`;
  stockList.innerHTML = html;
}
renderStockList();

/* ìë™ì™„ì„±ìš© datalist */
function refreshAutocomplete(){
  const nameSet = new Set();
  const lotSet = new Set();
  stocks.forEach(s=>{
    if(s.name) nameSet.add(s.name);
    if(s.lot) lotSet.add(s.lot);
  });

  productNames.innerHTML = Array.from(nameSet).map(n=>`<option value="${n}"></option>`).join("");
  lotList.innerHTML = Array.from(lotSet).map(l=>`<option value="${l}"></option>`).join("");
}
refreshAutocomplete();

/* ===== ì‘ì—… ë“±ë¡ ===== */
function addWork(){
  let name = workName.value.trim();
  let lot = workLot.value.trim();
  let tape = workTape.value;
  let ea = Number(workEa.value);
  let sheet = Number(workSheets.value);
  let bad = Number(workBad.value || 0);
  let date = workDate.value || new Date().toISOString().slice(0,10);

  if(!name || !tape){
    alert("ì œí’ˆëª…ê³¼ í…Œì´í”„ë¥¼ ì…ë ¥/ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  let tapeObj = tapes.find(t=>t.name===tape);
  if(!tapeObj){
    alert("í…Œì´í”„ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  if(ea && !sheet){
    sheet = Math.ceil(ea / tapeObj.ea);
  }else if(sheet && !ea){
    ea = sheet * tapeObj.ea;
  }
  if(!ea || !sheet){
    alert("EA ë˜ëŠ” í…Œì´í”„ ì¥ìˆ˜ ì¤‘ í•˜ë‚˜ëŠ” ë°˜ë“œì‹œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
    return;
  }

  works.push({name, lot, tape, ea, sheet, bad, date});
  save();

  // ì œí’ˆ ì¬ê³ ì—ì„œ ì°¨ê°/ì‚­ì œ
  if(name){
    // LOTê¹Œì§€ ì¼ì¹˜í•˜ëŠ”ê²Œ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
    let idx = stocks.findIndex(s=>s.name===name && lot && s.lot===lot);
    if(idx === -1){
      // LOT ì—†ì´ ì´ë¦„ë§Œ ì¼ì¹˜í•˜ëŠ” ì²« ì„¸íŠ¸
      idx = stocks.findIndex(s=>s.name===name);
    }
    if(idx !== -1){
      let st = stocks[idx];
      if(!isNaN(st.ea)){
        if(ea >= st.ea){
          // ì„¸íŠ¸ ì „ëŸ‰ ì‚¬ìš© -> ì‚­ì œ
          stocks.splice(idx,1);
        }else{
          // ì¼ë¶€ë§Œ ì‚¬ìš© -> EA ì°¨ê°
          st.ea = st.ea - ea;
        }
        save();
        renderStockList();
        refreshAutocomplete();
      }
    }
  }

  renderWorkList();
  renderSummary();

  workName.value="";
  workLot.value="";
  workEa.value="";
  workSheets.value="";
  workBad.value="0";
}

function renderWorkList(){
  if(works.length===0){
    workList.innerHTML = "<div class='info-text'>ë“±ë¡ëœ ì‘ì—… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
    return;
  }
  let html = `<table><tr><th>ë‚ ì§œ</th><th>ì œí’ˆëª…</th><th>ë°œì‹  LOT</th><th>í…Œì´í”„</th><th>EA</th><th>ì†Œìš”ì¥ìˆ˜</th><th>ë¶ˆëŸ‰ì¥ìˆ˜</th></tr>`;
  works.forEach(w=>{
    html+=`<tr>
      <td>${w.date || ""}</td>
      <td>${w.name}</td>
      <td>${w.lot || ""}</td>
      <td>${w.tape}</td>
      <td>${w.ea}</td>
      <td>${w.sheet}</td>
      <td>${w.bad}</td>
    </tr>`;
  });
  html+=`</table>`;
  workList.innerHTML = html;
}
renderWorkList();

/* ===== í…Œì´í”„ ì¬ê³  / ì”ëŸ‰ ===== */
function renderSummary(){
  if(tapes.length===0){
    summaryArea.innerHTML = "<div class='info-text'>ë¨¼ì € í…Œì´í”„ë¥¼ ë“±ë¡í•´ ì£¼ì„¸ìš”.</div>";
    return;
  }
  let area = "";
  tapes.forEach((t,idx)=>{
    let inbound = 0;
    tapeInbound.forEach(e=>{
      if(e.tape === t.name) inbound += Number(e.sheets)||0;
    });

    let used = 0;
    let bad = 0;
    works.forEach(w=>{
      if(w.tape === t.name){
        used += Number(w.sheet)||0;
        bad  += Number(w.bad)||0;
      }
    });

    let autoRemain = inbound - used - bad;
    let manual = (typeof t.manualRemain === "number" && !Number.isNaN(t.manualRemain));
    let remain = manual ? t.manualRemain : autoRemain;

    area += `
      <div class="summary-card">
        <b>${t.name}</b> <span style="font-size:12px;color:#7b86aa;">(${t.src})</span><br>
        â€¢ ì…ê³  í•©ê³„: <b>${inbound}</b> ì¥<br>
        â€¢ ì‚¬ìš©(ì†Œìš”+ë¶ˆëŸ‰): <b>${used+bad}</b> ì¥ (ì†Œìš” ${used}, ë¶ˆëŸ‰ ${bad})<br>
        â€¢ í˜„ì¬ ì”ëŸ‰: <b>${remain}</b> ì¥ ${manual ? "<span style='color:#e05;'>[ìˆ˜ë™]</span>" : "<span style='color:#3aa36d;'>[ìë™]</span>"}<br><br>

        <div style="margin-bottom:6px;">
          <div style="font-size:12px;margin-bottom:2px;">ì…ê³  ì¥ìˆ˜ ì¶”ê°€</div>
          <input id="in_${idx}" type="number" placeholder="ì˜ˆ: 120">
          <button class="small" onclick="addInbound(${idx})">ì…ê³  ì¶”ê°€</button>
        </div>

        <div>
          <div style="font-size:12px;margin-bottom:2px;">ì”ëŸ‰ ì§ì ‘ ìˆ˜ì •</div>
          <input id="set_${idx}" type="number" placeholder="í˜„ì¬ ì‹¤ì œ ì”ëŸ‰ ì…ë ¥">
          <button class="small" onclick="setRemain(${idx})">ì”ëŸ‰ ìˆ˜ì •</button>
          ${manual ? `<button class="small" onclick="clearRemain(${idx})">ìë™ê³„ì‚° ë˜ëŒë¦¬ê¸°</button>` : ""}
        </div>
      </div>
    `;
  });
  summaryArea.innerHTML = area;
}
renderSummary();

function addInbound(idx){
  let input = document.getElementById("in_"+idx);
  if(!input) return;
  let val = Number(input.value);
  if(!val){
    alert("ì…ê³  ì¥ìˆ˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
    return;
  }
  let date = new Date().toISOString().slice(0,10);
  tapeInbound.push({tape: tapes[idx].name, sheets:val, date});
  save();
  input.value = "";
  renderSummary();
}

function setRemain(idx){
  let input = document.getElementById("set_"+idx);
  if(!input) return;
  let val = input.value;
  if(val === ""){
    alert("ì”ëŸ‰ ìˆ«ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
    return;
  }
  tapes[idx].manualRemain = Number(val);
  save();
  renderSummary();
}

function clearRemain(idx){
  tapes[idx].manualRemain = null;
  save();
  renderSummary();
}

/* ===== CSV ê³µí†µ ===== */
function downloadCsv(filename, rows){
  if(!rows || rows.length===0){
    alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  const csv = rows.map(r =>
    r.map(v => {
      let s = String(v ?? "");
      s = s.replace(/"/g,'""');
      return `"${s}"`;
    }).join(",")
  ).join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

function downloadStockCsv(){
  const rows = [["ë‚ ì§œ","ì œí’ˆëª…","EA","ë°œì‹  LOT","ì¸ì‡„ì"]];
  stocks.forEach(s=>{
    rows.push([s.date||"", s.name, s.ea, s.lot, s.printer||""]);
  });
  downloadCsv("product_stocks.csv", rows);
}

function downloadWorkCsv(){
  const rows = [["ë‚ ì§œ","ì œí’ˆëª…","ë°œì‹  LOT","í…Œì´í”„","EA","ì†Œìš”ì¥ìˆ˜","ë¶ˆëŸ‰ì¥ìˆ˜"]];
  works.forEach(w=>{
    rows.push([w.date||"", w.name, w.lot||"", w.tape, w.ea, w.sheet, w.bad]);
  });
  downloadCsv("work_logs.csv", rows);
}

function downloadTapeCsv(){
  const rows = [["í…Œì´í”„","ì¶œì²˜","ì…ê³  í•©ê³„","ì†Œìš” ì¥ìˆ˜","ë¶ˆëŸ‰ ì¥ìˆ˜","í˜„ì¬ ì”ëŸ‰","ì”ëŸ‰ëª¨ë“œ"]];
  tapes.forEach(t=>{
    let inbound = 0, used=0, bad=0;
    tapeInbound.forEach(e=>{ if(e.tape===t.name) inbound += Number(e.sheets)||0; });
    works.forEach(w=>{
      if(w.tape===t.name){
        used += Number(w.sheet)||0;
        bad  += Number(w.bad)||0;
      }
    });
    let autoRemain = inbound - used - bad;
    let manual = (typeof t.manualRemain === "number" && !Number.isNaN(t.manualRemain));
    let remain = manual ? t.manualRemain : autoRemain;

    rows.push([t.name, t.src, inbound, used, bad, remain, manual ? "ìˆ˜ë™" : "ìë™"]);
  });
  downloadCsv("tape_stocks.csv", rows);
}

/* ===== ì ê¸ˆ ë¹„ë°€ë²ˆí˜¸ ===== */
function savePassword(){
  const pw = settingsPassword.value;
  if(!pw){
    alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }
  appPassword = pw;
  localStorage.setItem("tapeFlowPassword", appPassword);
  alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒì— ì•±ì„ ì—´ ë•Œë¶€í„° ì ìš©ë©ë‹ˆë‹¤.");
  settingsPassword.value = "";
}

function clearPassword(){
  appPassword = "";
  localStorage.removeItem("tapeFlowPassword");
  alert("ë¹„ë°€ë²ˆí˜¸ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
}

/* ì ê¸ˆ í™”ë©´ ë¡œì§ */
function checkLock(){
  if(!appPassword){
    lockOverlay.style.display = "none";
    return;
  }
  // í•œ ì„¸ì…˜ ë™ì•ˆë§Œ ê¸°ì–µ
  if(sessionStorage.getItem("tapeFlowAuthed") === "1"){
    lockOverlay.style.display = "none";
    return;
  }
  lockOverlay.style.display = "flex";
}

function unlockApp(){
  const input = lockPasswordInput.value;
  if(input === appPassword){
    sessionStorage.setItem("tapeFlowAuthed","1");
    lockOverlay.style.display = "none";
    lockError.textContent = "";
    lockPasswordInput.value = "";
  }else{
    lockError.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
  }
}

/* ===== ì´ˆê¸°í™” ===== */
(function init(){
  // ë‚ ì§œ ê¸°ë³¸ê°’
  const today = new Date().toISOString().slice(0,10);
  const dateInput = document.getElementById("workDate");
  if(dateInput && !dateInput.value) dateInput.value = today;

  // í…Œë§ˆ
  applyTheme();

  // ì ê¸ˆ ì²´í¬
  checkLock();

  // í…Œì´í”„ ì„ íƒ ë¦¬ìŠ¤íŠ¸
  refreshWorkTapeList();
})();
</script>

</body>
</html>
